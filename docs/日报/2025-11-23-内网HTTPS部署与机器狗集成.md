# 工作日报 - 2025年11月23日

## 一、工作背景

为保障周一内网环境演示顺利进行，需解决以下问题：
1. 外网带宽受限，演示需在内网环境进行
2. 内网HTTP环境下，浏览器安全策略限制导致语音对话功能无法使用
3. 鼎桥机器狗AI对话功能需集成到应急大脑系统

---

## 二、问题分析

### 2.1 为什么内网HTTP无法使用语音功能？

现代浏览器出于安全考虑，对敏感功能实施了**安全上下文（Secure Context）**限制：

| 受限功能 | 安全要求 |
|----------|----------|
| 麦克风访问 | 仅HTTPS或localhost可用 |
| 摄像头访问 | 仅HTTPS或localhost可用 |
| WebRTC实时通信 | 仅HTTPS或localhost可用 |

**结论**：内网环境必须部署HTTPS服务，否则语音对话功能无法正常使用。

### 2.2 内网部署HTTPS的挑战

| 挑战 | 说明 |
|------|------|
| 无公网域名 | 内网环境无法申请公共CA证书 |
| 证书信任 | 自签名证书需要客户端手动信任 |
| 域名解析 | 需要将域名解析到内网服务器IP |
| 多服务统一入口 | 前端、后端API、视频流、图片服务等需统一HTTPS入口 |

---

## 三、解决方案

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端浏览器                            │
│                  (导入自签名根证书)                          │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTPS
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    Nginx 反向代理                            │
│              (SSL终结 + 路由分发)                            │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTP (内部转发)
        ┌─────────────┼─────────────┬─────────────┐
        ▼             ▼             ▼             ▼
   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
   │ 前端服务 │  │ 后端API │  │ 视频流  │  │ 图片服务 │
   └─────────┘  └─────────┘  └─────────┘  └─────────┘
```

### 3.2 实施步骤

#### Step 1: 生成自签名SSL证书

使用OpenSSL生成自签名CA根证书和服务器证书，证书同时包含域名和IP地址，支持多种访问方式。

#### Step 2: 配置Nginx反向代理

配置Nginx作为统一入口：
- 接收HTTPS请求，完成SSL终结
- 根据URL路径分发到不同的后端服务（前端、API、视频流、图片等）
- 配置WebSocket代理支持语音对话的实时通信

#### Step 3: 域名解析配置

**遇到的问题**：内网存在2台路由器串联，其中上级路由器无法获取管理权限，无法在路由器层面统一配置DNS。

**方案对比**：

| 方案 | 优点 | 缺点 | 可行性 |
|------|------|------|--------|
| 路由器DNS配置 | 全局生效，一次配置 | 需要路由器管理权限 | ❌ 不可行 |
| 修改hosts文件 | 简单直接 | 需要每台客户端配置 | ✅ 可行 |
| 部署内网DNS服务器 | 集中管理 | 需要额外服务器资源 | ✅ 备选 |
| 直接使用IP访问 | 无需DNS配置 | 证书需包含IP | ✅ 可行 |

**最终方案**：采用**修改客户端hosts文件** + **证书包含IP**双重方案，确保灵活性。

#### Step 4: 客户端证书信任配置

在演示用的客户端电脑上导入自签名CA根证书，使浏览器信任该证书，避免安全警告。

---

## 四、鼎桥机器狗AI对话集成

### 4.1 集成目标

将鼎桥机器狗的AI对话能力接入应急大脑系统，实现统一的智能交互入口。

### 4.2 实现内容

1. **语音采集**：前端通过麦克风采集用户语音
2. **对话路由**：应急大脑后端接收语音，转发至机器狗AI服务
3. **响应处理**：接收AI响应，通过WebSocket实时推送至前端
4. **状态同步**：机器狗执行状态实时反馈到系统界面

---

## 五、遇到的问题与解决

### 5.1 路由器DNS配置受限

| 问题 | 解决方案 |
|------|----------|
| 上级路由器无管理权限，无法配置DNS | 改用客户端hosts文件配置 + 证书包含IP地址支持直接IP访问 |

### 5.2 WebSocket Mixed Content错误

| 问题 | 解决方案 |
|------|----------|
| HTTPS页面无法连接HTTP的WebSocket | Nginx统一代理WebSocket，自动升级为wss协议 |

### 5.3 视频流代理延迟

| 问题 | 解决方案 |
|------|----------|
| 视频流经过Nginx后延迟明显 | 禁用Nginx代理缓冲，实现流式透传 |

---

## 六、验证结果

| 验证项 | 结果 |
|--------|------|
| HTTPS访问 | ✅ 正常，证书受信任 |
| 语音对话功能 | ✅ 麦克风权限正常获取 |
| 视频流播放 | ✅ 播放流畅 |
| 机器狗AI对话 | ✅ 指令下发正常 |
| WebSocket连接 | ✅ 实时通信正常 |

---

## 七、产出物

- SSL证书套件（CA根证书 + 服务器证书）
- Nginx反向代理配置
- 客户端环境配置说明
- 机器狗AI对话接口适配模块

---

*报告人：马圣权*
*日期：2025年11月23日*
