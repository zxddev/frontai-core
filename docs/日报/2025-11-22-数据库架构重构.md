# 工作日报 - 2025年11月22日

## 一、工作概述

完成应急指挥系统数据库架构的全面重构，建立 `operational_v2` schema，实现与旧版本的完全隔离，为系统升级提供平滑过渡方案。

---

## 二、详细工作内容

### 2.1 枚举类型设计与实现 (16个)

为保证数据一致性和类型安全，设计并实现了16个PostgreSQL枚举类型：

| 序号 | 枚举名称 | 枚举值 | 业务用途 |
|------|----------|--------|----------|
| 1 | `device_type_v2` | drone, dog, ship, robot | 智能设备分类：无人机、机器狗、无人艇、机器人 |
| 2 | `equipment_category_v2` | search_detect, rescue_tool, medical, protection, communication, lighting, power, transport, hazmat, water_rescue, rope_rescue, other | 装备分类：搜索探测、救援工具、医疗、防护、通信、照明、电力、运输、危化品、水域救援、绳索救援等12大类 |
| 3 | `equipment_priority_enum` | required, recommended, optional | 装备优先级：必需、推荐、可选 |
| 4 | `equipment_type_enum` | device, supply | 装备类型：设备类、物资类 |
| 5 | `ground_stability_v2` | excellent, good, moderate, poor, unknown | 地面稳定性评级：优秀、良好、中等、差、未知 |
| 6 | `module_type_v2` | sensor, communication, utility, power | 功能模块类型：传感器、通信、工具、电源 |
| 7 | `road_type_v2` | motorway, motorway_link, trunk, trunk_link, primary, primary_link, secondary, secondary_link, tertiary, tertiary_link, residential, living_street, service, unclassified, track, path, footway, cycleway, bridleway, steps | 道路类型：高速公路、国道、省道、县道、乡道、居民区道路、服务道路、小径、步道等20种，兼容OSM标准 |
| 8 | `seat_role_v2` | commander, coordinator, scout, operator, driver | 席位角色：指挥员、协调员、侦察员、操作员、驾驶员 |
| 9 | `staging_site_type_v2` | open_ground, parking_lot, sports_field, school_yard, factory_yard, plaza, helipad, logistics_center, other | 驻扎点类型：空地、停车场、体育场、学校操场、工厂院落、广场、直升机坪、物流中心等9种 |
| 10 | `surface_type_v2` | paved, asphalt, concrete, cobblestone, gravel, unpaved, dirt, sand, grass, mud, unknown | 路面类型：铺装、沥青、混凝土、鹅卵石、碎石、未铺装、泥土、沙地、草地、泥泞等11种 |
| 11 | `task_priority_v2` | critical, high, medium, low | 任务优先级：紧急、高、中、低 |
| 12 | `task_status_v2` | pending, planning, assigned, dispatched, en_route, on_site, in_progress, completed, failed, cancelled | 任务状态：待处理、规划中、已分配、已派遣、途中、到达现场、执行中、已完成、失败、取消，共10种状态 |
| 13 | `team_type_v2` | fire_rescue, medical, search_rescue, hazmat, engineering, communication, logistics, evacuation, water_rescue, mountain_rescue, mine_rescue, armed_police, militia, volunteer | 队伍类型：消防救援、医疗、搜救、危化品处置、工程、通信、后勤、疏散、水域救援、山地救援、矿山救援、武警、民兵、志愿者等14种 |
| 14 | `terrain_type_v2` | urban, suburban, rural, mountain, forest, grassland, water_adjacent, desert, wetland, unknown | 地形类型：城市、城郊、农村、山地、森林、草原、临水、沙漠、湿地、未知等10种 |
| 15 | `user_type_v2` | internal, external_team, external_expert, external_volunteer, system | 用户类型：内部用户、外部队伍、外部专家、外部志愿者、系统用户 |
| 16 | `vehicle_type_v2` | reconnaissance, drone_transport, ship_transport, medical, logistics, command | 车辆类型：侦察车、无人机运输车、无人艇运输车、医疗车、后勤车、指挥车 |

### 2.2 业务表设计与实现 (38个)

#### 2.2.1 AI决策模块 (1表)

**ai_decision_logs_v2** - AI决策日志表
- 功能：记录所有AI决策过程，实现决策可追溯、可解释
- 核心字段：
  - `scenario_id` - 关联想定
  - `event_id` - 关联事件
  - `decision_type` - 决策类型（event_analysis, emergency_ai_analysis等）
  - `algorithm_used` - 使用的算法（LLM+RAG+KG+Rules等）
  - `input_snapshot` - 输入快照(JSONB)
  - `output_result` - 输出结果(JSONB)
  - `confidence_score` - 置信度评分
  - `reasoning_chain` - 推理链(JSONB)
  - `processing_time_ms` - 处理耗时
  - `human_feedback` - 人工反馈

#### 2.2.2 能力体系模块 (4表)

**capability_codes_v2** - 能力编码字典
- 功能：定义所有标准化的能力类型编码
- 设计思路：建立统一的能力标识体系，支持能力匹配算法

**capability_equipment_v2** - 能力装备映射表
- 功能：定义每种能力所需的装备配置
- 关键关系：能力编码 → 装备列表

**capability_requirements_v2** - 能力需求映射表
- 功能：定义灾害类型与所需能力的映射关系
- 设计思路：根据灾害类型自动推导所需能力

**team_capabilities_v2** - 队伍能力表
- 功能：描述各救援队伍具备的专业能力
- 核心字段：队伍ID、能力编码、能力等级、认证信息

#### 2.2.3 装备设备模块 (7表)

**equipment_v2** - 装备主表
- 功能：定义可携带/消耗的装备
- 核心字段：装备编码、名称、类别、规格参数、重量、体积

**equipment_capabilities_v2** - 装备能力表
- 功能：描述装备具备的专业能力及性能参数
- 设计思路：装备与能力多对多映射

**devices_v2** - 设备表
- 功能：管理无人机、机器狗、无人艇等智能设备
- 核心字段：设备类型、型号、续航能力、通信参数、载重能力

**modules_v2** - 功能模块表
- 功能：定义设备可携带的功能模块
- 模块类型：传感器、通信模块、工具模块、电源模块

**device_module_mounts_v2** - 设备模块安装关系表
- 功能：记录设备与模块的安装关系
- 支持：模块热插拔、兼容性检查

**disaster_equipment_rules_v2** - 灾害装备配置规则表
- 功能：定义不同灾害类型/等级需要的装备配置
- 设计思路：规则化的装备推荐系统

**team_equipment_v2** - 队伍装备关联表
- 功能：记录队伍拥有的装备清单
- 支持：装备数量、状态跟踪

#### 2.2.4 救援队伍模块 (4表)

**rescue_teams_v2** - 救援队伍主表
- 功能：存储各类救援队伍基本信息
- 核心字段：队伍类型、所属组织、驻地位置(PostGIS)、人员规模、响应能力等级

**team_members_v2** - 队员表
- 功能：存储救援队伍成员详细信息
- 核心字段：姓名、职务、技能认证、联系方式、健康状态

**team_vehicles_v2** - 队伍车辆关联表
- 功能：记录队伍拥有的车辆资源
- 支持：车辆分配、调度跟踪

**external_team_authorizations_v2** - 外部队伍授权表
- 功能：定义外部救援队伍在想定中的操作权限
- 设计思路：支持跨区域协作、临时授权

#### 2.2.5 车辆物资模块 (4表)

**vehicles_v2** - 车辆表
- 功能：管理救援车辆及其载物能力
- 核心字段：车辆类型、载重能力、载客能力、油耗、当前位置(PostGIS)

**vehicle_device_loads_v2** - 车辆装载设备关系表
- 功能：记录车辆当前装载的设备
- 支持：装载量计算、设备追踪

**vehicle_supply_loads_v2** - 车辆装载物资关系表
- 功能：记录车辆当前装载的物资
- 支持：物资消耗跟踪、补给计划

**supplies_v2** - 物资表
- 功能：管理救援物资库存
- 核心字段：物资类型、名称、单位、保质期、存储条件

#### 2.2.6 路网规划模块 (4表)

**road_nodes_v2** - 路网节点表
- 功能：存储道路交叉点、端点
- 核心字段：节点坐标(PostGIS Point)、节点类型、高程
- 数据量：约45万+节点（茂县地区）

**road_edges_v2** - 路网边表
- 功能：存储道路段，支持A*路径规划
- 核心字段：
  - `source_node` / `target_node` - 起止节点
  - `road_type` - 道路类型(枚举)
  - `surface_type` - 路面类型(枚举)
  - `length_m` - 长度(米)
  - `geometry` - 几何形状(PostGIS LineString)
  - `max_speed_kmh` - 限速
  - `is_oneway` - 单行道标记
  - `is_blocked` - 阻断标记
- 数据量：约65万+道路段

**road_type_defaults_v2** - 道路类型默认参数表
- 功能：定义各道路类型的默认通行参数
- 用途：A*算法代价计算、通行能力评估

**planned_routes_v2** - 规划路径表
- 功能：存储A*算法规划的路径结果
- 核心字段：起止点、途经节点序列、总距离、预计耗时、路况评估

#### 2.2.7 任务调度模块 (3表)

**tasks_v2** - 任务表
- 功能：存储从救援方案分解出的具体可执行任务
- 核心字段：
  - `task_type` - 任务类型
  - `priority` - 优先级(枚举)
  - `status` - 状态(枚举，10种状态)
  - `assigned_team_id` - 分配队伍
  - `target_location` - 目标位置(PostGIS)
  - `deadline` - 截止时间
  - `dependencies` - 前置依赖(JSONB)

**task_requirements_v2** - 任务需求表
- 功能：定义任务的详细需求
- 核心字段：所需能力、所需装备、人员需求、时间约束

**resource_dispatches_v2** - 资源调度记录表
- 功能：记录救援资源的调度历史
- 支持：调度追溯、资源占用分析、调度优化

#### 2.2.8 灾害场景模块 (4表)

**scenarios_v2** - 想定表
- 功能：应急事件的顶层容器
- 示例："四川茂县6.5级地震想定"
- 核心字段：想定名称、灾害类型、影响范围、启动时间、状态

**disaster_affected_areas_v2** - 灾害影响区域表
- 功能：定义危险区、封锁区、警戒区等
- 核心字段：区域类型、几何范围(PostGIS Polygon)、风险等级

**disaster_situations** - 灾情态势表
- 功能：记录灾情动态变化
- 支持：态势感知、趋势分析

**rescue_staging_sites_v2** - 救援队驻扎点表
- 功能：存储前沿驻扎点候选位置及属性
- 核心字段：
  - `site_type` - 场地类型(枚举)
  - `terrain_type` - 地形类型(枚举)
  - `ground_stability` - 地面稳定性(枚举)
  - `area_sqm` - 面积
  - `capacity_teams` - 可容纳队伍数
  - `has_water/power/communication` - 基础设施
- 用途：驻扎点选址算法

#### 2.2.9 组织权限模块 (8表)

**organizations_v2** - 组织机构表
- 功能：支持多级组织架构
- 设计：树形结构，parent_id自关联

**users_v2** - 用户表
- 功能：存储系统用户信息
- 核心字段：用户类型(枚举)、所属组织、认证信息

**roles_v2** - 角色表
- 功能：定义系统角色
- 示例：系统管理员、想定管理员、指挥员、操作员

**permissions_v2** - 权限表
- 功能：定义系统权限点
- 设计：资源+动作模式

**user_roles_v2** - 用户角色关联表
- 功能：多对多关联

**role_permissions_v2** - 角色权限关联表
- 功能：多对多关联

**seat_assignments_v2** - 席位分配表
- 功能：想定中的席位人员分配
- 支持：动态席位调整

**operation_logs_v2** - 操作日志表
- 功能：记录用户操作审计
- 核心字段：操作人、操作类型、操作对象、操作时间、IP地址

**warning_records** - 预警记录表
- 功能：记录系统预警信息

---

## 三、技术方案与设计思路

### 3.1 版本隔离策略
- 采用独立schema `operational_v2`
- 所有表名使用 `_v2` 后缀
- 支持新旧版本并行运行，平滑迁移

### 3.2 空间数据支持
- 集成PostGIS扩展
- 位置字段统一使用 `geometry(Point, 4326)`
- 区域字段使用 `geometry(Polygon, 4326)`
- 路径字段使用 `geometry(LineString, 4326)`

### 3.3 能力匹配架构
```
灾害类型 → capability_requirements_v2 → 所需能力列表
                                            ↓
队伍 → team_capabilities_v2 → 队伍能力 → 能力匹配
                                            ↓
能力 → capability_equipment_v2 → 所需装备 → 装备调度
```

### 3.4 路网规划架构
```
road_nodes_v2 (节点) + road_edges_v2 (边) → A*算法 → planned_routes_v2
                              ↑
              road_type_defaults_v2 (代价参数)
```

### 3.5 数据完整性保证
- 外键约束确保引用完整性
- 枚举类型确保值域约束
- CHECK约束确保业务规则
- 触发器维护审计字段

---

## 四、产出物

| 文件 | 大小 | 说明 |
|------|------|------|
| `/sql/完整sql/operational_v2.sql` | ~700MB | 完整DDL + 初始数据 |

---

## 五、后续计划

1. 编写数据迁移脚本，从v1迁移到v2
2. 更新ORM模型与数据库表结构对齐
3. 编写单元测试验证数据完整性
4. 性能测试与索引优化

---

## 六、遇到的问题与解决

1. **路网数据量大** - 茂县地区路网数据超过100万条记录，通过批量导入和索引优化解决
2. **枚举类型设计** - 参考OSM标准和应急管理规范，确保枚举值覆盖全面且具有扩展性

---

*报告人：马圣权*
*日期：2025年11月22日*
