# 资源管理接口设计

> 版本: 2.0  
> 创建时间: 2025-11-25  
> 优先级: P1

---

## 一、模块概述

资源管理涵盖救援队伍、设备（无人机/机器人）、车辆、物资装备、安置点的管理和调度。

**资源分类：**
| 类型 | 说明 | 接口数 |
|------|------|--------|
| 队伍 (teams) | 救援队伍 | 9 |
| 设备 (devices) | 无人机/机器人 | 10 |
| 车辆 (vehicles) | 运输/指挥车辆 | 8 |
| 物资 (supplies) | 装备物资 | 4 |
| 安置点 (shelters) | 避难/安置场所 | 5 |

**四层装载模型：**
```
Vehicle (车辆)
  └── Team (队伍)
        ├── Personnel (人员)
        └── Device (设备：无人机/机器人)
```

---

## 二、数据库表

### 2.1 队伍表: teams_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定ID (可为空，表示通用资源) |
| team_code | VARCHAR(50) | 队伍编号 |
| name | VARCHAR(200) | 队伍名称 |
| team_type | VARCHAR(50) | 类型 |
| status | VARCHAR(20) | available/deployed/unavailable |
| capabilities | VARCHAR(50)[] | 能力标签 |
| personnel_count | INT | 人员数量 |
| max_personnel | INT | 最大人员数 |
| current_location | GEOGRAPHY(POINT) | 当前位置 |
| base_location | GEOGRAPHY(POINT) | 驻地位置 |
| loaded_on_vehicle_id | UUID | 装载车辆ID |
| contact_person | VARCHAR(100) | 联系人 |
| contact_phone | VARCHAR(20) | 联系电话 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

### 2.2 设备表: devices_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定ID (可为空，表示通用资源) |
| device_code | VARCHAR(50) | 设备编号 |
| name | VARCHAR(200) | 设备名称 |
| device_type | VARCHAR(50) | uav/robot/sensor |
| model | VARCHAR(100) | 型号 |
| status | VARCHAR(20) | available/deployed/charging/fault |
| capabilities | VARCHAR(50)[] | 能力标签 |
| battery_level | INT | 电量百分比 |
| max_flight_time_min | INT | 最大续航 |
| current_location | GEOGRAPHY(POINT) | 当前位置 |
| assigned_team_id | UUID | 所属队伍 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

### 2.3 车辆表: vehicles_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定ID (可为空，表示通用资源) |
| vehicle_code | VARCHAR(50) | 车辆编号 |
| name | VARCHAR(200) | 车辆名称 |
| vehicle_type | VARCHAR(50) | truck/ambulance/command |
| status | VARCHAR(20) | available/in_transit/maintenance |
| license_plate | VARCHAR(20) | 车牌号 |
| capacity_personnel | INT | 载人数 |
| capacity_weight_kg | INT | 载重 |
| current_location | GEOGRAPHY(POINT) | 当前位置 |
| fuel_level | INT | 油量百分比 |
| loaded_teams | UUID[] | 装载队伍 |
| loaded_devices | UUID[] | 装载设备 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

> **说明**: `scenario_id` 为空时表示通用资源池中的资源，可被任意想定调用；不为空时表示该资源已分配到特定想定。

---

## 三、接口列表

### 3.1 队伍管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建队伍 | POST | `/api/v2/teams` | 创建 |
| 获取队伍列表 | GET | `/api/v2/teams` | 分页查询 |
| 获取队伍详情 | GET | `/api/v2/teams/{id}` | 单个详情 |
| 更新队伍 | PUT | `/api/v2/teams/{id}` | 更新 |
| 删除队伍 | DELETE | `/api/v2/teams/{id}` | 删除 |
| 更新队伍位置 | PATCH | `/api/v2/teams/{id}/location` | 位置更新 |
| 更新队伍状态 | PATCH | `/api/v2/teams/{id}/status` | 状态更新 |
| 装载到车辆 | POST | `/api/v2/teams/{id}/load` | 装载 |
| 从车辆卸载 | POST | `/api/v2/teams/{id}/unload` | 卸载 |

### 3.2 设备管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建设备 | POST | `/api/v2/devices` | 创建 |
| 获取设备列表 | GET | `/api/v2/devices` | 分页查询 |
| 获取设备详情 | GET | `/api/v2/devices/{id}` | 单个详情 |
| 更新设备 | PUT | `/api/v2/devices/{id}` | 更新 |
| 删除设备 | DELETE | `/api/v2/devices/{id}` | 删除 |
| 更新设备位置 | PATCH | `/api/v2/devices/{id}/location` | 位置更新 |
| 更新设备状态 | PATCH | `/api/v2/devices/{id}/status` | 状态更新 |
| 分配到队伍 | POST | `/api/v2/devices/{id}/assign` | 分配 |
| 取消分配 | POST | `/api/v2/devices/{id}/unassign` | 取消分配 |
| 遥测数据上报 | POST | `/api/v2/devices/{id}/telemetry` | 遥测数据 |

### 3.3 车辆管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建车辆 | POST | `/api/v2/vehicles` | 创建 |
| 获取车辆列表 | GET | `/api/v2/vehicles` | 分页查询 |
| 获取车辆详情 | GET | `/api/v2/vehicles/{id}` | 单个详情 |
| 更新车辆 | PUT | `/api/v2/vehicles/{id}` | 更新 |
| 删除车辆 | DELETE | `/api/v2/vehicles/{id}` | 删除 |
| 更新车辆位置 | PATCH | `/api/v2/vehicles/{id}/location` | 位置更新 |
| 更新车辆状态 | PATCH | `/api/v2/vehicles/{id}/status` | 状态更新 |
| 获取装载详情 | GET | `/api/v2/vehicles/{id}/cargo` | 装载内容 |

---

## 四、接口详细设计

### 4.1 获取队伍列表

**GET** `/api/v2/teams`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |
| status | string | 状态过滤 |
| capabilities | string[] | 能力过滤 |
| team_type | string | 类型过滤 |
| available_only | bool | 仅可用 |
| near_location | string | 附近位置(lng,lat) |
| radius_km | number | 搜索半径 |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "team-uuid",
                "team_code": "TEAM-001",
                "name": "搜救一队",
                "team_type": "rescue",
                "status": "available",
                "capabilities": ["废墟搜救", "生命探测", "现场急救"],
                "personnel_count": 12,
                "current_location": {"longitude": 103.85, "latitude": 31.68},
                "loaded_on_vehicle": {
                    "id": "vehicle-001",
                    "name": "救援车1号"
                },
                "distance_km": 2.5
            }
        ],
        "pagination": {...}
    }
}
```

---

### 4.2 装载到车辆

**POST** `/api/v2/teams/{id}/load`

**请求体：**
```json
{
    "vehicle_id": "vehicle-001"
}
```

**业务规则：**
- 检查车辆容量是否足够
- 检查队伍是否已被装载
- 更新队伍位置跟随车辆

---

### 4.3 设备遥测数据上报

**POST** `/api/v2/devices/{id}/telemetry`

**请求体：**
```json
{
    "timestamp": "2025-11-25T14:30:00Z",
    "location": {"longitude": 103.851, "latitude": 31.682, "altitude_m": 50},
    "battery_level": 75,
    "speed_kmh": 35,
    "heading": 45,
    "sensors": {
        "thermal_camera": {"active": true, "detections": 2},
        "gas_sensor": {"co_ppm": 15, "ch4_ppm": 0}
    }
}
```

---

### 4.4 获取车辆装载详情

**GET** `/api/v2/vehicles/{id}/cargo`

**响应体：**
```json
{
    "success": true,
    "data": {
        "vehicle_id": "vehicle-001",
        "vehicle_name": "救援车1号",
        "capacity_personnel": 20,
        "capacity_weight_kg": 3000,
        "current_personnel": 12,
        "current_weight_kg": 1500,
        "loaded_teams": [
            {
                "id": "team-001",
                "name": "搜救一队",
                "personnel_count": 12
            }
        ],
        "loaded_devices": [
            {
                "id": "uav-001",
                "name": "侦察无人机A",
                "device_type": "uav"
            }
        ]
    }
}
```

---

## 五、错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| RS4001 | 404 | 资源不存在 |
| RS4002 | 409 | 资源正在执行任务 |
| RS4003 | 409 | 车辆容量不足 |
| RS4004 | 409 | 资源已被分配 |
| RS4005 | 400 | 无效的资源类型 |

---

## 六、实现要点

### 6.1 位置更新触发WebSocket推送

```python
async def update_location(resource_type: str, resource_id: UUID, location: dict):
    await db.execute(
        f"UPDATE {resource_type}_v2 SET current_location = ST_Point($1, $2) WHERE id = $3",
        location["longitude"], location["latitude"], resource_id
    )
    
    # 推送位置更新
    await broadcaster.broadcast(
        channel="entities",
        action="position_updated",
        data={
            "entity_id": str(resource_id),
            "entity_type": resource_type,
            "location": location
        }
    )
```

### 6.2 四层装载模型位置同步

```python
# 车辆位置更新时，同步更新装载的队伍和设备位置
async def sync_cargo_location(vehicle_id: UUID, location: dict):
    vehicle = await get_vehicle_with_cargo(vehicle_id)
    
    # 同步队伍位置
    for team_id in vehicle.loaded_teams:
        await update_location("teams", team_id, location)
    
    # 同步设备位置
    for device_id in vehicle.loaded_devices:
        await update_location("devices", device_id, location)
```

---

## 七、物资装备管理

### 7.1 数据库表: supplies_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定ID |
| supply_code | VARCHAR(50) | 物资编号 |
| name | VARCHAR(200) | 物资名称 |
| category | VARCHAR(50) | 类别: rescue_tool/medical/communication/food/tent |
| unit | VARCHAR(20) | 单位: 个/套/箱/kg |
| total_quantity | INT | 总数量 |
| available_quantity | INT | 可用数量 |
| allocated_quantity | INT | 已分配数量 |
| storage_location | VARCHAR(200) | 存放位置 |
| expiry_date | DATE | 有效期(食品/药品) |
| status | VARCHAR(20) | normal/low_stock/expired |

### 7.2 接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建物资 | POST | `/api/v2/supplies` | 创建物资记录 |
| 获取物资列表 | GET | `/api/v2/supplies` | 分页查询 |
| 获取物资详情 | GET | `/api/v2/supplies/{id}` | 单个详情 |
| 更新物资库存 | PATCH | `/api/v2/supplies/{id}/stock` | 更新库存 |

### 7.3 接口详细设计

#### 7.3.1 获取物资列表

**GET** `/api/v2/supplies`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |
| category | string | 类别过滤 |
| status | string | 状态过滤 |
| low_stock_only | bool | 仅低库存 |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "supply-uuid",
                "supply_code": "SUP-001",
                "name": "液压破拆工具组",
                "category": "rescue_tool",
                "unit": "套",
                "total_quantity": 10,
                "available_quantity": 6,
                "allocated_quantity": 4,
                "status": "normal",
                "storage_location": "装备库A区"
            }
        ],
        "summary": {
            "total_items": 50,
            "low_stock_items": 3,
            "expired_items": 1
        }
    }
}
```

#### 7.3.2 更新物资库存

**PATCH** `/api/v2/supplies/{id}/stock`

**请求体：**
```json
{
    "operation": "allocate",
    "quantity": 2,
    "target_task_id": "task-uuid",
    "reason": "分配给搜救任务"
}
```

**operation枚举：**
- `allocate`: 分配(减少可用)
- `release`: 释放(增加可用)
- `consume`: 消耗(减少总量)
- `replenish`: 补充(增加总量)

---

## 八、安置点管理

### 8.1 数据库表: shelters_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定ID |
| shelter_code | VARCHAR(50) | 安置点编号 |
| name | VARCHAR(200) | 安置点名称 |
| shelter_type | VARCHAR(50) | 类型: temporary/permanent/medical |
| location | GEOGRAPHY(POINT) | 位置 |
| address | VARCHAR(300) | 地址 |
| max_capacity | INT | 最大容纳人数 |
| current_occupancy | INT | 当前人数 |
| facilities | VARCHAR(50)[] | 设施: water/power/medical/food |
| status | VARCHAR(20) | preparing/active/full/closed |
| contact_person | VARCHAR(100) | 负责人 |
| contact_phone | VARCHAR(20) | 联系电话 |

### 8.2 接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建安置点 | POST | `/api/v2/shelters` | 创建安置点 |
| 获取安置点列表 | GET | `/api/v2/shelters` | 分页查询 |
| 获取安置点详情 | GET | `/api/v2/shelters/{id}` | 单个详情 |
| 更新安置点 | PUT | `/api/v2/shelters/{id}` | 更新信息 |
| 更新安置点容量 | PATCH | `/api/v2/shelters/{id}/capacity` | 更新容量 |

### 8.3 接口详细设计

#### 8.3.1 获取安置点列表

**GET** `/api/v2/shelters`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |
| status | string | 状态过滤 |
| has_capacity | bool | 有剩余容量 |
| near_location | string | 附近位置 lng,lat |
| radius_km | number | 搜索半径 |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "shelter-uuid",
                "shelter_code": "SHL-001",
                "name": "茂县中学临时安置点",
                "shelter_type": "temporary",
                "location": {"longitude": 103.88, "latitude": 31.72},
                "address": "茂县凤仪镇茂县中学",
                "max_capacity": 500,
                "current_occupancy": 320,
                "available_capacity": 180,
                "occupancy_rate": 0.64,
                "facilities": ["water", "power", "food"],
                "status": "active",
                "distance_km": 3.5
            }
        ],
        "summary": {
            "total_shelters": 5,
            "total_capacity": 2000,
            "total_occupancy": 1200,
            "available_capacity": 800
        }
    }
}
```

#### 8.3.2 更新安置点容量

**PATCH** `/api/v2/shelters/{id}/capacity`

**请求体：**
```json
{
    "operation": "check_in",
    "count": 50,
    "source": "凤仪镇转移群众",
    "notes": "含老人15人，儿童10人"
}
```

**operation枚举：**
- `check_in`: 入住(增加人数)
- `check_out`: 离开(减少人数)
- `expand`: 扩容(增加最大容量)

**响应体：**
```json
{
    "success": true,
    "data": {
        "shelter_id": "shelter-uuid",
        "previous_occupancy": 320,
        "current_occupancy": 370,
        "available_capacity": 130,
        "status": "active"
    }
}
```

---

## 九、补充错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| RS4006 | 409 | 物资库存不足 |
| RS4007 | 409 | 物资已过期 |
| RS4008 | 409 | 安置点已满 |
| RS4009 | 400 | 无效的库存操作 |
