# 指挥消息接口设计

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 优先级: P1

---

## 一、模块概述

指挥消息模块提供指挥员与执行者之间的通信能力，支持文本、语音、图片等多种消息类型。

**消息类型：**
- text: 文本消息
- voice: 语音消息
- image: 图片消息
- location: 位置消息
- command: 指令消息
- alert: 告警消息

**目标类型：**
- user: 单个用户
- team: 队伍
- broadcast: 广播(所有人)

---

## 二、数据库表

### 2.1 消息表: messages_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定 |
| message_type | VARCHAR(20) | 消息类型 |
| content | TEXT | 消息内容 |
| media_url | VARCHAR(500) | 媒体URL |
| sender_id | UUID | 发送者ID |
| sender_name | VARCHAR(100) | 发送者名称 |
| target_type | VARCHAR(20) | 目标类型 |
| target_id | UUID | 目标ID |
| priority | VARCHAR(20) | 优先级 |
| location | GEOGRAPHY(POINT) | 相关位置 |
| related_event_id | UUID | 关联事件 |
| related_task_id | UUID | 关联任务 |
| is_read | BOOLEAN | 是否已读 |
| sent_at | TIMESTAMPTZ | 发送时间 |

---

## 三、接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 发送消息 | POST | `/api/v2/messages` | 发送 |
| 获取消息列表 | GET | `/api/v2/messages` | 列表 |
| 获取消息详情 | GET | `/api/v2/messages/{id}` | 详情 |
| 标记已读 | POST | `/api/v2/messages/{id}/read` | 已读 |
| 批量标记已读 | POST | `/api/v2/messages/batch-read` | 批量已读 |
| 获取未读数 | GET | `/api/v2/messages/unread-count` | 未读数 |
| 发送广播 | POST | `/api/v2/messages/broadcast` | 广播 |
| 语音转文字 | POST | `/api/v2/messages/voice-to-text` | 语音识别 |
| 撤回消息 | DELETE | `/api/v2/messages/{id}` | 撤回 |

---

## 四、接口详细设计

### 4.1 发送消息

**POST** `/api/v2/messages`

**请求体：**
```json
{
    "scenario_id": "scenario-uuid",
    "message_type": "command",
    "content": "立即转移至北侧集结点",
    "target_type": "team",
    "target_id": "team-001",
    "priority": "urgent",
    "location": {
        "longitude": 103.855,
        "latitude": 31.685
    },
    "related_task_id": "task-001"
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "message-uuid",
        "message_type": "command",
        "content": "立即转移至北侧集结点",
        "sender": {
            "id": "user-001",
            "name": "指挥员A"
        },
        "target": {
            "type": "team",
            "id": "team-001",
            "name": "搜救一队"
        },
        "sent_at": "2025-11-25T15:00:00Z"
    }
}
```

---

### 4.2 获取消息列表

**GET** `/api/v2/messages`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |
| message_type | string | 消息类型 |
| target_type | string | 目标类型 |
| is_read | bool | 是否已读 |
| since | string | 起始时间 |

---

### 4.3 发送广播

**POST** `/api/v2/messages/broadcast`

**请求体：**
```json
{
    "scenario_id": "scenario-uuid",
    "message_type": "alert",
    "content": "注意：监测到余震，请注意安全",
    "priority": "urgent"
}
```

---

### 4.4 语音转文字

**POST** `/api/v2/messages/voice-to-text`

**请求体：**
```json
{
    "audio_url": "https://storage.example.com/voice/xxx.wav",
    "audio_format": "wav"
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "text": "请求支援，有人员受伤",
        "confidence": 0.95,
        "duration_seconds": 5
    }
}
```

---

## 五、错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| MG4001 | 404 | 消息不存在 |
| MG4002 | 403 | 无权限发送给该目标 |
| MG4003 | 400 | 不支持的媒体格式 |
| MG4004 | 413 | 消息内容过大 |
