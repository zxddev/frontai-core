# AI Agent模块 - 待办与优化建议

> 最后更新: 2024-11-26

## 已完成优化

| 优化项 | 描述 | 状态 |
|--------|------|------|
| 规则引擎缓存 | 基于文件mtime的缓存机制，避免重复解析YAML | ✅ 已完成 |
| 数据库集成 | TeamDataProvider从rescue_teams_v2查询队伍 | ✅ 已完成 |
| 方案持久化 | SchemePersister保存方案到schemes_v2表 | ✅ 已完成 |
| 节点级耗时追踪 | `@track_node_time`装饰器记录各节点执行时间 | ✅ 已完成 |
| 置信度评分 | `confidence_score`综合评估方案可信度 | ✅ 已完成 |
| 数据库查询超时 | `asyncio.wait_for`控制查询超时 | ✅ 已完成 |
| 缓存命中率统计 | `get_cache_stats()`返回hits/misses/hit_rate | ✅ 已完成 |
| 健康检查增强 | `/health`检查规则文件、数据库连接 | ✅ 已完成 |
| 规则热更新 | `POST /ai/rules/reload`无需重启更新规则 | ✅ 已完成 |
| 熔断机制 | optimization/matching节点添加CircuitBreaker | ✅ 已完成 |
| 批量生成API | `POST /ai/generate-schemes/batch`支持并行处理 | ✅ 已完成 |

---

## 待实现优化

### 高优先级

#### 1. 并发资源锁
**问题**: 多事件同时请求时可能重复分配同一资源

**方案**:
```python
# 使用Redis分布式锁
async def lock_resource(resource_id: str, event_id: str, ttl: int = 300):
    key = f"resource_lock:{resource_id}"
    return await redis.set(key, event_id, nx=True, ex=ttl)
```

**涉及文件**:
- `src/agents/scheme_generation/nodes/matching.py`
- 新增 `src/agents/utils/resource_lock.py`

**预估工作量**: 2-3天

---

#### 2. 方案模板
**问题**: 常见场景每次都重新计算，效率低

**方案**:
- 预定义常见场景模板（地震I级、火灾高层等）
- 模板包含推荐的队伍组合和任务分解
- 匹配模板后直接使用，跳过部分计算

**涉及文件**:
- 新增 `config/templates/scheme_templates.yaml`
- 新增 `src/agents/scheme_generation/template_matcher.py`

**预估工作量**: 2天

---

### 中优先级

#### 4. 方案版本管理
**问题**: 方案修改后无法追溯历史版本

**方案**:
- schemes_v2表增加`parent_scheme_id`字段
- 每次修改创建新版本，保留历史
- 支持版本对比和回滚

**涉及文件**:
- `src/domains/schemes/models.py`
- `src/domains/schemes/service.py`
- SQL迁移脚本

**预估工作量**: 3天

---

#### 5. 分布式追踪
**问题**: 跨服务调用链路难以追踪

**方案**:
- 集成OpenTelemetry
- 在Agent各节点添加Span
- 接入Jaeger/Zipkin可视化

**涉及文件**:
- 新增 `src/core/telemetry.py`
- 修改所有Agent节点

**预估工作量**: 2-3天

---

#### 6. 资源预留机制
**问题**: 方案审批期间资源可能被其他事件占用

**方案**:
- 方案生成时预留资源（软锁定）
- 审批通过后正式分配
- 超时自动释放预留

**涉及文件**:
- `src/agents/db/teams.py`
- 新增 `src/agents/utils/resource_reservation.py`

**预估工作量**: 2天

---

### 低优先级

#### 6. 反馈学习
**问题**: 方案执行效果无法反馈到规则优化

**方案**:
- 收集方案执行结果（成功/失败/耗时）
- 分析规则触发与执行效果的关联
- 自动调整规则权重

**涉及文件**:
- 新增 `src/agents/feedback/collector.py`
- 新增 `src/agents/feedback/analyzer.py`

**预估工作量**: 5-7天

---

#### 7. 方案对比
**问题**: 多个方案难以直观对比

**方案**:
- 提供方案并排对比API
- 高亮差异点（资源、任务、指标）
- 生成对比报告

**涉及文件**:
- 新增 `src/agents/comparison/comparator.py`
- `src/agents/router.py`

**预估工作量**: 2天

---

#### 8. 断点续传
**问题**: Agent执行中断后需要重新开始

**方案**:
- 使用LangGraph的checkpoint机制
- 将中间状态持久化到Redis/DB
- 支持从断点恢复执行

**涉及文件**:
- `src/agents/scheme_generation/graph.py`
- 新增 `src/agents/utils/checkpoint.py`

**预估工作量**: 3-4天

---

#### 9. 降级策略
**问题**: 数据库不可用时服务完全不可用

**方案**:
- 数据库查询失败时使用模拟数据（当前已部分支持）
- 缓存最近的队伍数据作为降级数据源
- 记录降级日志供后续补偿

**涉及文件**:
- `src/agents/db/teams.py`
- `src/agents/scheme_generation/agent.py`

**预估工作量**: 1-2天

---

#### 10. 结果缓存
**问题**: 相似场景重复计算浪费资源

**方案**:
- 基于事件特征计算缓存key
- 相似场景直接返回缓存结果
- 设置合理的TTL和失效策略

**涉及文件**:
- 新增 `src/agents/utils/result_cache.py`
- `src/agents/scheme_generation/agent.py`

**预估工作量**: 2天

---

## 技术债务

| 问题 | 描述 | 优先级 |
|------|------|--------|
| SQLAlchemy模型类型注解 | 部分模型缺少`Mapped[]`注解 | 低 |
| 单元测试覆盖 | Agent模块测试覆盖率不足 | 中 |
| 日志结构化 | 部分日志缺少结构化字段 | 低 |
| 错误码规范 | AI模块错误码需要统一规范 | 中 |

---

## 性能基准

当前性能指标（单事件，8支队伍）:
- 总执行时间: ~50ms
- 规则触发节点: ~30ms（含首次加载）
- 资源匹配节点: ~0.3ms
- 优化节点: ~0.04ms
- 缓存命中后: ~15ms

目标:
- 单事件 < 100ms
- 批量10事件 < 500ms
- 缓存命中 < 20ms

---

## 参考资料

- [LangGraph Checkpoint文档](https://python.langchain.com/docs/langgraph)
- [OpenTelemetry Python](https://opentelemetry.io/docs/languages/python/)
- [Circuit Breaker Pattern](https://martinfowler.com/bliki/CircuitBreaker.html)
