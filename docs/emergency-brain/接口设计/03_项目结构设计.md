# 应急救灾AI大脑 - 项目结构设计

> 版本: 2.1  
> 更新时间: 2025-11-25  
> 技术栈: FastAPI + LangGraph + PostgreSQL + Redis

---

## 1. 技术栈选型

| 组件 | 版本 | 用途 |
|-----|------|------|
| Python | ≥3.11 | 运行时 |
| FastAPI | ≥0.115.0 | Web框架 |
| LangGraph | ≥0.3.27 | 多Agent编排 |
| PostgreSQL | 17+ (PostGIS 3.4+) | 主数据库 |
| Redis | 7+ | 缓存/消息队列/WebSocket Pub/Sub |
| Qdrant | 1.12+ | 向量数据库 |

---

## 2. 项目目录结构

```
frontai-core/
├── src/
│   ├── main.py                        # FastAPI应用入口
│   │
│   ├── core/                          # ========== 全局核心模块 ==========
│   │   ├── __init__.py
│   │   ├── config.py                  # 配置管理 (pydantic-settings)
│   │   ├── database.py                # 数据库连接池 (asyncpg)
│   │   ├── redis.py                   # Redis连接
│   │   ├── security.py                # 认证授权 (JWT/API Key)
│   │   ├── exceptions.py              # 全局异常定义
│   │   ├── middleware.py              # FastAPI中间件
│   │   ├── dependencies.py            # 全局依赖注入
│   │   └── tasks.py                   # 异步任务管理 (BackgroundTasks/arq)
│   │
│   ├── domains/                       # ========== 业务领域模块 ==========
│   │   │
│   │   ├── scenarios/                 # --- 想定管理 ---
│   │   │   ├── __init__.py
│   │   │   ├── router.py              # API路由: /api/v2/scenarios
│   │   │   ├── schemas.py             # Pydantic请求/响应模型
│   │   │   ├── models.py              # SQLAlchemy ORM模型
│   │   │   ├── service.py             # 业务逻辑
│   │   │   └── repository.py          # 数据访问层
│   │   │
│   │   ├── events/                    # --- 事件管理 ---
│   │   │   ├── __init__.py
│   │   │   ├── router.py              # API路由: /api/v2/events
│   │   │   ├── schemas.py             # 含 pre_confirmed 状态
│   │   │   ├── models.py              # events_v2 ORM
│   │   │   ├── service.py             # 状态机流转逻辑
│   │   │   ├── repository.py
│   │   │   └── state_machine.py       # 事件状态机定义
│   │   │
│   │   ├── schemes/                   # --- 方案管理 ---
│   │   │   ├── router.py              # API路由: /api/v2/schemes
│   │   │   ├── schemas.py
│   │   │   ├── models.py              # schemes_v2 + allocations ORM
│   │   │   ├── service.py
│   │   │   └── repository.py
│   │   │
│   │   ├── tasks/                     # --- 任务管理 ---
│   │   │   ├── router.py              # API路由: /api/v2/tasks
│   │   │   ├── schemas.py
│   │   │   ├── models.py              # tasks_v2 + assignments ORM
│   │   │   ├── service.py
│   │   │   └── repository.py
│   │   │
│   │   ├── resources/                 # --- 资源管理 ---
│   │   │   ├── router.py              # 统一入口: /api/v2/teams, /devices, /supplies
│   │   │   ├── schemas.py
│   │   │   ├── teams/                 # 救援队伍
│   │   │   │   ├── service.py
│   │   │   │   └── repository.py
│   │   │   ├── devices/               # 无人设备
│   │   │   │   ├── service.py
│   │   │   │   └── repository.py
│   │   │   └── supplies/              # 物资
│   │   │       ├── service.py
│   │   │       └── repository.py
│   │   │
│   │   ├── entities/                  # --- 图层实体 ---
│   │   │   ├── router.py              # API路由: /api/v2/entities, /layers
│   │   │   ├── schemas.py
│   │   │   ├── service.py
│   │   │   └── repository.py
│   │   │
│   │   └── users/                     # --- 用户权限 ---
│   │       ├── router.py              # API路由: /api/v2/auth, /users
│   │       ├── schemas.py
│   │       ├── service.py
│   │       └── repository.py
│   │
│   ├── agents/                        # ========== AI Agent模块 ==========
│   │   ├── __init__.py
│   │   │
│   │   ├── base/                      # --- 共享基础 ---
│   │   │   ├── __init__.py
│   │   │   ├── agent.py               # BaseAgent抽象类
│   │   │   ├── state.py               # 共享State类型
│   │   │   └── tools.py               # 共享工具函数
│   │   │
│   │   ├── event_analysis/            # --- 事件分析Agent ---
│   │   │   ├── __init__.py
│   │   │   ├── agent.py               # EventAnalysisAgent实现
│   │   │   ├── graph.py               # LangGraph StateGraph定义
│   │   │   ├── state.py               # Agent专用State
│   │   │   └── nodes/
│   │   │       ├── assess.py          # 灾情评估节点
│   │   │       ├── predict.py         # 次生灾害预测节点
│   │   │       └── confirm.py         # 确认评分节点 (AC规则+评分计算)
│   │   │
│   │   ├── scheme_generation/         # --- 方案生成Agent ---
│   │   │   ├── agent.py
│   │   │   ├── graph.py
│   │   │   ├── state.py
│   │   │   └── nodes/
│   │   │       ├── analyze_needs.py   # 需求分析
│   │   │       ├── match_resources.py # 资源匹配
│   │   │       └── optimize.py        # 方案优化
│   │   │
│   │   ├── resource_matching/         # --- 资源匹配Agent ---
│   │   │   ├── agent.py
│   │   │   ├── graph.py
│   │   │   └── nodes/
│   │   │       ├── score.py           # 动态权重评分
│   │   │       └── reason.py          # 推荐理由生成
│   │   │
│   │   ├── task_dispatch/             # --- 任务调度Agent ---
│   │   │   ├── agent.py
│   │   │   ├── graph.py
│   │   │   └── nodes/
│   │   │       ├── decompose.py       # 任务拆解
│   │   │       ├── assign.py          # 执行者分配
│   │   │       └── route.py           # 路径规划
│   │   │
│   │   ├── chat/                      # --- AI问答Agent ---
│   │   │   ├── agent.py
│   │   │   └── graph.py
│   │   │
│   │   ├── router.py                  # AI接口路由: /api/v2/ai/*
│   │   └── schemas.py                 # AI接口请求/响应模型
│   │
│   ├── planning/                      # ========== 算法层 ==========
│   │   └── algorithms/
│   │       ├── __init__.py
│   │       ├── base.py                # 算法基类
│   │       │
│   │       ├── assessment/            # --- 灾情评估算法 ---
│   │       │   ├── __init__.py
│   │       │   ├── disaster_assessment.py    # 灾情等级评估
│   │       │   ├── secondary_hazard.py       # 次生灾害预测
│   │       │   ├── loss_estimation.py        # 损失估算
│   │       │   └── confirmation_scorer.py    # [新增] 确认评分算法
│   │       │
│   │       ├── matching/              # --- 资源匹配算法 ---
│   │       │   ├── __init__.py
│   │       │   ├── rescue_team_selector.py   # 队伍选择
│   │       │   ├── capability_matcher.py     # 能力匹配
│   │       │   └── vehicle_cargo_matcher.py  # 车辆装载匹配
│   │       │
│   │       ├── routing/               # --- 路径规划算法 ---
│   │       │   ├── __init__.py
│   │       │   ├── road_engine.py            # 路网A*
│   │       │   ├── offroad_engine.py         # 越野路径
│   │       │   └── vehicle_routing.py        # VRP求解
│   │       │
│   │       ├── optimization/          # --- 优化算法 ---
│   │       │   ├── __init__.py
│   │       │   ├── pymoo_optimizer.py        # NSGA-II多目标优化
│   │       │   └── mcts_planner.py           # 蒙特卡洛树搜索
│   │       │
│   │       ├── scheduling/            # --- 调度算法 ---
│   │       │   ├── __init__.py
│   │       │   └── task_scheduler.py         # 任务调度
│   │       │
│   │       └── arbitration/           # --- 冲突仲裁算法 ---
│   │           ├── __init__.py
│   │           ├── scene_arbitrator.py       # 场景仲裁
│   │           └── conflict_resolver.py      # 冲突解决
│   │
│   ├── integrations/                  # ========== 第三方接入模块 ==========
│   │   ├── __init__.py
│   │   ├── router.py                  # 统一路由: /api/v2/integrations/*
│   │   │
│   │   ├── disaster_report/           # --- 灾情上报接入 ---
│   │   │   ├── __init__.py
│   │   │   ├── handler.py             # 请求处理器
│   │   │   ├── schemas.py             # 入参/出参定义
│   │   │   ├── adapter.py             # 数据转换适配
│   │   │   ├── validator.py           # 数据校验
│   │   │   └── deduplicator.py        # 去重逻辑
│   │   │
│   │   ├── sensor_alert/              # --- 传感器告警接入 ---
│   │   │   ├── handler.py
│   │   │   ├── schemas.py
│   │   │   └── adapter.py
│   │   │
│   │   ├── telemetry/                 # --- 设备遥测接入 ---
│   │   │   ├── handler.py
│   │   │   ├── schemas.py
│   │   │   └── batch_processor.py     # 批量处理
│   │   │
│   │   └── weather/                   # --- 气象数据接入 ---
│   │       ├── client.py
│   │       └── schemas.py
│   │
│   ├── realtime/                      # ========== 实时推送模块 ==========
│   │   ├── __init__.py
│   │   ├── router.py                  # WebSocket路由: /ws/v2/realtime
│   │   ├── manager.py                 # 连接管理器
│   │   ├── broadcaster.py             # 广播器 (Redis Pub/Sub)
│   │   ├── channels.py                # 频道定义 (events/entities/tasks等)
│   │   └── subscription.py            # 订阅管理
│   │
│   ├── simulation/                    # ========== 仿真模块 ==========
│   │   ├── __init__.py
│   │   ├── router.py                  # 仿真控制API: /api/v2/simulation/*
│   │   ├── engine.py                  # 仿真引擎核心
│   │   ├── clock.py                   # 仿真时钟
│   │   ├── config.py                  # 仿真配置
│   │   │
│   │   ├── scenarios/                 # --- 预设场景 ---
│   │   │   ├── base.py
│   │   │   ├── earthquake.py
│   │   │   ├── flood.py
│   │   │   └── fire.py
│   │   │
│   │   └── generators/                # --- 数据生成器 ---
│   │       ├── event_generator.py
│   │       ├── telemetry_generator.py
│   │       └── entity_generator.py
│   │
│   └── infra/                         # ========== 基础设施 ==========
│       ├── __init__.py
│       ├── clients/
│       │   ├── llm.py                 # LLM客户端
│       │   └── qdrant.py              # 向量数据库客户端
│       └── db/
│           └── postgres_dao.py        # PostgreSQL DAO工具
│
├── config/                            # ========== 配置文件 ==========
│   ├── ai_agents.yaml                 # AI Agent配置(权重/超时/降级)
│   ├── integrations/
│   │   └── source_trust.yaml          # 来源可信度配置
│   ├── emergency/
│   │   ├── auto_confirm_rules.yaml    # AC-001~AC-004自动确认规则
│   │   ├── trr_rules.yaml             # TRR触发规则
│   │   └── constraints.yaml           # 约束条件
│   └── langgraph.json                 # LangGraph部署配置
│
├── sql/                               # ========== 数据库脚本 ==========
│   ├── v2_rescue_resource_model.sql
│   ├── v2_event_scheme_model.sql      # 含pre_confirmed状态
│   ├── v2_task_dispatch_model.sql
│   ├── v2_vehicle_device_model.sql
│   ├── v2_layer_entity_model.sql
│   ├── v2_environment_model.sql
│   └── v2_road_network_model.sql
│
├── tests/
│   ├── unit/
│   ├── integration/
│   └── e2e/
│
├── docs/emergency-brain/              # 本项目文档
│
├── scripts/
│   ├── init_db.sh
│   └── deploy.sh
│
├── .env.example
├── requirements.txt
└── pyproject.toml
```

---

## 3. 模块职责说明

### 3.1 core/ - 全局核心

| 文件 | 职责 |
|-----|------|
| config.py | pydantic-settings管理环境变量和配置文件 |
| database.py | asyncpg连接池，事务管理 |
| redis.py | Redis连接，用于缓存和WebSocket Pub/Sub |
| security.py | JWT认证(内部)、API Key认证(第三方) |
| exceptions.py | 统一异常类和错误码 |
| middleware.py | 请求日志、CORS、限流 |
| tasks.py | 异步任务管理(AI分析等) |

### 3.2 domains/ - 业务领域

每个领域遵循相同结构：
```
{domain}/
├── router.py       # FastAPI路由定义
├── schemas.py      # Pydantic请求/响应模型
├── models.py       # SQLAlchemy ORM模型
├── service.py      # 业务逻辑（调用repository和外部服务）
└── repository.py   # 数据访问（SQL查询）
```

### 3.3 agents/ - AI Agent

每个Agent包含：
```
{agent}/
├── agent.py        # Agent类实现（继承BaseAgent）
├── graph.py        # LangGraph StateGraph定义
├── state.py        # TypedDict状态定义
└── nodes/          # 节点函数
```

**Agent与算法层关系**：
```
agents/event_analysis/nodes/assess.py
    ↓ 调用
planning/algorithms/assessment/disaster_assessment.py
```

### 3.4 planning/algorithms/ - 算法层

纯算法实现，无依赖业务逻辑，可独立测试：
- 输入：结构化数据
- 输出：计算结果
- 特点：无数据库访问，无网络调用

### 3.5 integrations/ - 第三方接入

处理外部系统数据接入：
- 数据校验
- 格式适配
- 去重处理
- 触发后续流程

### 3.6 realtime/ - 实时推送

WebSocket推送管理：
- 连接管理
- 频道订阅
- Redis Pub/Sub广播
- 心跳保活

---

## 4. 数据流示意

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据流向                                        │
└─────────────────────────────────────────────────────────────────────────────┘

第三方系统
    │
    │ POST /api/v2/integrations/disaster-report
    ↓
┌─────────────────┐
│  integrations/  │  数据校验 → 去重 → 适配转换
│ disaster_report │
└────────┬────────┘
         │
         │ 调用 EventService.create_event()
         ↓
┌─────────────────┐
│    domains/     │  创建事件 → 持久化 → 触发WebSocket推送
│     events/     │
└────────┬────────┘
         │
         │ 触发异步AI分析任务
         ↓
┌─────────────────┐     ┌─────────────────────┐
│    agents/      │ ──→ │ planning/algorithms │
│ event_analysis  │     │ (纯算法计算)         │
└────────┬────────┘     └─────────────────────┘
         │
         │ 更新事件状态(confirmed/pre_confirmed)
         ↓
┌─────────────────┐
│    realtime/    │  WebSocket推送状态变更
│   broadcaster   │
└─────────────────┘
         │
         ↓
      前端地图
```

---

## 5. 配置文件说明

### 5.1 config/ai_agents.yaml

```yaml
agents:
  event_analysis:
    enabled: true
    async: true                        # 异步执行
    timeout_ms: 30000
    auto_confirm_threshold: 0.85
    pre_confirm_threshold: 0.60
    
  scheme_generation:
    enabled: true
    async: false                       # 同步执行
    timeout_ms: 5000
    degraded_timeout_ms: 2000          # 超时降级阈值
    optimization:
      population_size: 50
      generations: 100
      degraded_generations: 20         # 降级时减少迭代
      
  resource_matching:
    enabled: true
    availability_threshold: 0.1        # 可用性门槛
    default_weights:
      capability_match: 0.35
      distance: 0.25
      availability: 0.20
      equipment: 0.10
      history: 0.10
    scenario_weights:
      earthquake:
        distance: 0.40
        capability_match: 0.30
        availability: 0.15
        equipment: 0.10
        history: 0.05
      hazmat_leak:
        capability_match: 0.50
        equipment: 0.20
        distance: 0.15
        availability: 0.10
        history: 0.05
```

### 5.2 config/emergency/auto_confirm_rules.yaml

```yaml
rules:
  AC-001:
    name: "多源交叉验证"
    condition: "同位置(500m内)30分钟内≥2个不同来源上报"
    action: "auto_confirm"
    
  AC-002:
    name: "传感器+AI双触发"
    condition: "source_type=sensor AND ai_confidence>=0.8"
    action: "auto_confirm"
    
  AC-003:
    name: "官方系统紧急"
    condition: "source_system IN (110,119,120) AND is_urgent=true"
    action: "auto_confirm"
    
  AC-004:
    name: "明确被困人员"
    condition: "estimated_victims>=1 AND ai_confidence>=0.7"
    action: "auto_confirm"
```

---

## 6. 依赖说明

```txt
# requirements.txt 核心依赖

# Web框架
fastapi>=0.115.0
uvicorn[standard]>=0.32.0
pydantic>=2.10.0
pydantic-settings>=2.6.0

# LangGraph
langgraph>=0.3.27
langchain>=0.3.0
langchain-openai>=0.3.0

# 数据库
asyncpg>=0.30.0
sqlalchemy>=2.0.0
redis>=5.0.0

# 地理空间
geoalchemy2>=0.15.0
shapely>=2.0.0

# 异步任务
arq>=0.26.0  # 或使用 celery

# 工具
httpx>=0.28.0
orjson>=3.10.0
structlog>=24.4.0
websockets>=13.0
pyyaml>=6.0.0
```

---

## 7. 与现有代码整合

| 现有目录 | 处理方式 |
|---------|---------|
| `src/planning/algorithms/` | ✅ 保留，补充 `confirmation_scorer.py` |
| `src/api/` | ⚠️ 迁移到 `domains/` 各模块的 `router.py` |
| `src/infra/` | ⚠️ 迁移到 `core/` 和 `infra/` |
| `src/tests/` | ✅ 保留，扩展测试用例 |
