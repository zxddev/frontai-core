# 事件管理接口设计

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 优先级: P0

---

## 一、模块概述

事件（Event）是灾情上报后创建的业务对象，代表一个需要处理的灾情点。事件经过AI分析后进行状态流转，最终生成救援方案并派遣任务。

**核心功能：**
- 事件的创建、查询、更新
- 事件状态流转（含pre_confirmed预确认机制）
- 事件确认/取消/升级
- 事件合并处理
- 事件更新记录

**与其他模块关系：**
- 灾情上报接口创建事件 → 本模块管理事件
- AI分析接口处理事件 → 本模块更新状态
- 方案生成依赖事件 → 事件confirmed后触发

---

## 二、数据库表

### 2.1 主表: events_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定 |
| event_code | VARCHAR(50) | 事件编号 EVT-20251125-0001 |
| title | VARCHAR(200) | 事件标题 |
| event_type | event_type_v2 | 事件类型枚举 |
| source_type | event_source_type_v2 | 来源类型 |
| source_system | VARCHAR(100) | 来源系统标识 |
| source_event_id | VARCHAR(100) | 来源系统事件ID |
| disaster_level | VARCHAR(10) | 灾害等级 I/II/III/IV |
| location | GEOGRAPHY(POINT) | 事件位置 |
| address | TEXT | 地址描述 |
| status | event_status_v2 | 状态 |
| priority | event_priority_v2 | 优先级 |
| estimated_victims | INT | 预估被困人数 |
| rescued_count | INT | 已救出人数 |
| casualty_count | INT | 伤亡人数 |
| is_time_critical | BOOLEAN | 是否有黄金救援时间 |
| golden_hour_deadline | TIMESTAMPTZ | 黄金时间截止 |
| parent_event_id | UUID | 父事件ID（次生灾害） |
| merged_into_event_id | UUID | 合并到的事件ID |
| entity_id | UUID | 关联地图实体ID |
| auto_confirmed | BOOLEAN | 是否自动确认 |
| confirmation_score | DECIMAL(5,4) | AI确认评分 |
| matched_auto_confirm_rules | VARCHAR(20)[] | 匹配的AC规则 |
| pre_confirm_expires_at | TIMESTAMPTZ | 预确认倒计时截止 |
| pre_allocated_resources | JSONB | 预锁定资源 |
| pre_generated_scheme_id | UUID | 预生成方案ID |
| reported_by | UUID | 上报人 |
| confirmed_by | UUID | 确认人 |
| resolved_by | UUID | 关闭人 |
| reported_at | TIMESTAMPTZ | 上报时间 |
| confirmed_at | TIMESTAMPTZ | 确认时间 |
| pre_confirmed_at | TIMESTAMPTZ | 预确认时间 |
| resolved_at | TIMESTAMPTZ | 关闭时间 |

### 2.2 更新记录表: event_updates_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| event_id | UUID | 事件ID |
| update_type | VARCHAR(50) | 更新类型 |
| previous_value | JSONB | 更新前值 |
| new_value | JSONB | 更新后值 |
| description | TEXT | 更新描述 |
| created_by | UUID | 操作人 |
| created_at | TIMESTAMPTZ | 更新时间 |

---

## 三、状态机

```
                                        ┌─────────────┐
                                   ┌───→│  confirmed  │←──────────────────────┐
                                   │    └──────┬──────┘                       │
                                   │           │ 方案生成                      │
                                   │           ↓                              │
┌─────────┐    AI评分<0.6     ┌────┴────┐  ┌──────────┐                       │
│ pending │←──────────────────│  待确认  │  │ planning │                       │
└────┬────┘                   └────┬────┘  └────┬─────┘                       │
     │                             │            │ 任务派遣                     │
     │ 0.6≤评分<0.85               │            ↓                              │
     │ 或 priority=critical/high   │       ┌──────────┐      ┌──────────┐     │
     ↓                             │       │executing │─────→│ resolved │     │
┌───────────────┐                  │       └────┬─────┘      └──────────┘     │
│ pre_confirmed │──────────────────┘            │                             │
│  (30分钟倒计时) │                               │ 升级                        │
└───────┬───────┘                               ↓                             │
        │                                  ┌──────────┐                       │
        │ 超时+critical                    │escalated │                       │
        └─────────────────────────────────→└──────────┘                       │
        │                                                                     │
        │ 人工取消/超时+非critical                                              │
        ↓                                                                     │
   ┌──────────┐                                                               │
   │cancelled │←──────────────────────────────────────────────────────────────┘
   └──────────┘   (误报取消)
```

**状态枚举：**
```sql
CREATE TYPE event_status_v2 AS ENUM (
    'pending',        -- 待确认 (AI评分<0.6)
    'pre_confirmed',  -- 预确认 (0.6≤AI评分<0.85)
    'confirmed',      -- 已确认
    'planning',       -- 方案制定中
    'executing',      -- 执行中
    'resolved',       -- 已解决
    'escalated',      -- 已升级
    'cancelled'       -- 已取消
);
```

---

## 四、接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建事件 | POST | `/api/v2/events` | 手动创建 |
| 获取事件列表 | GET | `/api/v2/events` | 分页查询 |
| 获取事件详情 | GET | `/api/v2/events/{id}` | 单个详情 |
| 更新事件 | PUT | `/api/v2/events/{id}` | 更新信息 |
| 确认事件 | POST | `/api/v2/events/{id}/confirm` | 确认 |
| 取消事件 | POST | `/api/v2/events/{id}/cancel` | 取消 |
| 升级事件 | POST | `/api/v2/events/{id}/escalate` | 升级 |
| 关闭事件 | POST | `/api/v2/events/{id}/resolve` | 关闭 |
| 获取待复核事件 | GET | `/api/v2/events/pending-review` | pre_confirmed事件 |
| 延长复核时间 | POST | `/api/v2/events/{id}/extend-review` | 延长倒计时 |
| 批量确认 | POST | `/api/v2/events/batch-confirm` | 批量确认 |
| 获取更新记录 | GET | `/api/v2/events/{id}/updates` | 更新历史 |
| 添加更新记录 | POST | `/api/v2/events/{id}/updates` | 添加更新 |
| 获取关联方案 | GET | `/api/v2/events/{id}/schemes` | 关联方案 |
| 获取事件时间线 | GET | `/api/v2/events/{id}/timeline` | 时间线 |
| 获取关联事件 | GET | `/api/v2/events/{id}/related` | 关联事件 |

---

## 五、接口详细设计

### 5.1 创建事件

**POST** `/api/v2/events`

**请求体：**
```json
{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "凤仪镇居民楼倒塌",
    "event_type": "building_collapse",
    "location": {
        "longitude": 103.851,
        "latitude": 31.682
    },
    "address": "茂县凤仪镇幸福路12号",
    "priority": "critical",
    "estimated_victims": 20,
    "is_time_critical": true,
    "golden_hour_deadline": "2025-11-25T18:30:00+08:00",
    "description": "5层居民楼整体倒塌，预计20人被困"
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "event-uuid",
        "event_code": "EVT-20251125-0001",
        "title": "凤仪镇居民楼倒塌",
        "status": "pending",
        "priority": "critical",
        "created_at": "2025-11-25T14:30:00Z"
    },
    "message": "事件创建成功，等待AI分析"
}
```

---

### 5.2 获取事件列表

**GET** `/api/v2/events`

**查询参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| scenario_id | UUID | 是 | 想定ID |
| status | string | 否 | 状态，多值逗号分隔 |
| priority | string | 否 | 优先级 |
| event_type | string | 否 | 事件类型 |
| start_time | string | 否 | 开始时间 |
| end_time | string | 否 | 结束时间 |
| keyword | string | 否 | 关键词搜索 |
| has_victims | bool | 否 | 是否有被困人员 |
| is_time_critical | bool | 否 | 是否时间紧迫 |
| page | int | 否 | 页码 |
| page_size | int | 否 | 每页数量 |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "event-uuid",
                "event_code": "EVT-20251125-0001",
                "title": "凤仪镇居民楼倒塌",
                "event_type": "building_collapse",
                "status": "confirmed",
                "priority": "critical",
                "estimated_victims": 20,
                "rescued_count": 5,
                "location": {"longitude": 103.851, "latitude": 31.682},
                "is_time_critical": true,
                "golden_hour_deadline": "2025-11-25T18:30:00+08:00",
                "minutes_until_deadline": 120,
                "scheme_count": 1,
                "task_count": 3,
                "reported_at": "2025-11-25T14:30:00Z"
            }
        ],
        "pagination": {
            "page": 1,
            "page_size": 20,
            "total_items": 15,
            "total_pages": 1
        }
    }
}
```

---

### 5.3 获取事件详情

**GET** `/api/v2/events/{id}`

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "event-uuid",
        "scenario_id": "scenario-uuid",
        "event_code": "EVT-20251125-0001",
        "title": "凤仪镇居民楼倒塌",
        "event_type": "building_collapse",
        "source_type": "external_system",
        "source_system": "110",
        "disaster_level": "III",
        "location": {"longitude": 103.851, "latitude": 31.682},
        "address": "茂县凤仪镇幸福路12号",
        "status": "confirmed",
        "priority": "critical",
        "estimated_victims": 20,
        "rescued_count": 5,
        "casualty_count": 2,
        "is_time_critical": true,
        "golden_hour_deadline": "2025-11-25T18:30:00+08:00",
        
        "confirmation": {
            "auto_confirmed": true,
            "confirmation_score": 0.88,
            "matched_rules": ["AC-003", "AC-004"],
            "confirmed_at": "2025-11-25T14:31:00Z",
            "confirmed_by": null
        },
        
        "ai_analysis": {
            "disaster_level": "III",
            "ai_confidence": 0.85,
            "secondary_hazards": [
                {"type": "fire", "probability": 0.35}
            ],
            "recommended_actions": ["派遣搜救队", "派遣医疗队"]
        },
        
        "parent_event": null,
        "child_events": [],
        "merged_into": null,
        
        "entity_id": "entity-uuid",
        "reported_by": "user-001",
        "reported_at": "2025-11-25T14:30:00Z",
        "created_at": "2025-11-25T14:30:00Z",
        "updated_at": "2025-11-25T15:00:00Z"
    }
}
```

---

### 5.4 确认事件

**POST** `/api/v2/events/{id}/confirm`

**请求体：**
```json
{
    "reason": "现场情况核实，确认灾情属实",
    "override_ai": false
}
```

**业务规则：**
- pending或pre_confirmed状态可确认
- 确认后自动触发AI方案生成
- 如果是pre_confirmed，释放预锁定资源后重新分配

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "event-uuid",
        "previous_status": "pre_confirmed",
        "current_status": "confirmed",
        "confirmed_at": "2025-11-25T15:00:00Z",
        "confirmed_by": "user-001",
        "scheme_generation_triggered": true
    }
}
```

---

### 5.5 取消事件

**POST** `/api/v2/events/{id}/cancel`

**请求体：**
```json
{
    "reason": "现场核实为误报",
    "cancel_type": "false_alarm"
}
```

**cancel_type枚举：**
- false_alarm: 误报
- duplicate: 重复上报
- resolved_externally: 已由其他方式解决
- other: 其他

**业务规则：**
- pending/pre_confirmed/confirmed状态可取消
- executing状态不可直接取消（需先取消任务）
- 取消会释放预锁定资源

---

### 5.6 升级事件

**POST** `/api/v2/events/{id}/escalate`

**请求体：**
```json
{
    "reason": "灾情扩大，需要上级支援",
    "new_priority": "critical",
    "request_resources": ["省级搜救队", "航空救援"]
}
```

**业务规则：**
- confirmed/executing状态可升级
- 升级会通知上级指挥部
- 记录升级原因和请求资源

---

### 5.7 获取待复核事件

**GET** `/api/v2/events/pending-review`

**查询参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| scenario_id | UUID | 是 | 想定ID |
| expires_within_minutes | int | 否 | N分钟内到期 |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "event-uuid",
                "event_code": "EVT-20251125-0002",
                "title": "某路段道路塌陷",
                "priority": "high",
                "confirmation_score": 0.72,
                "pre_confirmed_at": "2025-11-25T14:30:00Z",
                "expires_at": "2025-11-25T15:00:00Z",
                "minutes_remaining": 25,
                "pre_allocated_resources": [
                    {"resource_id": "team-001", "name": "搜救队A"}
                ],
                "pre_generated_scheme_id": "scheme-draft-001"
            }
        ],
        "total": 3
    }
}
```

---

### 5.8 延长复核时间

**POST** `/api/v2/events/{id}/extend-review`

**请求体：**
```json
{
    "extend_minutes": 30,
    "reason": "需要更多现场信息"
}
```

**业务规则：**
- 只有pre_confirmed状态可延长
- 最多延长3次，每次30分钟

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "event-uuid",
        "new_expires_at": "2025-11-25T15:30:00Z",
        "extend_count": 2,
        "max_extends": 3
    }
}
```

---

### 5.9 批量确认

**POST** `/api/v2/events/batch-confirm`

**请求体：**
```json
{
    "event_ids": ["event-1", "event-2", "event-3"],
    "reason": "批量核实确认"
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "confirmed": ["event-1", "event-2"],
        "failed": [
            {"id": "event-3", "reason": "状态不允许确认"}
        ]
    }
}
```

---

### 5.10 获取事件时间线

**GET** `/api/v2/events/{id}/timeline`

**响应体：**
```json
{
    "success": true,
    "data": {
        "event_id": "event-uuid",
        "timeline": [
            {
                "time": "2025-11-25T14:30:00Z",
                "type": "created",
                "description": "事件上报",
                "actor": "110系统"
            },
            {
                "time": "2025-11-25T14:31:00Z",
                "type": "ai_analyzed",
                "description": "AI分析完成，评分0.88，自动确认",
                "data": {"confirmation_score": 0.88}
            },
            {
                "time": "2025-11-25T14:32:00Z",
                "type": "scheme_generated",
                "description": "方案生成完成",
                "data": {"scheme_id": "scheme-001"}
            },
            {
                "time": "2025-11-25T14:35:00Z",
                "type": "task_dispatched",
                "description": "任务派遣：搜救队A组出动",
                "data": {"task_id": "task-001"}
            },
            {
                "time": "2025-11-25T15:00:00Z",
                "type": "victim_rescued",
                "description": "救出被困人员5人",
                "data": {"rescued_count": 5}
            }
        ]
    }
}
```

---

### 5.11 获取关联事件

**GET** `/api/v2/events/{id}/related`

**响应体：**
```json
{
    "success": true,
    "data": {
        "parent_event": null,
        "child_events": [
            {
                "id": "event-child-1",
                "title": "次生火灾",
                "event_type": "fire",
                "status": "confirmed"
            }
        ],
        "nearby_events": [
            {
                "id": "event-nearby-1",
                "title": "相邻建筑受损",
                "distance_meters": 150,
                "status": "pending"
            }
        ],
        "merged_events": []
    }
}
```

---

## 六、错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| EV4001 | 404 | 事件不存在 |
| EV4002 | 409 | 事件状态不允许此操作 |
| EV4003 | 409 | 事件已被合并 |
| EV4004 | 400 | 想定不存在或未激活 |
| EV4005 | 409 | 存在进行中的任务，不可取消 |
| EV4006 | 409 | 预确认延长次数已达上限 |
| EV4007 | 400 | 批量操作部分失败 |

---

## 七、实现要点

### 7.1 预确认超时处理

使用定时任务检查pre_confirmed事件：

```python
@scheduler.cron("*/1 * * * *")  # 每分钟执行
async def check_pre_confirm_timeout():
    expired = await db.fetch_all(
        """
        SELECT id, priority FROM events_v2 
        WHERE status = 'pre_confirmed' 
        AND pre_confirm_expires_at < NOW()
        """
    )
    
    for event in expired:
        if event.priority == 'critical':
            # 紧急事件自动升级为confirmed
            await confirm_event(event.id, auto=True)
        else:
            # 非紧急事件取消，释放资源
            await cancel_event(event.id, reason="pre_confirm_timeout")
```

### 7.2 事件合并逻辑

```python
async def merge_events(primary_id: UUID, duplicate_id: UUID):
    async with db.transaction():
        # 更新被合并事件
        await db.execute(
            """
            UPDATE events_v2 
            SET status = 'cancelled', 
                merged_into_event_id = $1
            WHERE id = $2
            """,
            primary_id, duplicate_id
        )
        
        # 合并被困人员数据
        await db.execute(
            """
            UPDATE events_v2 
            SET estimated_victims = estimated_victims + (
                SELECT estimated_victims FROM events_v2 WHERE id = $2
            )
            WHERE id = $1
            """,
            primary_id, duplicate_id
        )
```

### 7.3 WebSocket推送

```python
# 事件状态变更时推送
await broadcaster.broadcast(
    channel="events",
    action="status_changed",
    data={
        "event_id": event.id,
        "scenario_id": event.scenario_id,
        "previous_status": "pending",
        "current_status": "confirmed"
    },
    scenario_id=event.scenario_id
)
```
