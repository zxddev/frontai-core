# 想定管理接口设计

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 优先级: P0

---

## 一、模块概述

想定（Scenario）是整个系统的顶层业务容器，代表一次应急事件的完整生命周期。所有事件、方案、任务、资源调度都必须关联到具体想定。

**核心功能：**
- 想定的创建、查询、更新、删除
- 想定状态流转管理
- 想定资源配置
- 想定环境参数配置
- 想定统计数据查询

---

## 二、数据库表

### 2.1 主表: operational_v2.scenarios_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| name | VARCHAR(200) | 想定名称，如"四川茂县6.8级地震想定" |
| scenario_type | VARCHAR(50) | 类型: earthquake/flood/fire/hazmat/landslide |
| response_level | VARCHAR(10) | 响应等级: I/II/III/IV |
| status | VARCHAR(20) | 状态: draft/preparing/active/paused/completed/archived |
| location | GEOGRAPHY(POINT) | 事发中心点 |
| affected_area | GEOGRAPHY(POLYGON) | 影响范围 |
| started_at | TIMESTAMPTZ | 事件发生时间 |
| ended_at | TIMESTAMPTZ | 事件结束时间 |
| parameters | JSONB | 想定参数(震级/降雨量等) |
| affected_population | INT | 预估影响人口 |
| affected_area_km2 | DECIMAL(10,2) | 影响面积(km²) |
| is_simulation | BOOLEAN | 是否为仿真想定 |
| created_by | VARCHAR(100) | 创建人 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

---

## 三、状态机

```
                    ┌──────────────┐
                    │    draft     │ 草稿
                    └──────┬───────┘
                           │ 提交准备
                           ↓
                    ┌──────────────┐
        ┌───────────│  preparing   │ 准备中（配置资源/环境）
        │           └──────┬───────┘
        │                  │ 启动
        │                  ↓
        │           ┌──────────────┐
        │      ┌───→│    active    │←───┐ 进行中
        │      │    └──────┬───────┘    │
        │      │           │            │
        │   恢复│     暂停 │            │恢复
        │      │           ↓            │
        │      │    ┌──────────────┐    │
        │      └────│    paused    │────┘ 已暂停
        │           └──────────────┘
        │                  │
        │ 取消             │ 完成
        ↓                  ↓
┌──────────────┐    ┌──────────────┐
│  cancelled   │    │  completed   │ 已完成
└──────────────┘    └──────┬───────┘
                           │ 归档
                           ↓
                    ┌──────────────┐
                    │   archived   │ 已归档
                    └──────────────┘
```

**状态说明：**
| 状态 | 说明 | 允许操作 |
|------|------|---------|
| draft | 草稿，可编辑基础信息 | 编辑、删除、提交准备 |
| preparing | 准备中，可配置资源和环境 | 编辑、配置资源、启动、取消 |
| active | 进行中，接收事件和执行任务 | 暂停、完成 |
| paused | 已暂停，保持数据但不接收新事件 | 恢复、完成 |
| completed | 已完成，只读 | 归档 |
| archived | 已归档，只读 | 无 |
| cancelled | 已取消 | 无 |

**业务规则：**
1. 同一时间只能有**1个active状态的真实想定**（非仿真）
2. 仿真想定（is_simulation=true）可以多个同时active
3. active状态的想定不可删除
4. 有进行中任务的想定不可完成

---

## 四、接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建想定 | POST | `/api/v2/scenarios` | 创建新想定 |
| 获取想定列表 | GET | `/api/v2/scenarios` | 分页查询 |
| 获取想定详情 | GET | `/api/v2/scenarios/{id}` | 获取单个想定 |
| 更新想定 | PUT | `/api/v2/scenarios/{id}` | 更新想定信息 |
| 删除想定 | DELETE | `/api/v2/scenarios/{id}` | 删除想定 |
| 想定状态流转 | POST | `/api/v2/scenarios/{id}/status` | 状态变更 |
| 配置初始资源 | POST | `/api/v2/scenarios/{id}/resources` | 配置资源 |
| 配置环境参数 | POST | `/api/v2/scenarios/{id}/environment` | 配置环境 |
| 获取想定统计 | GET | `/api/v2/scenarios/{id}/statistics` | 统计数据 |
| 复制想定 | POST | `/api/v2/scenarios/{id}/clone` | 复制想定 |

---

## 五、接口详细设计

### 5.1 创建想定

**POST** `/api/v2/scenarios`

**请求体：**
```json
{
    "name": "四川茂县6.8级地震想定",
    "scenario_type": "earthquake",
    "response_level": "II",
    "is_simulation": false,
    "location": {
        "longitude": 103.85,
        "latitude": 31.68
    },
    "affected_area": {
        "type": "Polygon",
        "coordinates": [[[103.8, 31.6], [103.9, 31.6], [103.9, 31.7], [103.8, 31.7], [103.8, 31.6]]]
    },
    "started_at": "2025-11-25T14:30:00+08:00",
    "parameters": {
        "magnitude": 6.8,
        "depth_km": 10,
        "intensity_max": "IX"
    },
    "affected_population": 85000,
    "affected_area_km2": 450.5
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "四川茂县6.8级地震想定",
        "scenario_type": "earthquake",
        "response_level": "II",
        "status": "draft",
        "is_simulation": false,
        "location": {
            "longitude": 103.85,
            "latitude": 31.68
        },
        "started_at": "2025-11-25T14:30:00+08:00",
        "created_at": "2025-11-25T10:00:00Z",
        "created_by": "user-001"
    },
    "message": "想定创建成功"
}
```

**错误码：**
| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| SC4001 | 400 | 参数校验失败 |
| SC4002 | 409 | 想定名称已存在 |
| SC4003 | 409 | 已存在进行中的真实想定 |

---

### 5.2 获取想定列表

**GET** `/api/v2/scenarios`

**查询参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | int | 否 | 页码，默认1 |
| page_size | int | 否 | 每页数量，默认20，最大100 |
| status | string | 否 | 状态过滤，多值逗号分隔 |
| scenario_type | string | 否 | 类型过滤 |
| is_simulation | bool | 否 | 是否仿真想定 |
| keyword | string | 否 | 关键词搜索(名称) |
| sort_by | string | 否 | 排序字段：created_at/updated_at/started_at |
| sort_order | string | 否 | asc/desc，默认desc |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "550e8400-e29b-41d4-a716-446655440000",
                "name": "四川茂县6.8级地震想定",
                "scenario_type": "earthquake",
                "response_level": "II",
                "status": "active",
                "is_simulation": false,
                "started_at": "2025-11-25T14:30:00+08:00",
                "event_count": 15,
                "task_count": 42,
                "created_at": "2025-11-25T10:00:00Z"
            }
        ],
        "pagination": {
            "page": 1,
            "page_size": 20,
            "total_items": 5,
            "total_pages": 1
        }
    }
}
```

---

### 5.3 获取想定详情

**GET** `/api/v2/scenarios/{id}`

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "四川茂县6.8级地震想定",
        "scenario_type": "earthquake",
        "response_level": "II",
        "status": "active",
        "is_simulation": false,
        "location": {
            "longitude": 103.85,
            "latitude": 31.68
        },
        "affected_area": {
            "type": "Polygon",
            "coordinates": [[[103.8, 31.6], [103.9, 31.6], [103.9, 31.7], [103.8, 31.7], [103.8, 31.6]]]
        },
        "started_at": "2025-11-25T14:30:00+08:00",
        "ended_at": null,
        "parameters": {
            "magnitude": 6.8,
            "depth_km": 10,
            "intensity_max": "IX",
            "aftershock_count": 45
        },
        "affected_population": 85000,
        "affected_area_km2": 450.5,
        "created_by": "user-001",
        "created_at": "2025-11-25T10:00:00Z",
        "updated_at": "2025-11-25T12:00:00Z"
    }
}
```

**错误码：**
| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| SC4004 | 404 | 想定不存在 |

---

### 5.4 更新想定

**PUT** `/api/v2/scenarios/{id}`

**请求体：** (与创建相同，只更新传入的字段)

**业务规则：**
- draft/preparing状态可修改所有字段
- active状态只能修改: name, affected_population, parameters
- completed/archived状态不可修改

**错误码：**
| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| SC4005 | 409 | 当前状态不允许修改 |

---

### 5.5 删除想定

**DELETE** `/api/v2/scenarios/{id}`

**业务规则：**
- 只有draft/cancelled状态可删除
- active/paused状态的想定不可删除
- 删除会级联删除所有关联数据（事件/方案/任务等）

**响应体：**
```json
{
    "success": true,
    "message": "想定删除成功"
}
```

**错误码：**
| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| SC4006 | 409 | 进行中的想定不可删除 |

---

### 5.6 想定状态流转

**POST** `/api/v2/scenarios/{id}/status`

**请求体：**
```json
{
    "action": "activate",
    "reason": "准备完成，启动救援"
}
```

**action枚举：**
| action | 当前状态 | 目标状态 | 说明 |
|--------|---------|---------|------|
| submit | draft | preparing | 提交准备 |
| activate | preparing | active | 启动 |
| pause | active | paused | 暂停 |
| resume | paused | active | 恢复 |
| complete | active/paused | completed | 完成 |
| archive | completed | archived | 归档 |
| cancel | draft/preparing | cancelled | 取消 |

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "previous_status": "preparing",
        "current_status": "active",
        "action": "activate",
        "reason": "准备完成，启动救援",
        "changed_at": "2025-11-25T12:00:00Z",
        "changed_by": "user-001"
    }
}
```

**错误码：**
| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| SC4007 | 409 | 状态流转不合法 |
| SC4008 | 409 | 已存在进行中的真实想定 |
| SC4009 | 409 | 存在未完成的任务，不可完成想定 |

---

### 5.7 配置初始资源

**POST** `/api/v2/scenarios/{id}/resources`

**请求体：**
```json
{
    "teams": [
        {"team_id": "team-001", "role": "主搜救力量"},
        {"team_id": "team-002", "role": "医疗救护"}
    ],
    "devices": [
        {"device_id": "uav-001"},
        {"device_id": "uav-002"}
    ],
    "vehicles": [
        {"vehicle_id": "vehicle-001"}
    ]
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
        "configured_teams": 2,
        "configured_devices": 2,
        "configured_vehicles": 1
    },
    "message": "资源配置成功"
}
```

**业务规则：**
- 只有preparing状态可配置资源
- 资源必须处于available状态

---

### 5.8 配置环境参数

**POST** `/api/v2/scenarios/{id}/environment`

**请求体：**
```json
{
    "weather": {
        "condition": "rainy",
        "temperature_celsius": 15,
        "visibility_km": 2,
        "wind_speed_ms": 8
    },
    "road_conditions": {
        "damaged_roads": ["road-001", "road-002"],
        "blocked_areas": [
            {"type": "Polygon", "coordinates": [...]}
        ]
    },
    "communication": {
        "coverage_percentage": 60,
        "satellite_available": true
    }
}
```

**响应体：**
```json
{
    "success": true,
    "message": "环境参数配置成功"
}
```

---

### 5.9 获取想定统计

**GET** `/api/v2/scenarios/{id}/statistics`

**响应体：**
```json
{
    "success": true,
    "data": {
        "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
        "events": {
            "total": 15,
            "by_status": {
                "pending": 2,
                "pre_confirmed": 1,
                "confirmed": 3,
                "executing": 5,
                "resolved": 4
            },
            "by_priority": {
                "critical": 3,
                "high": 5,
                "medium": 4,
                "low": 3
            }
        },
        "schemes": {
            "total": 8,
            "approved": 5,
            "pending_review": 2,
            "rejected": 1
        },
        "tasks": {
            "total": 42,
            "by_status": {
                "pending": 5,
                "assigned": 8,
                "in_progress": 15,
                "completed": 12,
                "failed": 2
            }
        },
        "resources": {
            "teams_deployed": 6,
            "devices_active": 12,
            "vehicles_in_use": 8
        },
        "casualties": {
            "rescued": 45,
            "injured": 30,
            "deaths": 5,
            "missing": 10
        },
        "timeline": {
            "started_at": "2025-11-25T14:30:00+08:00",
            "duration_hours": 12.5,
            "first_response_minutes": 8
        }
    }
}
```

---

### 5.10 复制想定

**POST** `/api/v2/scenarios/{id}/clone`

**请求体：**
```json
{
    "name": "四川茂县地震想定-演练副本",
    "is_simulation": true,
    "include_resources": true,
    "include_environment": true
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "new-scenario-uuid",
        "name": "四川茂县地震想定-演练副本",
        "status": "draft",
        "is_simulation": true,
        "cloned_from": "550e8400-e29b-41d4-a716-446655440000"
    },
    "message": "想定复制成功"
}
```

**业务规则：**
- 复制后的想定状态为draft
- 不复制事件/方案/任务数据
- 可选择是否复制资源配置和环境参数

---

## 六、实现要点

### 6.1 并发控制

```python
# 启动想定时检查是否已有active的真实想定
async def activate_scenario(scenario_id: UUID) -> None:
    async with db.transaction():
        # 加锁检查
        existing = await db.fetch_one(
            """
            SELECT id FROM scenarios_v2 
            WHERE status = 'active' AND is_simulation = false
            FOR UPDATE
            """
        )
        if existing:
            raise ConflictError("SC4008", "已存在进行中的真实想定")
        
        await db.execute(
            "UPDATE scenarios_v2 SET status = 'active' WHERE id = $1",
            scenario_id
        )
```

### 6.2 级联删除

删除想定时级联删除关联数据（事务内执行）：
1. events_v2
2. schemes_v2
3. tasks_v2
4. entities_v2 (scenario_id)
5. resource_dispatches_v2

### 6.3 WebSocket推送

状态变更时推送到 `scenarios` 频道：
```json
{
    "channel": "scenarios",
    "action": "status_changed",
    "data": {
        "scenario_id": "xxx",
        "previous_status": "preparing",
        "current_status": "active"
    }
}
```
