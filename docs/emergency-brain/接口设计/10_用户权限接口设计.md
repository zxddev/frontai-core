# 用户权限接口设计

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 优先级: P1

---

## 一、模块概述

用户权限模块管理系统用户、角色和权限。采用RBAC（基于角色的访问控制）模型。

**核心功能：**
- 用户管理（CRUD）
- 角色管理
- 权限分配
- 登录认证

---

## 二、角色-权限矩阵

| 角色 | 想定管理 | 事件管理 | 方案审批 | 任务派遣 | 资源管理 | 用户管理 |
|------|---------|---------|---------|---------|---------|---------|
| 系统管理员 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 指挥员 | 查看 | ✓ | ✓ | ✓ | 查看 | - |
| 调度员 | 查看 | ✓ | - | ✓ | ✓ | - |
| 执行者 | 查看 | 查看 | - | 接受/完成 | 查看 | - |
| 观察员 | 查看 | 查看 | 查看 | 查看 | 查看 | - |

---

## 三、数据库表

### 3.1 用户表: users_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| username | VARCHAR(50) | 用户名 |
| password_hash | VARCHAR(256) | 密码哈希 |
| name | VARCHAR(100) | 姓名 |
| phone | VARCHAR(20) | 手机号 |
| email | VARCHAR(100) | 邮箱 |
| role_id | UUID | 角色ID |
| status | VARCHAR(20) | active/disabled |
| last_login_at | TIMESTAMPTZ | 最后登录 |

### 3.2 角色表: roles_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| name | VARCHAR(50) | 角色名称 |
| code | VARCHAR(50) | 角色编码 |
| permissions | JSONB | 权限列表 |
| description | TEXT | 描述 |

---

## 四、接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 用户登录 | POST | `/api/v2/auth/login` | 登录 |
| 用户登出 | POST | `/api/v2/auth/logout` | 登出 |
| 刷新Token | POST | `/api/v2/auth/refresh` | 刷新 |
| 获取当前用户 | GET | `/api/v2/users/me` | 当前用户 |
| 修改密码 | PUT | `/api/v2/users/me/password` | 修改密码 |
| 创建用户 | POST | `/api/v2/users` | 创建 |
| 获取用户列表 | GET | `/api/v2/users` | 列表 |
| 获取用户详情 | GET | `/api/v2/users/{id}` | 详情 |
| 更新用户 | PUT | `/api/v2/users/{id}` | 更新 |
| 禁用用户 | POST | `/api/v2/users/{id}/disable` | 禁用 |

---

## 五、接口详细设计

### 5.1 用户登录

**POST** `/api/v2/auth/login`

**请求体：**
```json
{
    "username": "admin",
    "password": "<your-password>"
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "token_type": "Bearer",
        "expires_in": 3600,
        "user": {
            "id": "user-uuid",
            "username": "admin",
            "name": "管理员",
            "role": {
                "id": "role-uuid",
                "name": "系统管理员",
                "code": "admin"
            },
            "permissions": ["scenario:*", "event:*", "scheme:*"]
        }
    }
}
```

**错误码：**
| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| AU4001 | 401 | 用户名或密码错误 |
| AU4002 | 403 | 用户已禁用 |

---

### 5.2 获取当前用户

**GET** `/api/v2/users/me`

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "user-uuid",
        "username": "admin",
        "name": "管理员",
        "phone": "13800138000",
        "email": "admin@example.com",
        "role": {
            "id": "role-uuid",
            "name": "系统管理员",
            "code": "admin"
        },
        "permissions": ["scenario:*", "event:*", "scheme:*", "task:*", "resource:*", "user:*"],
        "last_login_at": "2025-11-25T10:00:00Z"
    }
}
```

---

### 5.3 创建用户

**POST** `/api/v2/users`

**请求体：**
```json
{
    "username": "operator001",
    "password": "initialPassword123",
    "name": "调度员张三",
    "phone": "13900139000",
    "email": "operator001@example.com",
    "role_id": "role-dispatcher-uuid"
}
```

**业务规则：**
- 用户名唯一
- 密码强度校验（8位以上，含数字和字母）
- 只有管理员可创建用户

---

## 六、错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| AU4001 | 401 | 认证失败 |
| AU4002 | 403 | 用户已禁用 |
| AU4003 | 403 | 权限不足 |
| AU4004 | 409 | 用户名已存在 |
| AU4005 | 400 | 密码强度不足 |

---

## 七、权限编码规范

```
格式: {module}:{action}

模块:
- scenario: 想定
- event: 事件
- scheme: 方案
- task: 任务
- resource: 资源
- user: 用户

动作:
- read: 查看
- create: 创建
- update: 修改
- delete: 删除
- approve: 审批
- *: 所有权限

示例:
- scenario:read - 查看想定
- scheme:approve - 审批方案
- user:* - 用户管理所有权限
```
