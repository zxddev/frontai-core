# 仿真模块接口设计

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 优先级: P2

---

## 一、模块概述

仿真模块提供演练和培训场景的模拟能力，支持历史想定回放、场景注入、演练评估等功能。

**核心功能：**
- 仿真场景管理
- 历史回放
- 场景注入
- 演练评估
- 时间控制

---

## 二、数据库表

### 2.1 仿真场景表: simulation_scenarios_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 关联想定 |
| name | VARCHAR(200) | 场景名称 |
| description | TEXT | 描述 |
| source_type | VARCHAR(50) | 来源: new/from_history |
| source_scenario_id | UUID | 历史想定ID |
| time_scale | DECIMAL(5,2) | 时间倍率 |
| start_simulation_time | TIMESTAMPTZ | 仿真起始时间 |
| status | VARCHAR(20) | ready/running/paused/completed |
| participants | JSONB | 参与人员 |

### 2.2 注入事件表: injected_events_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| simulation_id | UUID | 仿真场景ID |
| inject_time | TIMESTAMPTZ | 注入时间(仿真时间) |
| event_template | JSONB | 事件模板 |
| status | VARCHAR(20) | pending/injected |

### 2.3 演练评估表: drill_assessments_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| simulation_id | UUID | 仿真场景ID |
| overall_score | DECIMAL(5,2) | 总分 |
| response_time_score | DECIMAL(5,2) | 响应时间得分 |
| decision_score | DECIMAL(5,2) | 决策得分 |
| coordination_score | DECIMAL(5,2) | 协调得分 |
| details | JSONB | 详细评估 |

---

## 三、接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建仿真场景 | POST | `/api/v2/simulations` | 创建 |
| 获取仿真场景列表 | GET | `/api/v2/simulations` | 列表 |
| 获取仿真场景详情 | GET | `/api/v2/simulations/{id}` | 详情 |
| 启动仿真 | POST | `/api/v2/simulations/{id}/start` | 启动 |
| 暂停仿真 | POST | `/api/v2/simulations/{id}/pause` | 暂停 |
| 恢复仿真 | POST | `/api/v2/simulations/{id}/resume` | 恢复 |
| 停止仿真 | POST | `/api/v2/simulations/{id}/stop` | 停止 |
| 调整时间倍率 | PATCH | `/api/v2/simulations/{id}/time-scale` | 调速 |
| 注入事件 | POST | `/api/v2/simulations/{id}/inject` | 注入 |
| 获取注入队列 | GET | `/api/v2/simulations/{id}/inject-queue` | 队列 |
| 回放历史 | POST | `/api/v2/simulations/replay` | 回放 |
| 生成评估报告 | POST | `/api/v2/simulations/{id}/assessment` | 评估 |
| 获取评估报告 | GET | `/api/v2/simulations/{id}/assessment` | 报告 |

---

## 四、接口详细设计

### 4.1 创建仿真场景

**POST** `/api/v2/simulations`

**请求体：**
```json
{
    "name": "茂县地震救援演练",
    "description": "基于历史案例的演练场景",
    "source_type": "from_history",
    "source_scenario_id": "historical-scenario-uuid",
    "time_scale": 2.0,
    "participants": [
        {"user_id": "user-001", "role": "指挥员"},
        {"user_id": "user-002", "role": "调度员"}
    ],
    "inject_events": [
        {
            "relative_time_min": 30,
            "event_template": {
                "title": "次生滑坡",
                "event_type": "landslide",
                "priority": "high"
            }
        }
    ]
}
```

---

### 4.2 启动仿真

**POST** `/api/v2/simulations/{id}/start`

**响应体：**
```json
{
    "success": true,
    "data": {
        "simulation_id": "sim-uuid",
        "status": "running",
        "simulation_time": "2025-11-25T14:30:00Z",
        "real_start_time": "2025-11-25T10:00:00Z",
        "time_scale": 2.0,
        "created_scenario_id": "scenario-uuid"
    }
}
```

---

### 4.3 注入事件

**POST** `/api/v2/simulations/{id}/inject`

**请求体：**
```json
{
    "inject_immediately": true,
    "event": {
        "title": "紧急：余震发生",
        "event_type": "aftershock",
        "location": {"longitude": 103.85, "latitude": 31.68},
        "priority": "critical"
    }
}
```

---

### 4.4 调整时间倍率

**PATCH** `/api/v2/simulations/{id}/time-scale`

**请求体：**
```json
{
    "time_scale": 4.0
}
```

**业务规则：**
- 支持 0.5x ~ 10x 时间倍率
- 实时仿真为 1.0x

---

### 4.5 回放历史

**POST** `/api/v2/simulations/replay`

**请求体：**
```json
{
    "source_scenario_id": "historical-scenario-uuid",
    "start_from": "2025-11-25T14:30:00Z",
    "end_at": "2025-11-25T18:30:00Z",
    "include_events": true,
    "include_tasks": true,
    "include_entity_tracks": true
}
```

---

### 4.6 生成评估报告

**POST** `/api/v2/simulations/{id}/assessment`

**响应体：**
```json
{
    "success": true,
    "data": {
        "simulation_id": "sim-uuid",
        "assessment": {
            "overall_score": 85.5,
            "grades": {
                "response_time": {
                    "score": 90,
                    "detail": "首批救援力量15分钟内到达"
                },
                "decision_quality": {
                    "score": 82,
                    "detail": "方案选择合理，资源分配可优化"
                },
                "coordination": {
                    "score": 88,
                    "detail": "多队伍协同良好"
                },
                "resource_utilization": {
                    "score": 78,
                    "detail": "部分资源未充分利用"
                }
            },
            "timeline_analysis": [
                {
                    "time": "T+5min",
                    "event": "首次响应",
                    "evaluation": "优秀",
                    "benchmark": "标准要求T+15min"
                }
            ],
            "recommendations": [
                "建议增加后勤保障资源",
                "可优化搜救队伍调度顺序"
            ]
        }
    }
}
```

---

## 五、错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| SI4001 | 404 | 仿真场景不存在 |
| SI4002 | 409 | 仿真状态不允许此操作 |
| SI4003 | 400 | 无效的时间倍率 |
| SI4004 | 404 | 历史想定不存在 |

> 注：错误码前缀 SI = Simulation，避免与方案管理模块(SM = Scheme)冲突

---

## 六、实现要点

### 6.1 仿真时间管理

```python
class SimulationClock:
    def __init__(self, start_time: datetime, time_scale: float = 1.0):
        self.simulation_start = start_time
        self.real_start = datetime.now()
        self.time_scale = time_scale
        self._paused = False
        self._pause_offset = timedelta()
    
    @property
    def current_simulation_time(self) -> datetime:
        if self._paused:
            return self._pause_time
        
        real_elapsed = datetime.now() - self.real_start - self._pause_offset
        simulation_elapsed = real_elapsed * self.time_scale
        return self.simulation_start + simulation_elapsed
```

### 6.2 事件注入调度

```python
async def schedule_injections(simulation_id: UUID):
    """定时检查并注入预定事件"""
    injections = await get_pending_injections(simulation_id)
    clock = get_simulation_clock(simulation_id)
    
    for injection in injections:
        if clock.current_simulation_time >= injection.inject_time:
            await inject_event(simulation_id, injection)
            await mark_injection_completed(injection.id)
```
