# 应急救灾AI大脑 - 接口与集成业务流程

> 版本: 2.0  
> 更新时间: 2025-11-25

---

## 一、接口模块总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           接口与集成模块                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     数据接入层 (integrations/)                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ 灾情上报接口 │  │ 传感器告警  │  │ 设备遥测    │               │   │
│  │  │ disaster_    │  │ sensor_     │  │ telemetry   │               │   │
│  │  │ report       │  │ alert       │  │             │               │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘               │   │
│  │         │                 │                 │                       │   │
│  │         └─────────────────┼─────────────────┘                       │   │
│  │                           ↓                                         │   │
│  └───────────────────────────┼─────────────────────────────────────────┘   │
│                              │                                             │
│  ┌───────────────────────────┼─────────────────────────────────────────┐   │
│  │                     业务处理层 (domains/)                            │   │
│  │                           ↓                                         │   │
│  │  ┌──────────────────────────────────────────────────────────────┐  │   │
│  │  │  EventService → SchemeService → TaskService → AssignmentService │  │   │
│  │  └──────────────────────────────────────────────────────────────┘  │   │
│  └───────────────────────────┼─────────────────────────────────────────┘   │
│                              │                                             │
│  ┌───────────────────────────┼─────────────────────────────────────────┐   │
│  │                     实时推送层 (realtime/)                           │   │
│  │                           ↓                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ Broadcaster  │→│ WSManager    │→│  前端地图    │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     仿真模块 (simulation/) [独立]                    │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ 场景引擎     │  │ 数据生成器  │  │ 仿真控制API │               │   │
│  │  │ Engine       │  │ Generators  │  │ Router      │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、灾情上报接口完整业务流程

### 2.1 流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        灾情上报完整业务流程                                  │
└─────────────────────────────────────────────────────────────────────────────┘

第三方系统
    │
    │ POST /api/v2/integrations/disaster-report
    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. 请求校验                                                                  │
│    ├── API Key认证                                                          │
│    ├── 签名验证(可选)                                                        │
│    ├── 频率限制(详见下方限流配置)                                             │
│    └── 参数格式校验                                                          │
│                                                                             │
│    失败 → 返回 4xx 错误                                                      │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. 去重检查                                                                  │
│    ├── 来源去重: source_system + source_event_id                            │
│    └── 位置时间去重: 100m内 + 1小时内 + 相同类型                             │
│                                                                             │
│    重复 → 合并到已有事件 → 返回 duplicate_of                                 │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. 数据持久化                                                                │
│    ├── 创建 events_v2 记录 (status='pending')                               │
│    ├── 创建 entities_v2 地图实体 (type='event_point')                       │
│    └── 如有影响范围，创建 entities_v2 (type='event_range')                   │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. WebSocket推送 (同步)                                                      │
│    ├── 推送到 "events" 频道 → 前端事件列表刷新                               │
│    └── 推送到 "entities" 频道 → 前端地图显示新事件点                         │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. 返回响应                                                                  │
│    {success: true, event_id, event_code, status: "pending"}                 │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 6. AI分析 (异步任务) ⚠️ 关键：此步骤在HTTP响应后异步执行                      │
│    ├── 调用 POST /api/v2/ai/analyze-event → 返回 task_id                    │
│    ├── 触发 EventAnalysisAgent (后台异步执行，预计1-2秒完成)                 │
│    │   ├── 事件分类确认                                                      │
│    │   ├── 严重度评估 (I/II/III/IV)                                         │
│    │   ├── 影响范围估算                                                      │
│    │   ├── 次生灾害预测                                                      │
│    │   └── 生成分析摘要                                                      │
│    │                                                                        │
│    ├── 计算确认评分 (ConfirmationScorer)                                    │
│    │   ├── AI置信度 (权重0.6)                                               │
│    │   ├── 规则匹配度 (权重0.3)                                             │
│    │   └── 来源可信度 (权重0.1)                                             │
│    │                                                                        │
│    └── 结果通知方式 (二选一)                                                 │
│        ├── WebSocket推送到 "events" 频道 (推荐)                             │
│        └── 轮询 GET /api/v2/ai/analyze-event/{task_id} (备选)              │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 7. 事件确认分级处理                                                          │
│                                                                             │
│    评分 >= 0.85 且满足紧急条件                                               │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 自动确认                                                             │  │
│    │ ├── status → 'confirmed'                                            │  │
│    │ ├── auto_confirmed = true                                           │  │
│    │ ├── 记录到 ai_decision_logs_v2                                      │  │
│    │ ├── WebSocket通知指挥员"已自动确认，请复核"                          │  │
│    │ └── 自动触发方案生成                                                 │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│    0.6 <= 评分 < 0.85 或 优先级=critical/high                               │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 预确认                                                               │  │
│    │ ├── status → 'pre_confirmed'                                        │  │
│    │ ├── 启动资源预调度(锁定但不派出)                                     │  │
│    │ ├── 启动AI方案预生成(草案)                                          │  │
│    │ ├── 30分钟倒计时等待人工复核                                        │  │
│    │ │   ├── 人工确认 → confirmed → 执行预生成方案                       │  │
│    │ │   ├── 人工取消 → cancelled → 释放资源                             │  │
│    │ │   └── 超时且critical → 自动升级为confirmed                        │  │
│    │ └── WebSocket通知指挥员"预确认事件，请30分钟内复核"                  │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│    评分 < 0.6                                                               │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 待人工确认                                                           │  │
│    │ ├── status = 'pending'                                              │  │
│    │ └── WebSocket通知指挥员"新事件待确认"                                │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 自动确认硬规则

| 规则ID | 规则名称 | 触发条件 | 说明 |
|-------|---------|---------|------|
| AC-001 | 多源上报 | 同一位置(500m内)30分钟内≥2个不同来源上报 | 多源交叉验证 |
| AC-002 | 传感器AI双触发 | 传感器告警 且 AI置信度≥0.8 | 机器数据+AI一致 |
| AC-003 | 官方系统紧急 | 来源=110/119/120 且 标记紧急 | 官方系统可信 |
| AC-004 | 明确伤亡 | estimated_victims≥1 且 AI置信度≥0.7 | 人命关天 |

### 2.3 来源可信度配置

| 来源类型 | 可信度 | 示例 |
|---------|-------|------|
| 官方应急系统 | 0.95 | 110、119、120、应急管理局 |
| 政府业务系统 | 0.85 | 社区网格、城管系统 |
| 传感器系统 | 0.80 | 地震仪、水位计、烟感 |
| AI识别系统 | 0.70 | 无人机图像识别、视频分析 |
| 企业上报 | 0.60 | 工厂、商场等单位 |
| 群众上报 | 0.50 | 个人电话、APP上报 |

---

## 三、传感器告警接口业务流程

```
传感器系统
    │
    │ POST /api/v2/integrations/sensor-alert
    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. 请求校验 + 传感器身份验证                                                 │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. 告警级别判断                                                              │
│    ├── info → 仅记录，不创建事件                                            │
│    ├── warning → 创建事件(pending)，通知值班员                              │
│    └── critical → 创建事件 + 自动触发AI分析                                 │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. 关联已有事件检查                                                          │
│    ├── 如该传感器位置已有进行中事件 → 作为事件更新                           │
│    └── 无关联事件 → 创建新事件                                              │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. 数据持久化 + WebSocket推送 + AI分析(同灾情上报流程)                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、设备遥测接口业务流程

```
无人设备
    │
    │ POST /api/v2/integrations/telemetry
    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. 请求校验 (支持批量)                                                       │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. 遥测数据处理                                                              │
│    ├── location类型 → 更新设备位置                                          │
│    ├── battery类型 → 更新电量状态                                           │
│    ├── status类型 → 更新设备状态                                            │
│    └── sensor类型 → 处理传感器数据(可能触发告警)                             │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. 数据持久化                                                                │
│    ├── 写入 telemetry_v2 (分区表，按月)                                     │
│    └── 更新 entities_v2 实体位置 (realTime_uav等)                           │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. WebSocket推送                                                             │
│    ├── 推送到 "telemetry" 频道 → 前端设备面板更新                           │
│    └── 推送到 "entities" 频道 → 前端地图设备位置更新                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、实时推送模块设计

### 5.1 模块结构

```
src/realtime/
├── __init__.py
├── manager.py          # WebSocket连接管理器
├── broadcaster.py      # 广播器(业务层调用入口)
├── channels.py         # 频道定义与权限
└── router.py           # WebSocket路由
```

### 5.2 频道定义

| 频道 | 说明 | 数据来源 | 推送频率 |
|-----|------|---------|---------|
| events | 事件变更 | EventService | 事件触发 |
| entities | 地图实体变更 | EntityService | 事件触发 |
| tasks | 任务状态变更 | TaskService | 事件触发 |
| schemes | 方案变更 | SchemeService | 事件触发 |
| telemetry | 设备遥测 | TelemetryService | 1-5秒/次 |
| messages | 指挥消息 | MessageService | 事件触发 |
| alerts | 系统告警 | AlertService | 事件触发 |

### 5.3 推送流程

```
业务Service
    │
    │ await broadcaster.broadcast(channel, action, data)
    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ Broadcaster                                                                  │
│ ├── 构建消息: {channel, action, timestamp, data}                            │
│ ├── 权限过滤: 根据用户角色过滤敏感数据                                       │
│ └── 调用 WSManager.broadcast_to_channel()                                   │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ WSManager                                                                    │
│ ├── 查找订阅该频道的所有连接                                                 │
│ ├── 按scenario_id过滤(如有)                                                 │
│ └── 发送给每个符合条件的WebSocket连接                                        │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ↓
                            前端接收
```

---

## 六、仿真模块设计 (独立模块)

### 6.1 为什么独立？

| 原因 | 说明 |
|-----|------|
| **职责分离** | 仿真是测试/演练功能，不应与生产代码耦合 |
| **数据隔离** | 仿真数据不应污染生产数据 |
| **可控性** | 独立启停、速度控制、场景切换 |
| **安全性** | 生产环境可完全禁用仿真入口 |

### 6.2 模块结构

```
src/simulation/
├── __init__.py
├── engine.py               # 仿真引擎核心
├── clock.py                # 仿真时钟(可加速/暂停/跳转)
├── config.py               # 仿真配置
├── router.py               # 仿真控制API
│
├── scenarios/              # 预设场景
│   ├── __init__.py
│   ├── base.py             # 场景基类
│   ├── earthquake.py       # 地震场景
│   ├── flood.py            # 洪水场景
│   ├── fire.py             # 火灾场景
│   └── multi_disaster.py   # 复合灾害
│
└── generators/             # 数据生成器
    ├── __init__.py
    ├── event_generator.py      # 事件生成
    ├── telemetry_generator.py  # 遥测数据生成
    └── entity_generator.py     # 实体轨迹生成
```

### 6.3 仿真与生产的关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        仿真模块与生产系统的关系                              │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────┐
                    │      仿真引擎 (Engine)       │
                    │  ┌───────────────────────┐  │
                    │  │ 场景脚本 + 数据生成器  │  │
                    │  └───────────┬───────────┘  │
                    └──────────────┼──────────────┘
                                   │
                                   │ 生成仿真数据
                                   ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                          复用生产系统的Service层                             │
│                                                                             │
│    仿真数据 ──→ EventService.create_event(is_simulation=True)              │
│              ──→ EntityService.update_position(is_simulation=True)          │
│              ──→ TelemetryService.record(is_simulation=True)                │
│                                                                             │
│    标记 is_simulation=True，数据写入时:                                      │
│    ├── scenario_id 指向仿真想定                                             │
│    └── 数据不影响真实想定                                                    │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    │ 复用相同的广播器
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                          复用生产系统的Broadcaster                           │
│                                                                             │
│    EventService ──→ Broadcaster.broadcast("events", ...)                   │
│                                                                             │
│    前端订阅仿真想定的频道，收到仿真数据                                       │
│    前端订阅真实想定的频道，收到真实数据                                       │
│    两者互不干扰                                                              │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ↓
                               前端地图显示
```

### 6.4 仿真控制API

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/v2/simulation/start` | POST | 启动仿真 |
| `/api/v2/simulation/pause` | POST | 暂停仿真 |
| `/api/v2/simulation/resume` | POST | 恢复仿真 |
| `/api/v2/simulation/stop` | POST | 停止仿真 |
| `/api/v2/simulation/speed` | PUT | 调整时间倍速 |
| `/api/v2/simulation/inject-event` | POST | 手动注入事件 |
| `/api/v2/simulation/status` | GET | 获取仿真状态 |

### 6.5 仿真场景示例 (地震)

```python
class EarthquakeScenario(BaseScenario):
    """地震场景仿真"""
    
    def __init__(self, config):
        self.epicenter = config["epicenter"]      # 震中
        self.magnitude = config["magnitude"]      # 震级
        self.depth_km = config["depth_km"]        # 震源深度
        
    async def run(self, engine: SimulationEngine):
        # 阶段1: 主震发生 (T+0)
        await engine.inject_event({
            "disaster_type": "earthquake_epicenter",
            "location": self.epicenter,
            "properties": {"magnitude": self.magnitude, "depth": self.depth_km}
        })
        
        # 阶段2: 建筑倒塌报告 (T+5分钟 ~ T+30分钟)
        for i in range(5):
            await engine.wait_minutes(5)
            location = self.random_location_within_radius(self.epicenter, 10)
            await engine.inject_event({
                "disaster_type": "building_collapse",
                "location": location,
                "estimated_victims": random.randint(1, 10)
            })
        
        # 阶段3: 次生灾害 (T+30分钟后)
        await engine.wait_minutes(30)
        # 火灾
        await engine.inject_event({
            "disaster_type": "fire",
            "location": self.random_location_within_radius(self.epicenter, 5),
            "source": "earthquake_secondary"
        })
        
        # 阶段4: 持续余震 (每小时1-3次)
        while engine.is_running:
            await engine.wait_hours(1)
            aftershock_count = random.randint(1, 3)
            for _ in range(aftershock_count):
                await engine.inject_event({
                    "disaster_type": "earthquake_secondary",
                    "location": self.random_location_within_radius(self.epicenter, 20),
                    "properties": {"magnitude": self.magnitude - random.uniform(1, 2)}
                })
```

---

## 七、模块关系总结

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              模块关系图                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  integrations/  │     │  simulation/    │     │    前端系统      │
│  (数据接入)      │     │  (仿真模块)      │     │                 │
│                 │     │    [独立]        │     │                 │
│ • disaster_report     │ • engine         │     │                 │
│ • sensor_alert  │     │ • scenarios      │     │                 │
│ • telemetry     │     │ • generators     │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       ↑
         │                       │                       │
         ↓                       ↓                       │
┌─────────────────────────────────────────────┐         │
│              domains/ (业务服务层)           │         │
│                                             │         │
│  EventService ──→ SchemeService ──→ TaskService       │
│       │                │               │    │         │
│       ↓                ↓               ↓    │         │
│  [数据库持久化: events_v2, schemes_v2, tasks_v2]      │
│                                             │         │
└─────────────────────────┬───────────────────┘         │
                          │                             │
                          ↓                             │
┌─────────────────────────────────────────────┐         │
│              realtime/ (实时推送层)          │         │
│                                             │         │
│  Broadcaster ──→ WSManager ─────────────────┼─────────┘
│                                             │
└─────────────────────────────────────────────┘

关键点:
1. integrations/ 和 simulation/ 都通过 domains/ 处理数据
2. domains/ 统一调用 realtime/ 进行推送
3. simulation/ 是独立模块，但复用 domains/ 和 realtime/
4. 前端通过 WebSocket 订阅，按 scenario_id 区分真实/仿真数据
```

---

## 八、配置示例

### 8.1 来源可信度配置

```yaml
# config/integrations/source_trust.yaml
source_trust_levels:
  official_emergency:
    pattern: "^(110|119|120|emergency-bureau)$"
    trust_score: 0.95
    auto_confirm_threshold: 0.80
    
  government:
    pattern: "^(community-grid|city-management)$"
    trust_score: 0.85
    auto_confirm_threshold: 0.85
    
  sensor:
    pattern: "^sensor-.*$"
    trust_score: 0.80
    auto_confirm_threshold: 0.80
    
  ai_detection:
    pattern: "^ai-.*$"
    trust_score: 0.70
    auto_confirm_threshold: 0.85
    
  public:
    pattern: ".*"
    trust_score: 0.50
    auto_confirm_threshold: 0.90
```

### 8.2 接口限流配置

```yaml
# config/integrations/rate_limits.yaml
rate_limits:
  # 灾情上报接口 - 按来源系统限流
  disaster_report:
    default: 100/minute            # 默认限制
    by_source:
      official_emergency: 500/minute  # 官方系统较高限额
      sensor: 300/minute              # 传感器系统
      public: 50/minute               # 公众上报
    burst_limit: 20                   # 突发请求上限
    
  # 传感器告警接口
  sensor_alert:
    default: 500/minute
    burst_limit: 50
    
  # 设备遥测接口 - 按消息条数计算
  telemetry:
    max_messages_per_minute: 10000    # 总消息数限制 (支持100+设备×60次/分钟)
    max_per_device_per_minute: 120    # 单设备限制
    batch_max_size: 100               # 单次批量上报最大条数
    burst_limit: 500                  # 突发限制
    
  # AI接口
  ai_analyze:
    default: 60/minute
    concurrent_limit: 10              # 同时处理任务数
```

### 8.3 仿真场景配置

```yaml
# config/simulation/scenarios.yaml
scenarios:
  earthquake_level3:
    name: "III级地震演练"
    type: "earthquake"
    params:
      epicenter: [104.0657, 30.5728]
      magnitude: 5.5
      depth_km: 10
    events_timeline:
      - time: 0
        type: "earthquake_epicenter"
      - time: 5
        type: "building_collapse"
        count: 3
      - time: 30
        type: "fire"
        probability: 0.3
        
  flood_warning:
    name: "洪涝预警演练"
    type: "flood"
    params:
      river: "岷江"
      water_level_start: 8.5
      water_level_peak: 12.0
      rise_rate_m_per_hour: 0.5
```

---

## 九、异步任务处理与容错机制

### 9.1 同步/异步边界说明

| 步骤 | 执行模式 | 说明 |
|------|---------|------|
| 1-5 | **同步** | 请求校验→去重→持久化→WebSocket推送→返回响应 |
| 6-7 | **异步** | AI分析→确认评分→状态流转，HTTP响应已返回 |

**关键时序**:
```
T+0ms    第三方系统发起请求
T+50ms   步骤1-4完成(校验/去重/持久化/推送)
T+80ms   步骤5返回HTTP响应 {event_id, status: "pending"}
T+100ms  步骤6异步启动AI分析
T+1500ms 步骤6完成，步骤7状态流转
T+1550ms WebSocket推送分析结果和新状态
```

### 9.2 异步任务失败处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AI分析任务失败处理策略                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  任务执行超时 (>30秒)                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 标记任务状态为 timeout                                            │   │
│  │ 2. 事件保持 pending 状态，不自动流转                                  │   │
│  │ 3. WebSocket通知: "AI分析超时，请人工处理"                            │   │
│  │ 4. 记录错误日志到 ai_decision_logs_v2                                │   │
│  │ 5. 加入重试队列 (最多重试3次，间隔1分钟)                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  算法执行异常                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 捕获异常，记录堆栈到日志                                          │   │
│  │ 2. 返回降级结果:                                                     │   │
│  │    - ai_confidence = 0.5 (中性值)                                    │   │
│  │    - recommended_status = "pending"                                  │   │
│  │    - rationale = "AI分析异常，建议人工确认"                           │   │
│  │ 3. WebSocket通知: "AI分析异常，请人工处理"                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  pre_confirmed超时未处理                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 30分钟倒计时结束时:                                                   │   │
│  │ IF priority = critical:                                              │   │
│  │    → 自动升级为 confirmed，执行预生成方案                            │   │
│  │ ELSE:                                                                │   │
│  │    → 状态改为 cancelled，释放预锁定资源                               │   │
│  │ 记录决策日志，WebSocket通知                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.3 事务边界与补偿机制

**写入操作事务边界**:

| 操作 | 事务范围 | 说明 |
|------|---------|------|
| 灾情上报 | events_v2 + entities_v2 | 同一事务，原子写入 |
| AI分析完成 | events_v2.status + ai_decision_logs_v2 | 同一事务 |
| 方案生成 | schemes_v2 + scheme_resource_allocations_v2 | 同一事务 |
| 任务调度 | tasks_v2 + task_assignments_v2 + planned_routes_v2 | 同一事务 |

**跨服务补偿策略 (SAGA模式)**:

```
方案执行流程补偿链:
┌─────────────────────────────────────────────────────────────────┐
│ 1. 方案审批通过 (schemes_v2.status = approved)                   │
│    ↓ 成功                                                       │
│ 2. 任务创建 (tasks_v2)                                          │
│    ↓ 成功                                                       │
│ 3. 资源锁定 (teams_v2.status = assigned)                        │
│    ↓ 失败! 资源已被其他任务占用                                  │
│                                                                 │
│ 补偿执行:                                                        │
│    3' 无需补偿 (未成功写入)                                      │
│    2' 任务标记为 failed，记录失败原因                            │
│    1' 方案标记为 resource_conflict，通知重新分配                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.4 幂等性保证

| 接口 | 幂等Key | 处理方式 |
|------|--------|---------|
| 灾情上报 | source_system + source_event_id | 返回已存在事件ID |
| AI分析 | event_id | 同一事件只允许一个运行中的分析任务 |
| 方案生成 | event_id + generation_mode | 返回已生成的方案 |
| 任务分配 | task_id + assignee_id | 返回已存在的分配记录 |
