# 地图实体接口设计

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 优先级: P1

---

## 一、模块概述

地图实体（Entity）是地图上显示的各类对象，包括灾情点、救援队伍位置、设备位置、避难所、医院等。

**实体类型：**
- disaster_point: 灾情点
- rescue_team: 救援队伍
- vehicle: 车辆
- uav: 无人机
- shelter: 避难所
- hospital: 医院
- command_post: 指挥所
- hazard_zone: 危险区域

---

## 二、数据库表

### 2.1 实体表: entities_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定 |
| entity_type | VARCHAR(50) | 实体类型 |
| name | VARCHAR(200) | 名称 |
| location | GEOGRAPHY(POINT) | 位置 |
| geometry | GEOGRAPHY | 几何形状(点/线/面) |
| properties | JSONB | 属性 |
| style | JSONB | 样式(图标/颜色) |
| reference_id | UUID | 关联对象ID |
| reference_type | VARCHAR(50) | 关联对象类型 |
| is_visible | BOOLEAN | 是否显示 |
| z_index | INT | 层级 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

### 2.2 历史轨迹表: entity_tracks_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| entity_id | UUID | 实体ID |
| location | GEOGRAPHY(POINT) | 位置 |
| speed_kmh | DECIMAL | 速度 |
| heading | INT | 朝向(0-360) |
| recorded_at | TIMESTAMPTZ | 记录时间 |

---

## 三、接口列表

### 3.1 实体管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建实体 | POST | `/api/v2/entities` | 创建 |
| 获取实体列表 | GET | `/api/v2/entities` | 分页查询 |
| 获取实体详情 | GET | `/api/v2/entities/{id}` | 单个详情 |
| 更新实体 | PUT | `/api/v2/entities/{id}` | 更新 |
| 删除实体 | DELETE | `/api/v2/entities/{id}` | 删除 |
| 批量更新位置 | PATCH | `/api/v2/entities/batch-location` | 批量位置 |
| 更新实体位置 | PATCH | `/api/v2/entities/{id}/location` | 单个位置 |
| 获取历史轨迹 | GET | `/api/v2/entities/{id}/tracks` | 历史轨迹 |
| 获取区域内实体 | GET | `/api/v2/entities/in-bounds` | 区域查询 |
| 获取附近实体 | GET | `/api/v2/entities/nearby` | 附近查询 |
| 切换可见性 | PATCH | `/api/v2/entities/{id}/visibility` | 显示/隐藏 |

### 3.2 态势标绘

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 态势标绘 | POST | `/api/v2/entities/plot` | 创建标绘图形 |

### 3.3 图层管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取图层列表 | GET | `/api/v2/layers` | 获取图层配置 |
| 更新图层配置 | PUT | `/api/v2/layers/{id}` | 更新图层 |

---

## 四、接口详细设计

### 4.1 获取实体列表

**GET** `/api/v2/entities`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |
| entity_types | string | 类型过滤，逗号分隔 |
| is_visible | bool | 是否显示 |
| bbox | string | 边界框 minLng,minLat,maxLng,maxLat |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "entity-uuid",
                "entity_type": "disaster_point",
                "name": "凤仪镇倒塌点",
                "location": {"longitude": 103.851, "latitude": 31.682},
                "properties": {
                    "event_id": "event-uuid",
                    "priority": "critical",
                    "status": "executing"
                },
                "style": {
                    "icon": "disaster-building",
                    "color": "#FF0000"
                }
            }
        ],
        "total": 50
    }
}
```

---

### 4.2 批量更新位置

**PATCH** `/api/v2/entities/batch-location`

**请求体：**
```json
{
    "updates": [
        {
            "entity_id": "entity-001",
            "location": {"longitude": 103.852, "latitude": 31.683},
            "speed_kmh": 25,
            "heading": 45
        },
        {
            "entity_id": "entity-002",
            "location": {"longitude": 103.855, "latitude": 31.680}
        }
    ]
}
```

**业务规则：**
- 自动记录轨迹
- 触发WebSocket推送

---

### 4.3 获取历史轨迹

**GET** `/api/v2/entities/{id}/tracks`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| start_time | string | 开始时间 |
| end_time | string | 结束时间 |
| sample_interval | int | 采样间隔(秒) |

**响应体：**
```json
{
    "success": true,
    "data": {
        "entity_id": "entity-uuid",
        "tracks": [
            {
                "location": {"longitude": 103.850, "latitude": 31.680},
                "speed_kmh": 30,
                "heading": 45,
                "recorded_at": "2025-11-25T14:00:00Z"
            },
            {
                "location": {"longitude": 103.851, "latitude": 31.681},
                "speed_kmh": 25,
                "heading": 50,
                "recorded_at": "2025-11-25T14:05:00Z"
            }
        ],
        "total_distance_km": 1.5,
        "duration_min": 30
    }
}
```

---

### 4.4 获取区域内实体

**GET** `/api/v2/entities/in-bounds`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |
| bounds | string | 边界 minLng,minLat,maxLng,maxLat |
| entity_types | string | 类型过滤 |

---

### 4.5 获取附近实体

**GET** `/api/v2/entities/nearby`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |
| center | string | 中心点 lng,lat |
| radius_km | number | 半径(公里) |
| entity_types | string | 类型过滤 |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "entity-uuid",
                "entity_type": "hospital",
                "name": "茂县人民医院",
                "distance_km": 2.5,
                "location": {"longitude": 103.86, "latitude": 31.69}
            }
        ]
    }
}
```

---

### 4.6 态势标绘

**POST** `/api/v2/entities/plot`

**请求体：**
```json
{
    "scenario_id": "scenario-uuid",
    "plot_type": "polygon",
    "name": "危险区域A",
    "geometry": {
        "type": "Polygon",
        "coordinates": [[[103.84, 31.67], [103.87, 31.67], [103.87, 31.70], [103.84, 31.70], [103.84, 31.67]]]
    },
    "style": {
        "fill_color": "#FF000033",
        "stroke_color": "#FF0000",
        "stroke_width": 2,
        "label": "危险区域"
    },
    "properties": {
        "hazard_type": "collapse_risk",
        "warning_level": "high"
    },
    "layer_id": "layer-hazard"
}
```

**plot_type枚举：**
- `point`: 点标注
- `polyline`: 线段/路径
- `polygon`: 多边形区域
- `circle`: 圆形区域
- `arrow`: 箭头(方向指示)
- `text`: 文字标注

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "entity-uuid",
        "plot_type": "polygon",
        "name": "危险区域A",
        "created_at": "2025-11-25T15:00:00Z"
    }
}
```

---

### 4.7 获取图层列表

**GET** `/api/v2/layers`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |

**响应体：**
```json
{
    "success": true,
    "data": {
        "layers": [
            {
                "id": "layer-events",
                "name": "灾情点图层",
                "entity_types": ["disaster_point"],
                "is_visible": true,
                "z_index": 100,
                "min_zoom": 8,
                "max_zoom": 18,
                "style": {
                    "cluster_enabled": true,
                    "cluster_radius": 50
                }
            },
            {
                "id": "layer-teams",
                "name": "救援队伍图层",
                "entity_types": ["rescue_team"],
                "is_visible": true,
                "z_index": 90
            },
            {
                "id": "layer-hazard",
                "name": "危险区域图层",
                "entity_types": ["hazard_zone"],
                "is_visible": true,
                "z_index": 50
            },
            {
                "id": "layer-routes",
                "name": "路线图层",
                "entity_types": ["route"],
                "is_visible": true,
                "z_index": 40
            }
        ]
    }
}
```

---

### 4.8 更新图层配置

**PUT** `/api/v2/layers/{id}`

**请求体：**
```json
{
    "is_visible": false,
    "z_index": 80,
    "style": {
        "cluster_enabled": false
    }
}
```

---

## 五、错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| EN4001 | 404 | 实体不存在 |
| EN4002 | 400 | 无效的坐标 |
| EN4003 | 400 | 无效的几何形状 |
| EN4004 | 409 | 实体类型与引用不匹配 |
| EN4005 | 404 | 图层不存在 |
| EN4006 | 400 | 不支持的标绘类型 |
