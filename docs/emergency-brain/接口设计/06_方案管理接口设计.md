# 方案管理接口设计

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 优先级: P0

---

## 一、模块概述

方案（Scheme）是针对事件生成的救援执行计划，包含任务分解、资源分配、执行时序等。方案可由AI自动生成或人工手动创建，需经审批后执行。

**核心功能：**
- 方案创建（手动/AI生成）
- 方案审批流程
- 资源分配管理
- 方案版本与比较

---

## 二、数据库表

### 2.1 主表: schemes_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| event_id | UUID | 关联事件 |
| scenario_id | UUID | 所属想定 |
| scheme_code | VARCHAR(50) | 方案编号 |
| name | VARCHAR(200) | 方案名称 |
| scheme_type | VARCHAR(50) | 类型: overall/frontline/reconnaissance |
| status | scheme_status_v2 | 状态 |
| version | INT | 版本号 |
| is_ai_generated | BOOLEAN | 是否AI生成 |
| ai_confidence | DECIMAL(5,4) | AI置信度 |
| description | TEXT | 方案描述 |
| objectives | JSONB | 方案目标 |
| tasks_summary | JSONB | 任务摘要 |
| resource_summary | JSONB | 资源摘要 |
| estimated_duration_min | INT | 预估时长 |
| estimated_cost | DECIMAL(12,2) | 预估成本 |
| rationale | TEXT | AI推荐理由 |
| submitted_at | TIMESTAMPTZ | 提交时间 |
| submitted_by | UUID | 提交人 |
| approved_at | TIMESTAMPTZ | 审批时间 |
| approved_by | UUID | 审批人 |
| rejection_reason | TEXT | 驳回原因 |

### 2.2 资源分配表: scheme_resource_allocations_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scheme_id | UUID | 方案ID |
| task_name | VARCHAR(200) | 任务名称 |
| resource_id | UUID | 资源ID |
| resource_type | VARCHAR(50) | team/device/vehicle |
| resource_name | VARCHAR(200) | 资源名称 |
| role | VARCHAR(100) | 角色 |
| ai_score | DECIMAL(5,2) | AI评分 |
| ai_rank | INT | AI排名 |
| ai_rationale | TEXT | AI推荐理由 |
| is_human_modified | BOOLEAN | 是否人工修改 |
| modification_reason | TEXT | 修改原因 |
| original_resource_id | UUID | 原推荐资源 |

---

## 三、状态机

```
┌────────┐  提交  ┌────────────────┐  通过  ┌──────────┐
│ draft  │──────→│ pending_review │──────→│ approved │
└────────┘       └───────┬────────┘       └────┬─────┘
                        │                     │
                   驳回 │                     │ 执行
                        ↓                     ↓
                 ┌──────────┐          ┌──────────┐
                 │ rejected │          │executing │
                 └──────────┘          └────┬─────┘
                                            │
                        ┌───────────────────┼───────────────────┐
                        │                   │                   │
                        ↓                   ↓                   ↓
                 ┌──────────┐        ┌──────────┐        ┌──────────┐
                 │completed │        │superseded│        │cancelled │
                 └──────────┘        └──────────┘        └──────────┘
```

**状态说明：**

| 状态 | 说明 | 触发条件 |
|------|------|---------|
| draft | 草稿，可编辑 | 创建方案时 |
| pending_review | 待审批 | 提交审批时 |
| approved | 已审批通过 | 审批通过时 |
| rejected | 已驳回 | 审批驳回时 |
| executing | 执行中 | 方案开始执行时 |
| completed | 已完成 | 所有任务完成时 |
| superseded | 已被替代 | 同一事件的新方案被审批通过，旧方案自动标记为superseded |
| cancelled | 已取消 | 人工取消执行中的方案 |

**superseded状态使用场景：**
1. 灾情发生变化，需要生成新方案替代当前执行方案
2. 指挥员认为当前方案不合理，审批新方案后旧方案自动废弃
3. 同一事件只能有一个active方案（approved或executing状态）
4. superseded方案的进行中任务会被标记为cancelled，已完成任务保留记录

---

## 四、接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建方案 | POST | `/api/v2/schemes` | 手动创建 |
| AI生成方案 | POST | `/api/v2/schemes/generate` | AI生成 |
| 获取方案列表 | GET | `/api/v2/schemes` | 分页查询 |
| 获取方案详情 | GET | `/api/v2/schemes/{id}` | 单个详情 |
| 更新方案 | PUT | `/api/v2/schemes/{id}` | 更新 |
| 提交审批 | POST | `/api/v2/schemes/{id}/submit` | 提交 |
| 审批通过 | POST | `/api/v2/schemes/{id}/approve` | 通过 |
| 审批驳回 | POST | `/api/v2/schemes/{id}/reject` | 驳回 |
| 获取资源分配 | GET | `/api/v2/schemes/{id}/allocations` | 资源分配 |
| 修改资源分配 | PUT | `/api/v2/schemes/{id}/allocations/{alloc_id}` | 修改分配 |
| 获取修改历史 | GET | `/api/v2/schemes/{id}/history` | 历史记录 |
| 方案比较 | POST | `/api/v2/schemes/compare` | 比较方案 |
| 获取方案任务 | GET | `/api/v2/schemes/{id}/tasks` | 任务列表 |

---

## 五、接口详细设计

### 5.1 创建方案（手动）

**POST** `/api/v2/schemes`

**请求体：**
```json
{
    "event_id": "event-uuid",
    "name": "凤仪镇建筑救援方案",
    "scheme_type": "overall",
    "description": "针对凤仪镇居民楼倒塌的综合救援方案",
    "objectives": {
        "primary": "72小时内完成所有被困人员搜救",
        "secondary": ["伤员救治", "次生灾害防控"]
    },
    "tasks": [
        {
            "name": "废墟搜救",
            "required_capabilities": ["废墟搜救", "生命探测"],
            "priority": 1
        },
        {
            "name": "伤员救治",
            "required_capabilities": ["现场急救"],
            "priority": 1
        }
    ],
    "resource_allocations": [
        {
            "task_name": "废墟搜救",
            "resource_id": "team-001",
            "resource_type": "team",
            "role": "主搜救力量"
        }
    ]
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "id": "scheme-uuid",
        "scheme_code": "SCH-20251125-0001",
        "name": "凤仪镇建筑救援方案",
        "status": "draft",
        "is_ai_generated": false,
        "created_at": "2025-11-25T15:00:00Z"
    }
}
```

---

### 5.2 AI生成方案

**POST** `/api/v2/schemes/generate`

> 详见 02_AI_Agent接口设计.md，此处为简化版

**请求体：**
```json
{
    "event_id": "event-uuid",
    "scheme_type": "overall",
    "constraints": {
        "max_response_time_min": 30,
        "max_teams": 10
    },
    "options": {
        "generate_alternatives": 3
    }
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "schemes": [
            {
                "id": "scheme-001",
                "name": "快速响应方案",
                "score": 0.92,
                "is_ai_generated": true,
                "ai_confidence": 0.92,
                "rationale": "..."
            }
        ],
        "recommended_scheme_id": "scheme-001"
    }
}
```

---

### 5.3 获取方案列表

**GET** `/api/v2/schemes`

**查询参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| scenario_id | UUID | 是 | 想定ID |
| event_id | UUID | 否 | 事件ID |
| status | string | 否 | 状态过滤 |
| scheme_type | string | 否 | 类型过滤 |
| is_ai_generated | bool | 否 | 是否AI生成 |

---

### 5.4 提交审批

**POST** `/api/v2/schemes/{id}/submit`

**请求体：**
```json
{
    "comment": "请审批该救援方案"
}
```

**业务规则：**
- 只有draft状态可提交
- 提交前校验资源分配完整性

---

### 5.5 审批通过

**POST** `/api/v2/schemes/{id}/approve`

**请求体：**
```json
{
    "comment": "方案合理，同意执行"
}
```

**业务规则：**
- 只有pending_review状态可审批
- 通过后自动触发任务创建
- 审批人需要有审批权限

---

### 5.6 修改资源分配

**PUT** `/api/v2/schemes/{id}/allocations/{alloc_id}`

**请求体：**
```json
{
    "new_resource_id": "team-002",
    "reason": "原推荐队伍正在执行其他任务"
}
```

**业务规则：**
- 只有draft/rejected状态可修改
- 必须提供修改原因
- 记录原推荐资源用于审计

---

### 5.7 方案比较

**POST** `/api/v2/schemes/compare`

**请求体：**
```json
{
    "scheme_ids": ["scheme-001", "scheme-002"]
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "schemes": [
            {"id": "scheme-001", "name": "快速响应方案"},
            {"id": "scheme-002", "name": "稳健方案"}
        ],
        "comparison": {
            "response_time": {"scheme-001": 12, "scheme-002": 18},
            "coverage_rate": {"scheme-001": 0.95, "scheme-002": 0.98},
            "resource_count": {"scheme-001": 5, "scheme-002": 8},
            "estimated_cost": {"scheme-001": 150000, "scheme-002": 200000}
        },
        "recommendation": "scheme-001",
        "recommendation_reason": "在满足救援需求的前提下响应更快"
    }
}
```

---

## 六、错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| SM4001 | 404 | 方案不存在 |
| SM4002 | 409 | 方案状态不允许此操作 |
| SM4003 | 403 | 无审批权限 |
| SM4004 | 400 | 资源分配不完整 |
| SM4005 | 409 | 资源已被其他方案占用 |

---

## 七、实现要点

### 7.1 方案审批后自动创建任务

```python
async def approve_scheme(scheme_id: UUID, approver: UUID):
    async with db.transaction():
        # 更新方案状态
        await update_scheme_status(scheme_id, "approved", approver)
        
        # 创建任务
        scheme = await get_scheme_with_allocations(scheme_id)
        for task_def in scheme.tasks_summary:
            task = await create_task(
                scheme_id=scheme_id,
                name=task_def["name"],
                required_capabilities=task_def["required_capabilities"]
            )
            
            # 创建任务分配
            for alloc in scheme.allocations:
                if alloc.task_name == task_def["name"]:
                    await create_task_assignment(task.id, alloc.resource_id)
```
