# 任务管理接口设计

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 优先级: P0

---

## 一、模块概述

任务（Task）是方案执行的最小单元，代表一个具体的救援行动。任务分配给执行者（队伍/设备）后进行执行跟踪。

**核心功能：**
- 任务创建与管理
- 任务分配与接受
- 任务执行跟踪
- 子任务管理
- 任务重分配

---

## 二、数据库表

### 2.1 主表: tasks_v2 (task_requirements_v2)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| scenario_id | UUID | 所属想定 |
| scheme_id | UUID | 关联方案 |
| parent_task_id | UUID | 父任务ID |
| task_code | VARCHAR(50) | 任务编号 |
| task_name | VARCHAR(200) | 任务名称 |
| task_type | VARCHAR(50) | 类型: rescue/search/medical/engineering |
| status | task_status_v2 | 状态 |
| priority | VARCHAR(20) | 优先级 |
| location | GEOGRAPHY(POINT) | 任务位置 |
| location_address | VARCHAR(300) | 地址 |
| required_capabilities | VARCHAR(50)[] | 所需能力 |
| min_personnel | INT | 最少人数 |
| min_vehicles | INT | 最少车辆 |
| deadline_at | TIMESTAMPTZ | 截止时间 |
| expected_duration_min | INT | 预计时长 |
| actual_start_at | TIMESTAMPTZ | 实际开始时间 |
| actual_end_at | TIMESTAMPTZ | 实际结束时间 |
| progress_percentage | INT | 进度百分比 |
| result | JSONB | 执行结果 |

### 2.2 分配表: task_assignments_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| task_id | UUID | 任务ID |
| assignee_id | UUID | 执行者ID |
| assignee_type | VARCHAR(50) | team/device |
| assignee_name | VARCHAR(200) | 执行者名称 |
| status | VARCHAR(20) | assigned/accepted/rejected/completed |
| assigned_at | TIMESTAMPTZ | 分配时间 |
| accepted_at | TIMESTAMPTZ | 接受时间 |
| rejection_reason | TEXT | 拒绝原因 |

### 2.3 路线表: planned_routes_v2

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| task_id | UUID | 任务ID |
| assignment_id | UUID | 分配ID |
| route_mode | VARCHAR(20) | road/offroad |
| waypoints | JSONB | 路径点 |
| distance_meters | INT | 距离 |
| estimated_time_min | INT | 预计时间 |

---

## 三、状态机

```
┌─────────┐  分配  ┌──────────┐  接受  ┌──────────┐  开始  ┌─────────────┐
│ created │──────→│ assigned │──────→│ accepted │──────→│ in_progress │
└─────────┘       └────┬─────┘       └────┬─────┘       └──────┬──────┘
                      │                  │                    │
                 拒绝 │             拒绝 │                    │
                      ↓                  ↓                    │
                ┌──────────┐                                  │
                │ rejected │←────────────────────────────────┘ 失败
                └──────────┘                                  │
                                                              │ 完成
                                                              ↓
                                                       ┌──────────┐
                                                       │completed │
                                                       └──────────┘
```

---

## 四、接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建任务 | POST | `/api/v2/tasks` | 创建任务 |
| 获取任务列表 | GET | `/api/v2/tasks` | 分页查询 |
| 获取我的任务 | GET | `/api/v2/tasks/my-tasks` | 我的任务 |
| 获取任务详情 | GET | `/api/v2/tasks/{id}` | 单个详情 |
| 更新任务 | PUT | `/api/v2/tasks/{id}` | 更新 |
| 分配任务 | POST | `/api/v2/tasks/{id}/assign` | 分配 |
| 接受任务 | POST | `/api/v2/tasks/{id}/accept` | 接受 |
| 拒绝任务 | POST | `/api/v2/tasks/{id}/reject` | 拒绝 |
| 开始执行 | POST | `/api/v2/tasks/{id}/start` | 开始 |
| 更新进度 | PATCH | `/api/v2/tasks/{id}/progress` | 更新进度 |
| 完成任务 | POST | `/api/v2/tasks/{id}/complete` | 完成 |
| 任务失败 | POST | `/api/v2/tasks/{id}/fail` | 标记失败 |
| 重新分配 | POST | `/api/v2/tasks/{id}/reassign` | 重分配 |
| 上报异常 | POST | `/api/v2/tasks/{id}/report-issue` | 上报问题 |
| 获取子任务 | GET | `/api/v2/tasks/{id}/subtasks` | 子任务 |
| 获取路线 | GET | `/api/v2/tasks/{id}/route` | 规划路线 |

---

## 五、接口详细设计

### 5.1 创建任务

**POST** `/api/v2/tasks`

**请求体：**
```json
{
    "scenario_id": "scenario-uuid",
    "scheme_id": "scheme-uuid",
    "task_name": "废墟搜救",
    "task_type": "rescue",
    "priority": "critical",
    "location": {"longitude": 103.851, "latitude": 31.682},
    "location_address": "茂县凤仪镇幸福路12号",
    "required_capabilities": ["废墟搜救", "生命探测"],
    "min_personnel": 10,
    "deadline_at": "2025-11-25T18:30:00+08:00",
    "expected_duration_min": 240
}
```

---

### 5.2 获取我的任务

**GET** `/api/v2/tasks/my-tasks`

**查询参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| scenario_id | UUID | 想定ID |
| status | string | 状态过滤 |

**响应体：**
```json
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "task-uuid",
                "task_code": "TASK-001",
                "task_name": "废墟搜救",
                "status": "in_progress",
                "priority": "critical",
                "location_address": "茂县凤仪镇幸福路12号",
                "deadline_at": "2025-11-25T18:30:00+08:00",
                "minutes_until_deadline": 120,
                "progress_percentage": 30,
                "my_role": "主搜救力量"
            }
        ]
    }
}
```

---

### 5.3 分配任务

**POST** `/api/v2/tasks/{id}/assign`

**请求体：**
```json
{
    "assignments": [
        {
            "assignee_id": "team-001",
            "assignee_type": "team",
            "role": "主搜救力量"
        },
        {
            "assignee_id": "uav-001",
            "assignee_type": "device",
            "role": "空中侦察"
        }
    ],
    "notify": true
}
```

**响应体：**
```json
{
    "success": true,
    "data": {
        "task_id": "task-uuid",
        "assignments": [
            {
                "id": "assignment-001",
                "assignee_id": "team-001",
                "status": "assigned",
                "route": {
                    "distance_meters": 2800,
                    "estimated_time_min": 8
                }
            }
        ]
    }
}
```

---

### 5.4 接受任务

**POST** `/api/v2/tasks/{id}/accept`

**请求体：**
```json
{
    "estimated_arrival_min": 10,
    "comment": "收到，立即出发"
}
```

---

### 5.5 拒绝任务

**POST** `/api/v2/tasks/{id}/reject`

**请求体：**
```json
{
    "reason": "正在执行其他紧急任务，无法响应"
}
```

**业务规则：**
- 拒绝后触发重新分配流程
- 记录拒绝原因

---

### 5.6 更新进度

**PATCH** `/api/v2/tasks/{id}/progress`

**请求体：**
```json
{
    "progress_percentage": 50,
    "status_description": "已搜索3层，发现被困人员2人",
    "rescued_count": 2,
    "current_location": {"longitude": 103.852, "latitude": 31.683}
}
```

---

### 5.7 完成任务

**POST** `/api/v2/tasks/{id}/complete`

**请求体：**
```json
{
    "result": {
        "rescued_count": 15,
        "injured_count": 8,
        "casualties": 2,
        "summary": "共救出被困人员15人，其中8人受伤送医"
    }
}
```

---

### 5.8 重新分配

**POST** `/api/v2/tasks/{id}/reassign`

**请求体：**
```json
{
    "previous_assignee_id": "team-001",
    "new_assignee_id": "team-002",
    "reason": "原执行者遇到障碍无法继续"
}
```

---

### 5.9 上报异常

**POST** `/api/v2/tasks/{id}/report-issue`

**请求体：**
```json
{
    "issue_type": "obstacle",
    "description": "道路塌陷，无法通行",
    "location": {"longitude": 103.850, "latitude": 31.680},
    "severity": "high",
    "request_support": true
}
```

---

### 5.10 获取规划路线

**GET** `/api/v2/tasks/{id}/route`

**响应体：**
```json
{
    "success": true,
    "data": {
        "task_id": "task-uuid",
        "primary_route": {
            "mode": "road",
            "distance_meters": 2800,
            "estimated_time_min": 8,
            "waypoints": [
                {"lng": 103.845, "lat": 31.675, "name": "起点"},
                {"lng": 103.848, "lat": 31.678, "name": "途经点"},
                {"lng": 103.851, "lat": 31.682, "name": "目标点"}
            ],
            "road_conditions": [
                {"segment": "0-1", "status": "normal"},
                {"segment": "1-2", "status": "damaged", "note": "需减速"}
            ]
        },
        "alternative_route": {
            "mode": "offroad",
            "distance_meters": 3500,
            "estimated_time_min": 15,
            "reason": "备用路线，道路全损时使用"
        }
    }
}
```

---

## 六、错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| TK4001 | 404 | 任务不存在 |
| TK4002 | 409 | 任务状态不允许此操作 |
| TK4003 | 409 | 任务已分配 |
| TK4004 | 403 | 非任务执行者 |
| TK4005 | 409 | 存在未完成的子任务 |

---

## 七、实现要点

### 7.1 任务分配后自动规划路线

```python
async def assign_task(task_id: UUID, assignments: List[Assignment]):
    async with db.transaction():
        task = await get_task(task_id)
        
        for assignment in assignments:
            # 创建分配记录
            await create_assignment(task_id, assignment)
            
            # 规划路线
            assignee = await get_resource(assignment.assignee_id)
            route = await plan_route(
                from_location=assignee.current_location,
                to_location=task.location
            )
            await save_route(task_id, assignment.id, route)
            
            # 发送通知
            await notify_assignee(assignment.assignee_id, task)
```

### 7.2 任务完成后更新事件统计

```python
async def complete_task(task_id: UUID, result: TaskResult):
    async with db.transaction():
        task = await update_task_status(task_id, "completed", result)
        
        # 更新事件救援统计
        if result.rescued_count:
            await db.execute(
                """
                UPDATE events_v2 
                SET rescued_count = rescued_count + $1
                WHERE id = (SELECT event_id FROM schemes_v2 WHERE id = $2)
                """,
                result.rescued_count, task.scheme_id
            )
```
