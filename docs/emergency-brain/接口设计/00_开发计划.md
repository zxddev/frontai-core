# 应急救灾AI大脑 - 开发计划

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 核心目标: 以操作手册业务流程为主线

---

## 一、开发原则

1. **想定 = 一次救援行动**（不是复杂的多想定切换）
2. **仿真模块暂不开发**（用真实数据流程测试）
3. **devices遥测 = 模拟数据**（后期接入真实设备）
4. **先跑通流程，再优化AI**

---

## 二、开发阶段总览

| 阶段 | 目标 | 周期 |
|------|------|------|
| P0 | 基础数据 + 核心流程骨架 | 第1-2周 |
| P1 | 完整业务流程 | 第3-4周 |
| P2 | AI能力集成 | 第5-6周 |
| P3 | 优化完善 | 持续 |

---

## 三、P0阶段 - 基础数据与流程骨架

### 3.1 数据库表（必须先建）

```sql
-- 核心表
scenarios_v2        -- 救援行动
vehicles_v2         -- 车辆
teams_v2            -- 队伍
devices_v2          -- 无人设备（接收模拟数据）
rescue_points_v2    -- 救援点
tasks_v2            -- 任务
entities_v2         -- 地图实体（位置聚合）
```

### 3.2 基础接口

#### 3.2.1 scenarios（救援行动）
| 接口 | 方法 | 路径 | 优先 |
|------|------|------|------|
| 创建救援行动 | POST | `/api/v2/scenarios` | ✓ |
| 获取详情 | GET | `/api/v2/scenarios/{id}` | ✓ |
| 状态切换 | POST | `/api/v2/scenarios/{id}/status` | ✓ |
| 列表查询 | GET | `/api/v2/scenarios` | ✓ |

**状态简化**: draft → active → completed

#### 3.2.2 vehicles（车辆）
| 接口 | 方法 | 路径 | 优先 |
|------|------|------|------|
| 创建车辆 | POST | `/api/v2/vehicles` | ✓ |
| 列表查询 | GET | `/api/v2/vehicles` | ✓ |
| 获取详情 | GET | `/api/v2/vehicles/{id}` | ✓ |
| 更新位置 | PATCH | `/api/v2/vehicles/{id}/location` | ✓ |
| 更新状态 | PATCH | `/api/v2/vehicles/{id}/status` | ✓ |

#### 3.2.3 teams（队伍）
| 接口 | 方法 | 路径 | 优先 |
|------|------|------|------|
| 创建队伍 | POST | `/api/v2/teams` | ✓ |
| 列表查询 | GET | `/api/v2/teams` | ✓ |
| 获取详情 | GET | `/api/v2/teams/{id}` | ✓ |
| 更新位置 | PATCH | `/api/v2/teams/{id}/location` | ✓ |
| 更新状态 | PATCH | `/api/v2/teams/{id}/status` | ✓ |

#### 3.2.4 devices（无人设备 - 接收模拟数据）
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建设备 | POST | `/api/v2/devices` | ✓ |
| 列表查询 | GET | `/api/v2/devices` | ✓ |
| 获取详情 | GET | `/api/v2/devices/{id}` | ✓ |
| **接收遥测** | POST | `/api/v2/devices/{id}/telemetry` | 模拟器调用 |
| 更新状态 | PATCH | `/api/v2/devices/{id}/status` | ✓ |

**遥测数据格式**（模拟器发送）:
```json
{
    "timestamp": "2025-11-25T14:30:00Z",
    "location": {"longitude": 103.851, "latitude": 31.682, "altitude_m": 50},
    "battery_level": 75,
    "speed_kmh": 35,
    "heading": 45,
    "status": "flying"
}
```

### 3.3 WebSocket基础

| 频道 | 推送内容 |
|------|---------|
| entities | 位置更新（vehicles/teams/devices统一推送） |
| scenarios | 救援行动状态变更 |

### 3.4 P0验收标准

- [ ] 能创建一个救援行动
- [ ] 能录入车辆、队伍、设备基础数据
- [ ] 模拟器发送遥测数据，系统能接收并存储
- [ ] WebSocket能推送位置更新

---

## 四、P1阶段 - 完整业务流程

### 4.1 阶段一：应急准备

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 接收通报 | POST | `/api/v2/notifications/incident` | 创建救援行动 |
| 下发准备任务 | POST | `/api/v2/preparation/tasks` | 车辆装备准备 |
| 提交准备完成 | POST | `/api/v2/preparation/tasks/{id}/complete` | 各车反馈 |
| 下发出发指令 | POST | `/api/v2/commands/depart` | 开始机动 |

### 4.2 阶段二：机动前出

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 路径规划 | POST | `/api/v2/navigation/route` | 生成路线 |
| 切换路线 | PUT | `/api/v2/navigation/route` | 备选路线 |
| 安全点确认 | POST | `/api/v2/navigation/safe-point` | 到达安全点 |

### 4.3 阶段三：灾情侦察

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 确认指挥所 | POST | `/api/v2/command-post/confirm` | 建立指挥所 |
| 新增救援点 | POST | `/api/v2/rescue-points` | 发现灾情点 |
| 确认救援点 | POST | `/api/v2/rescue-points/confirm` | 确认AI识别 |
| 救援点列表 | GET | `/api/v2/rescue-points` | 查询 |

### 4.4 阶段四：救援指挥

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 救援点一张图 | GET | `/api/v2/rescue-points/overview` | 全局态势 |
| 创建任务 | POST | `/api/v2/tasks` | 派遣任务 |
| 任务列表 | GET | `/api/v2/tasks` | 查询 |
| 我的任务 | GET | `/api/v2/tasks/my-tasks` | 执行者视角 |
| 接受任务 | POST | `/api/v2/tasks/{id}/accept` | 执行者确认 |
| 更新进度 | PATCH | `/api/v2/tasks/{id}/progress` | 进度反馈 |
| 完成任务 | POST | `/api/v2/tasks/{id}/complete` | 任务完成 |

### 4.5 P1验收标准

- [ ] 能走通完整的救援流程（接收通报→准备→出发→侦察→救援→完成）
- [ ] 救援点能创建、查询、状态更新
- [ ] 任务能派遣、接受、完成
- [ ] 地图能显示实时位置

---

## 五、P2阶段 - AI能力集成

### 5.1 AI接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| AI装备建议 | GET | `/api/v2/ai/equipment-suggestion` | 推荐装备 |
| AI路径规划 | POST | `/api/v2/ai/route-planning` | 智能路线 |
| AI指挥所推荐 | GET | `/api/v2/ai/command-post-recommendation` | 推荐位置 |
| AI救援点识别 | POST | `/api/v2/ai/rescue-point-detection` | 图像识别 |
| AI方案生成 | POST | `/api/v2/ai/generate-scheme` | 救援方案 |
| 风险预测 | GET | `/api/v2/risk/prediction` | 行进风险 |

### 5.2 AI集成方式

```
P1阶段: 接口先返回Mock数据，流程能跑通
P2阶段: 接入真实AI算法
```

### 5.3 P2验收标准

- [ ] AI能根据灾情推荐装备
- [ ] AI能生成救援方案
- [ ] AI能识别救援点（图像输入）

---

## 六、暂不开发

| 模块 | 原因 |
|------|------|
| 仿真模块(14) | 用真实流程测试 |
| 用户权限(10) | 先单用户跑通 |
| 评估报告(阶段五) | 流程跑通后再加 |
| 协调联络 | 非核心流程 |

---

## 七、测试数据模拟

### 7.1 设备遥测模拟器

```python
# 示例：每5秒发送一次位置更新
import requests
import time
import random

def simulate_device(device_id, start_location):
    lat, lng = start_location
    while True:
        lat += random.uniform(-0.001, 0.001)
        lng += random.uniform(-0.001, 0.001)
        
        requests.post(f"/api/v2/devices/{device_id}/telemetry", json={
            "timestamp": datetime.now().isoformat(),
            "location": {"longitude": lng, "latitude": lat, "altitude_m": 100},
            "battery_level": random.randint(60, 100),
            "speed_kmh": random.randint(20, 40),
            "status": "flying"
        })
        time.sleep(5)
```

### 7.2 车辆位置模拟器

```python
# 模拟车辆沿路线移动
def simulate_vehicle_movement(vehicle_id, route_points):
    for point in route_points:
        requests.patch(f"/api/v2/vehicles/{vehicle_id}/location", json={
            "longitude": point["lng"],
            "latitude": point["lat"],
            "speed_kmh": 60
        })
        time.sleep(10)
```

---

## 八、开发顺序Checklist

### Week 1-2 (P0)
- [ ] 数据库表创建
- [ ] scenarios CRUD
- [ ] vehicles CRUD + 位置
- [ ] teams CRUD + 位置
- [ ] devices CRUD + 遥测接收
- [ ] WebSocket基础推送
- [ ] 位置模拟器脚本

### Week 3-4 (P1)
- [ ] 通报接收 → 准备任务流程
- [ ] 路径规划接口
- [ ] 救援点管理
- [ ] 任务派遣与执行
- [ ] 救援点一张图

### Week 5-6 (P2)
- [ ] AI装备建议
- [ ] AI方案生成
- [ ] AI救援点识别
- [ ] 风险预测
