# 应急救灾AI大脑 - API接口开发清单

> 版本: 1.0  
> 创建时间: 2025-11-25  
> 状态: 规划中

---

## 一、接口开发总览

| 模块 | 接口数量 | 优先级 | 状态 |
|------|---------|--------|------|
| 第三方数据接入 | 5 | P0 | 待开发 |
| 想定管理 | 8 | P0 | 待开发 |
| 事件管理 | 12 | P0 | 待开发 |
| 方案管理 | 10 | P0 | 待开发 |
| 任务管理 | 10 | P0 | 待开发 |
| 资源管理 | 15 | P1 | 待开发 |
| AI Agent接口 | 6 | P1 | 待开发 |
| WebSocket推送 | 7 | P0 | 待开发 |
| 仿真模块 | 8 | P2 | 待开发 |
| 用户与权限 | 6 | P1 | 待开发 |
| 操作手册业务接口 | 20 | P1 | 待开发 |

**总计: 约107个接口**

---

## 二、第三方数据接入接口 (P0)

### 2.1 灾情上报接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 灾情上报 | POST | `/api/v2/integrations/disaster-report` | 接收110/社区/AI识别系统灾情 |
| 传感器告警 | POST | `/api/v2/integrations/sensor-alert` | 接收IoT传感器数据 |
| 设备遥测 | POST | `/api/v2/integrations/telemetry` | 接收无人机/机器狗实时数据 |
| 天气数据 | POST | `/api/v2/integrations/weather` | 接收气象数据和预警 |
| 回调通知 | POST | `/api/v2/integrations/callback` | 外部系统回调 |

### 2.2 接口实现要点

```python
# 灾情上报接口核心逻辑
1. API Key认证 + 签名验证(可选)
2. 频率限制(100次/分钟)
3. 去重检查(来源去重 + 位置时间去重)
4. 数据持久化(events_v2 + entities_v2)
5. WebSocket推送
6. 异步触发AI分析
```

---

## 三、想定管理接口 (P0)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建想定 | POST | `/api/v2/scenarios` | 创建新想定 |
| 获取想定列表 | GET | `/api/v2/scenarios` | 分页查询想定 |
| 获取想定详情 | GET | `/api/v2/scenarios/{id}` | 获取单个想定 |
| 更新想定 | PUT | `/api/v2/scenarios/{id}` | 更新想定信息 |
| 删除想定 | DELETE | `/api/v2/scenarios/{id}` | 删除想定 |
| 想定状态流转 | POST | `/api/v2/scenarios/{id}/status` | preparing→active→completed→archived |
| 配置初始资源 | POST | `/api/v2/scenarios/{id}/resources` | 配置想定资源 |
| 配置环境参数 | POST | `/api/v2/scenarios/{id}/environment` | 配置天气/道路/通信 |

---

## 四、事件管理接口 (P0)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建事件 | POST | `/api/v2/events` | 手动创建事件 |
| 获取事件列表 | GET | `/api/v2/events` | 分页查询事件 |
| 获取事件详情 | GET | `/api/v2/events/{id}` | 获取单个事件 |
| 更新事件 | PUT | `/api/v2/events/{id}` | 更新事件信息 |
| 确认事件 | POST | `/api/v2/events/{id}/confirm` | pending/pre_confirmed→confirmed |
| 取消事件 | POST | `/api/v2/events/{id}/cancel` | 标记为误报 |
| 升级事件 | POST | `/api/v2/events/{id}/escalate` | 升级处理 |
| 获取待复核事件 | GET | `/api/v2/events/pending-review` | 查询pre_confirmed状态事件 |
| 延长复核时间 | POST | `/api/v2/events/{id}/extend-review` | 延长30分钟倒计时 |
| 关闭事件 | POST | `/api/v2/events/{id}/resolve` | 标记已解决 |
| 获取事件更新记录 | GET | `/api/v2/events/{id}/updates` | 事件更新历史 |
| 添加事件更新 | POST | `/api/v2/events/{id}/updates` | 添加更新记录 |
| 获取事件关联方案 | GET | `/api/v2/events/{id}/schemes` | 获取关联方案 |
| 批量确认事件 | POST | `/api/v2/events/batch-confirm` | 批量确认 |

### 事件状态机

```
pending ─────────────────→ confirmed → planning → executing → resolved
   │                           ↑           ↓
   ├→ pre_confirmed ──────────┘        escalated
   │      │ (30分钟倒计时)
   │      └→ cancelled (人工取消/超时未确认)
   │
   └→ cancelled (误报)

状态说明:
- pending: 待人工确认 (AI评分<0.6)
- pre_confirmed: 预确认 (0.6≤AI评分<0.85)，启动资源预调度，30分钟倒计时
- confirmed: 已确认 (AI评分≥0.85自动确认 或 人工确认)
- planning: 方案生成中
- executing: 救援执行中
- resolved: 已解决
- escalated: 已升级
- cancelled: 已取消
```

---

## 五、方案管理接口 (P0)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建方案 | POST | `/api/v2/schemes` | 手动创建方案 |
| AI生成方案 | POST | `/api/v2/schemes/generate` | AI自动生成方案 |
| 获取方案列表 | GET | `/api/v2/schemes` | 分页查询方案 |
| 获取方案详情 | GET | `/api/v2/schemes/{id}` | 获取单个方案 |
| 更新方案 | PUT | `/api/v2/schemes/{id}` | 更新方案信息 |
| 提交审批 | POST | `/api/v2/schemes/{id}/submit` | draft→pending_review |
| 审批通过 | POST | `/api/v2/schemes/{id}/approve` | pending_review→approved |
| 审批驳回 | POST | `/api/v2/schemes/{id}/reject` | 返回修改 |
| 获取资源分配 | GET | `/api/v2/schemes/{id}/allocations` | 获取资源分配详情 |
| 修改资源分配 | PUT | `/api/v2/schemes/{id}/allocations/{alloc_id}` | 人工修改资源(需记录原因) |

### 方案状态机

```
draft → pending_review → approved → executing → completed
              ↓                         ↓
           rejected                 superseded
```

---

## 六、任务管理接口 (P0)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建任务 | POST | `/api/v2/tasks` | 创建任务 |
| 获取任务列表 | GET | `/api/v2/tasks` | 分页查询任务 |
| 获取任务详情 | GET | `/api/v2/tasks/{id}` | 获取单个任务 |
| 更新任务 | PUT | `/api/v2/tasks/{id}` | 更新任务信息 |
| 分配任务 | POST | `/api/v2/tasks/{id}/assign` | 分配给执行者 |
| 接受任务 | POST | `/api/v2/tasks/{id}/accept` | 执行者接受 |
| 拒绝任务 | POST | `/api/v2/tasks/{id}/reject` | 执行者拒绝 |
| 开始执行 | POST | `/api/v2/tasks/{id}/start` | 开始执行 |
| 完成任务 | POST | `/api/v2/tasks/{id}/complete` | 标记完成 |
| 获取子任务 | GET | `/api/v2/tasks/{id}/subtasks` | 获取子任务列表 |

### 任务状态机

```
created → assigned → accepted → in_progress → completed
             ↓          ↓            ↓
          rejected   rejected      failed
```

---

## 七、资源管理接口 (P1)

### 7.1 救援队伍

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建队伍 | POST | `/api/v2/teams` | 创建救援队伍 |
| 获取队伍列表 | GET | `/api/v2/teams` | 查询队伍 |
| 获取队伍详情 | GET | `/api/v2/teams/{id}` | 获取单个队伍 |
| 更新队伍 | PUT | `/api/v2/teams/{id}` | 更新队伍信息 |
| 更新队伍状态 | PATCH | `/api/v2/teams/{id}/status` | 更新状态(空闲/执行中) |

### 7.2 无人设备

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建设备 | POST | `/api/v2/devices` | 创建无人设备 |
| 获取设备列表 | GET | `/api/v2/devices` | 查询设备 |
| 获取设备详情 | GET | `/api/v2/devices/{id}` | 获取单个设备 |
| 更新设备 | PUT | `/api/v2/devices/{id}` | 更新设备信息 |
| 更新设备状态 | PATCH | `/api/v2/devices/{id}/status` | 更新状态 |

### 7.3 物资装备

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建物资 | POST | `/api/v2/supplies` | 创建物资 |
| 获取物资列表 | GET | `/api/v2/supplies` | 查询物资 |
| 更新物资库存 | PATCH | `/api/v2/supplies/{id}/stock` | 更新库存 |

### 7.4 安置点

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建安置点 | POST | `/api/v2/shelters` | 创建安置点 |
| 获取安置点列表 | GET | `/api/v2/shelters` | 查询安置点 |
| 更新安置点容量 | PATCH | `/api/v2/shelters/{id}/capacity` | 更新容量 |

---

## 八、AI Agent接口 (P1)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 事件分析(异步) | POST | `/api/v2/ai/analyze-event` | EventAnalysisAgent，返回task_id |
| 查询分析任务状态 | GET | `/api/v2/ai/analyze-event/{task_id}` | 查询异步分析任务状态和结果 |
| 方案生成 | POST | `/api/v2/ai/generate-scheme` | SchemeGenerationAgent，支持scheme_type参数区分类型 |
| 资源匹配 | POST | `/api/v2/ai/match-resources` | ResourceMatchingAgent |
| 任务调度 | POST | `/api/v2/ai/dispatch-tasks` | TaskDispatchAgent |
| AI问答 | POST | `/api/v2/ai/chat` | 通用AI助手 |
| 获取AI决策日志 | GET | `/api/v2/ai/decision-logs` | 查询AI决策记录 |

### AI接口同步/异步说明

| 接口 | 模式 | 说明 |
|------|------|------|
| analyze-event | **异步** | 返回task_id，通过WebSocket推送结果或轮询查询 |
| generate-scheme | 同步 | 预期响应<5s，超时降级返回次优方案 |
| match-resources | 同步 | 预期响应<500ms |
| dispatch-tasks | 同步 | 预期响应<3s |
| chat | 同步/流式 | 支持stream参数控制 |

---

## 九、WebSocket推送接口 (P0)

### 9.1 连接端点

```
WebSocket: wss://api.example.com/ws/v2/realtime
```

### 9.2 频道订阅

| 频道 | 说明 | 推送时机 |
|------|------|---------|
| events | 事件变更 | 事件创建/更新/状态变更 |
| entities | 地图实体变更 | 实体创建/位置更新 |
| tasks | 任务状态变更 | 任务创建/分配/状态变更 |
| schemes | 方案变更 | 方案创建/审批状态变更 |
| telemetry | 设备遥测 | 1-5秒推送一次 |
| messages | 指挥消息 | 消息发送时 |
| alerts | 系统告警 | 告警触发时 |

### 9.3 消息格式

```json
{
    "channel": "events",
    "action": "created",
    "timestamp": "2025-11-25T10:31:00Z",
    "data": { ... }
}
```

---

## 十、仿真模块接口 (P2)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 启动仿真 | POST | `/api/v2/simulation/start` | 启动仿真场景 |
| 暂停仿真 | POST | `/api/v2/simulation/pause` | 暂停仿真 |
| 恢复仿真 | POST | `/api/v2/simulation/resume` | 恢复仿真 |
| 停止仿真 | POST | `/api/v2/simulation/stop` | 停止仿真 |
| 调整速度 | PUT | `/api/v2/simulation/speed` | 调整时间倍速 |
| 注入事件 | POST | `/api/v2/simulation/inject-event` | 手动注入事件 |
| 获取状态 | GET | `/api/v2/simulation/status` | 获取仿真状态 |
| 获取场景列表 | GET | `/api/v2/simulation/scenarios` | 预设场景列表 |

---

## 十一、用户与权限接口 (P1)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 用户登录 | POST | `/api/v2/auth/login` | 用户登录 |
| 用户登出 | POST | `/api/v2/auth/logout` | 用户登出 |
| 获取当前用户 | GET | `/api/v2/auth/me` | 获取当前用户信息 |
| 刷新Token | POST | `/api/v2/auth/refresh` | 刷新访问令牌 |
| 获取用户列表 | GET | `/api/v2/users` | 管理员查询用户 |
| 获取角色权限 | GET | `/api/v2/roles/{role}/permissions` | 获取角色权限 |

---

## 十二、操作手册业务接口 (P1)

根据操作手册，需要支持以下业务场景：

### 12.1 应急响应与准备

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 接收突发事件通报 | POST | `/api/v2/notifications/incident` | 接收后方通报 |
| AI装备建议 | GET | `/api/v2/ai/equipment-suggestion` | AI推荐装备物资 |
| 下发准备任务 | POST | `/api/v2/preparation/tasks` | 下发装备准备任务 |
| 提交准备完成 | POST | `/api/v2/preparation/tasks/{id}/complete` | 各车提交准备完成 |
| 下发出发指令 | POST | `/api/v2/commands/depart` | 下发车辆出发指令 |

### 12.2 机动前出

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| AI路径导航 | POST | `/api/v2/navigation/route` | AI智能路径规划 |
| 切换导航路线 | PUT | `/api/v2/navigation/route` | 切换到备选路线 |
| 风险预测 | GET | `/api/v2/risk/prediction` | 行进风险预测 |
| 安全点确认 | POST | `/api/v2/navigation/safe-point` | 确认安全停靠点 |

### 12.3 灾情快速侦察

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| AI临时指挥所推荐 | GET | `/api/v2/ai/command-post-recommendation` | 推荐指挥所位置 |
| 确认临时指挥所 | POST | `/api/v2/command-post/confirm` | 确认指挥所位置 |
| AI侦察方案生成 | POST | `/api/v2/ai/generate-scheme` | 复用方案生成接口，scheme_type=reconnaissance |
| 无人装备集群管控 | POST | `/api/v2/devices/cluster/command` | 集群控制指令 |
| 救援点AI识别 | POST | `/api/v2/ai/rescue-point-detection` | AI识别救援点 |
| 确认救援点 | POST | `/api/v2/rescue-points/confirm` | 确认识别的救援点 |

### 12.4 应急救援指挥

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 新增救援点 | POST | `/api/v2/rescue-points` | 手动新增救援点 |
| 获取救援点一张图 | GET | `/api/v2/rescue-points/overview` | 救援点全景数据 |
| AI总体救援方案 | POST | `/api/v2/ai/generate-scheme` | 复用方案生成接口，scheme_type=overall_rescue |
| AI一线救援方案 | POST | `/api/v2/ai/generate-scheme` | 复用方案生成接口，scheme_type=frontline_rescue |
| 协调联络跟踪 | GET | `/api/v2/coordination/tracking` | 协调联络状态 |

### 12.5 救援总结评估

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 生成评估报告 | POST | `/api/v2/reports/evaluation` | 生成救援评估报告 |
| 获取评估报告 | GET | `/api/v2/reports/evaluation/{id}` | 获取报告详情 |

---

## 十三、地图实体接口 (P1)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建实体 | POST | `/api/v2/entities` | 创建地图实体 |
| 获取实体列表 | GET | `/api/v2/entities` | 查询实体(支持图层过滤) |
| 更新实体位置 | PATCH | `/api/v2/entities/{id}/position` | 更新实体位置 |
| 删除实体 | DELETE | `/api/v2/entities/{id}` | 删除实体 |
| 态势标绘 | POST | `/api/v2/entities/plot` | 态势标绘 |
| 获取图层列表 | GET | `/api/v2/layers` | 获取图层配置 |

---

## 十四、指挥消息接口 (P1)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 发送消息 | POST | `/api/v2/messages` | 发送指挥消息 |
| 获取消息列表 | GET | `/api/v2/messages` | 获取消息列表 |
| 标记已读 | POST | `/api/v2/messages/{id}/read` | 标记消息已读 |
| 语音转文字 | POST | `/api/v2/messages/speech-to-text` | 语音消息转文字 |

---

## 十五、开发优先级建议

### P0 (第一阶段 - 核心流程)

1. 第三方数据接入接口 (5个)
2. 事件管理接口 (12个)
3. 方案管理接口 (10个)
4. 任务管理接口 (10个)
5. WebSocket推送 (7个频道)
6. 想定管理接口 (8个)

**共计: 约52个接口**

### P1 (第二阶段 - 完整功能)

1. 资源管理接口 (15个)
2. AI Agent接口 (6个)
3. 用户与权限接口 (6个)
4. 操作手册业务接口 (20个)
5. 地图实体接口 (6个)
6. 指挥消息接口 (4个)

**共计: 约57个接口**

### P2 (第三阶段 - 仿真演练)

1. 仿真模块接口 (8个)

---

## 十六、数据库表对应关系

| 接口模块 | 主要数据表 |
|---------|-----------|
| 想定管理 | scenarios_v2 |
| 事件管理 | events_v2, event_updates_v2 |
| 方案管理 | schemes_v2, scheme_resource_allocations_v2 |
| 任务管理 | tasks_v2, task_assignments_v2 |
| 资源管理 | teams_v2, vehicles_v2, devices_v2, supplies_v2 |
| 地图实体 | entities_v2, layers_v2 |
| 遥测数据 | telemetry_v2 |
| AI决策 | ai_decision_logs_v2 |
| 指挥消息 | command_messages_v2 |
| 用户权限 | users, roles, permissions |

---

## 十七、技术实现要点

### 17.1 认证方式

- 内部接口: JWT Token
- 第三方接入: API Key + 可选签名验证

### 17.2 频率限制

| 接口类型 | 限制 |
|---------|------|
| 灾情上报 | 100次/分钟 |
| 传感器告警 | 500次/分钟 |
| 设备遥测 | 1000次/分钟 |
| 其他接口 | 300次/分钟 |

### 17.3 响应格式

```json
{
    "success": true,
    "data": { ... },
    "message": "操作成功",
    "request_id": "req-uuid"
}
```

### 17.4 错误响应

```json
{
    "success": false,
    "error_code": "INVALID_REQUEST",
    "message": "请求参数错误",
    "details": { ... },
    "request_id": "req-uuid"
}
```
