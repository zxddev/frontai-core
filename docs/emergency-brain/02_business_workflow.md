# 应急救灾AI大脑 - 业务流程设计

> 版本: 2.0  
> 更新时间: 2025-11-25

---

## 1. 核心业务流程总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              应急救灾指挥系统业务流程                          │
└─────────────────────────────────────────────────────────────────────────────┘

想定(Scenario)
    │
    ├── 创建想定，配置场景参数
    │
    ↓
事件(Event) ←──────────────────┐
    │                          │
    ├── 第三方系统上报          │
    ├── AI图像识别             │
    ├── 传感器告警              │
    └── 系统推演               │
    │                          │
    ↓                          │
┌──────────────────┐           │
│   事件分析Agent   │           │
│   ─────────────   │           │
│   • 事件分类      │           │
│   • 严重度评估    │           │
│   • 影响范围估算  │           │
└────────┬─────────┘           │
         │                     │
         ↓                     │
方案(Scheme)                   │
    │                          │
    ├── AI生成推荐方案          │
    ├── 人工编制方案            │
    └── 基于预案模板            │
    │                          │
    ↓                          │
┌──────────────────┐           │
│  方案生成Agent    │           │
│  ─────────────    │           │
│  • 需求分析       │           │
│  • 资源匹配       │           │
│  • 风险评估       │           │
│  • 方案优化       │           │
└────────┬─────────┘           │
         │                     │
         ↓                     │
┌──────────────────┐           │
│  资源匹配Agent    │           │
│  ─────────────    │           │
│  • 能力匹配评分   │           │
│  • 距离评分       │           │
│  • 可用性评分     │           │
│  • 生成推荐理由   │  ←── 人工可修改，需记录原因
└────────┬─────────┘           │
         │                     │
         ↓                     │
方案审批                        │
    │                          │
    ├── 指挥官审批              │
    ├── 修改方案               │
    └── 驳回（返回方案生成）     │
    │                          │
    ↓                          │
任务(Task)                     │
    │                          │
    ├── 方案拆解为具体任务       │
    ├── 任务可以有子任务         │
    └── 任务间可以有依赖关系     │
    │                          │
    ↓                          │
┌──────────────────┐           │
│  任务调度Agent    │           │
│  ─────────────    │           │
│  • 任务拆解       │           │
│  • 执行者分配     │           │
│  • 路径规划       │           │
└────────┬─────────┘           │
         │                     │
         ↓                     │
执行分配(Assignment)           │
    │                          │
    ├── 分配给救援队伍          │
    ├── 分配给无人设备          │
    └── 分配给具体人员          │
    │                          │
    ↓                          │
执行追踪                        │
    │                          │
    ├── 实时位置追踪            │
    ├── 任务进度更新            │
    ├── 状态变更通知            │
    └── 异常情况上报 ───────────┘ (产生新事件)
    │
    ↓
任务完成/事件解决
    │
    └── 总结报告
```

---

## 2. 详细流程说明

### 2.1 想定管理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         想定管理流程                             │
└─────────────────────────────────────────────────────────────────┘

开始
  │
  ↓
┌──────────────────┐
│   创建新想定      │
│   ─────────────   │
│   • 想定名称      │
│   • 灾害类型      │
│   • 地理范围      │
│   • 响应级别      │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│   配置初始资源    │
│   ─────────────   │
│   • 救援队伍      │
│   • 无人设备      │
│   • 物资储备      │
│   • 安置点        │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│   配置环境参数    │
│   ─────────────   │
│   • 天气状况      │
│   • 道路状态      │
│   • 通信覆盖      │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│   想定状态        │
│   ─────────────   │
│   • preparing     │ ──→ 准备中
│   • active        │ ──→ 进行中
│   • paused        │ ──→ 暂停
│   • completed     │ ──→ 已完成
│   • archived      │ ──→ 已归档
└──────────────────┘
```

### 2.2 事件处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         事件处理流程                             │
└─────────────────────────────────────────────────────────────────┘

                    ┌──────────────┐
                    │   事件来源    │
                    └──────┬───────┘
                           │
       ┌───────────────────┼───────────────────┐
       ↓                   ↓                   ↓
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 第三方上报   │    │  AI识别     │    │ 传感器告警  │
│ (API接入)   │    │ (图像分析)  │    │ (IoT数据)  │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           ↓
                  ┌─────────────────┐
                  │    数据校验      │
                  │   ───────────    │
                  │   • 格式校验     │
                  │   • 必填字段     │
                  │   • 坐标有效性   │
                  └────────┬────────┘
                           │
                           ↓
                  ┌─────────────────┐
                  │    去重检查      │
                  │   ───────────    │
                  │   • source_id   │  ← 同一来源同一事件
                  │   • 位置+时间   │  ← 100m内1小时内
                  └────────┬────────┘
                           │
               ┌───────────┴───────────┐
               ↓                       ↓
        ┌─────────────┐         ┌─────────────┐
        │   新事件     │         │   重复事件   │
        └──────┬──────┘         └──────┬──────┘
               │                       │
               ↓                       ↓
        ┌─────────────┐         ┌─────────────┐
        │ 创建事件记录 │         │ 合并到已有   │
        │ status=     │         │ 事件记录     │
        │ pending     │         └──────┬──────┘
        └──────┬──────┘                │
               │                       │
               ↓                       │
        ┌─────────────┐                │
        │ 创建地图实体 │                │
        │ (entities)  │                │
        └──────┬──────┘                │
               │                       │
               ↓                       │
        ┌─────────────┐                │
        │ WebSocket   │                │
        │ 推送前端    │←───────────────┘
        └──────┬──────┘
               │
               ↓
        ┌─────────────┐
        │ 触发事件    │
        │ 分析Agent   │  ← 异步执行
        └──────┬──────┘
               │
               ↓
        ┌─────────────────────────────┐
        │       事件状态流转           │
        │   ─────────────────────      │
        │                             │
        │   pending ──→ confirmed     │  ← 人工确认
        │      ↓           ↓          │
        │   cancelled   planning      │  ← 开始制定方案
        │   (误报)         ↓          │
        │              executing      │  ← 方案执行中
        │                  ↓          │
        │              resolved       │  ← 事件解决
        │                  ↓          │
        │              escalated      │  ← 升级处理
        └─────────────────────────────┘
```

### 2.3 方案生成流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         方案生成流程                             │
└─────────────────────────────────────────────────────────────────┘

事件确认(confirmed)
         │
         ↓
┌─────────────────────┐
│   触发方案生成       │
│   ────────────────   │
│   • 自动(AI生成)    │
│   • 手动(人工编制)  │
│   • 模板(预案匹配)  │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────────────────────────────────────────────┐
│                    方案生成Agent                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │  需求分析    │ → │  资源查询   │ → │  约束校验   │     │
│  │             │    │             │    │             │     │
│  │ • 被困人数  │    │ • 查询队伍  │    │ • 时间约束  │     │
│  │ • 伤亡情况  │    │ • 查询设备  │    │ • 资源约束  │     │
│  │ • 紧急程度  │    │ • 查询物资  │    │ • 规则约束  │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                  │                  │             │
│         └──────────────────┼──────────────────┘             │
│                            ↓                                │
│                   ┌─────────────┐                           │
│                   │  资源匹配   │                           │
│                   │  评分排序   │                           │
│                   └──────┬──────┘                           │
│                          ↓                                  │
│         ┌────────────────────────────────────┐              │
│         │        资源匹配评分模型             │              │
│         │   ────────────────────────          │              │
│         │   总分 = Σ(权重 × 单项分)           │              │
│         │                                    │              │
│         │   • 能力匹配分 (weight=0.35)       │              │
│         │     - 该队伍具备搜救能力           │              │
│         │     - 携带生命探测仪               │              │
│         │                                    │              │
│         │   • 距离分 (weight=0.25)           │              │
│         │     - 距离事件点3.2km              │              │
│         │     - 预计到达时间12分钟           │              │
│         │                                    │              │
│         │   • 可用性分 (weight=0.20)         │              │
│         │     - 当前状态: 空闲               │              │
│         │     - 无其他任务                   │              │
│         │                                    │              │
│         │   • 装备适配分 (weight=0.10)       │              │
│         │     - 配备热成像无人机             │              │
│         │                                    │              │
│         │   • 历史表现分 (weight=0.10)       │              │
│         │     - 历史任务完成率: 98%          │              │
│         └────────────────────────────────────┘              │
│                          ↓                                  │
│                   ┌─────────────┐                           │
│                   │ 生成推荐理由│  ← AI生成自然语言解释     │
│                   └──────┬──────┘                           │
│                          │                                  │
└──────────────────────────┼──────────────────────────────────┘
                           ↓
                  ┌─────────────────┐
                  │   方案审批流程   │
                  │   ─────────────  │
                  │                 │
                  │   draft         │ ← 草稿
                  │      ↓          │
                  │   pending_review│ ← 待审批
                  │      ↓          │
                  │   ┌────┴────┐   │
                  │   ↓         ↓   │
                  │ approved  rejected
                  │   ↓         ↓   │
                  │ executing  返回修改
                  │   ↓          │
                  │ completed    │
                  └───────────────┘

```

### 2.4 资源分配流程（含AI推荐理由）

```
┌─────────────────────────────────────────────────────────────────┐
│                       资源分配流程                               │
└─────────────────────────────────────────────────────────────────┘

方案生成完成
         │
         ↓
┌─────────────────────────────────────────────────────────────┐
│                    资源分配记录                              │
│  scheme_resource_allocations_v2                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 资源: 蓝天救援队-A组                                 │   │
│  │ 类型: team                                          │   │
│  │ 角色: 主搜救力量                                     │   │
│  │                                                      │   │
│  │ ═══════════ AI推荐理由 ═══════════                  │   │
│  │                                                      │   │
│  │ 综合评分: 92.5/100 (排名: 1)                        │   │
│  │                                                      │   │
│  │ 能力匹配: 该队伍具备专业地震搜救资质，              │   │
│  │          拥有生命探测仪和破拆设备，                  │   │
│  │          队员均持有高级救援证书。                    │   │
│  │                                                      │   │
│  │ 距离因素: 距离事件点2.8km，预计到达时间8分钟，      │   │
│  │          是距离最近的专业搜救队伍。                  │   │
│  │                                                      │   │
│  │ 可用状态: 当前处于待命状态，无正在执行的任务，      │   │
│  │          可立即出动。                                │   │
│  │                                                      │   │
│  │ 装备适配: 配备生命探测仪2台、破拆设备1套、          │   │
│  │          热成像无人机1架，适合建筑倒塌搜救。         │   │
│  │                                                      │   │
│  │ 历史表现: 近30天完成任务8次，成功率100%，           │   │
│  │          平均响应时间6分钟。                         │   │
│  │                                                      │   │
│  │ ═══════════ 备选资源 ═══════════                    │   │
│  │                                                      │   │
│  │ 1. 消防救援站-3中队 (评分: 87.3)                    │   │
│  │ 2. 民兵应急分队-B组 (评分: 82.1)                    │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ↓                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    人工审核                          │   │
│  │                                                      │   │
│  │   □ 确认AI推荐                                      │   │
│  │   □ 修改为其他资源                                   │   │
│  │                                                      │   │
│  │   如修改，请填写原因:                                │   │
│  │   ┌──────────────────────────────────────────────┐  │   │
│  │   │ 蓝天救援队今日有队员请假，实际可出动人数      │  │   │
│  │   │ 不足，改派消防救援站-3中队执行。              │  │   │
│  │   └──────────────────────────────────────────────┘  │   │
│  │                                                      │   │
│  │   [确认] [取消]                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  修改后记录:                                                │
│  • is_human_modified: true                                 │
│  • human_modification_reason: "蓝天救援队今日..."          │
│  • modified_by: user_id                                    │
│  • original_resource_id: 蓝天救援队ID                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.5 任务执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         任务执行流程                             │
└─────────────────────────────────────────────────────────────────┘

方案批准(approved)
         │
         ↓
┌─────────────────────┐
│   方案拆解为任务     │
│   ────────────────   │
│   方案 → 主任务      │
│          └─ 子任务1  │
│          └─ 子任务2  │
│          └─ 子任务3  │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────────────────────────────────────────────┐
│                      任务状态流转                            │
│                                                             │
│   created ──────→ assigned ──────→ accepted                │
│      │               │                │                     │
│      │               │                ↓                     │
│      │               │          in_progress                 │
│      │               │                │                     │
│      │               ↓                ↓                     │
│      │           rejected ←───── [执行失败]                 │
│      │               │                │                     │
│      ↓               │                ↓                     │
│   cancelled          │           completed                  │
│   (任务取消)          │           (任务完成)                  │
│                      │                                      │
│                      └──→ 重新分配                          │
└─────────────────────────────────────────────────────────────┘
           │
           ↓
┌─────────────────────────────────────────────────────────────┐
│                      执行追踪                                │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                  实时位置追踪                        │  │
│   │                                                      │  │
│   │   设备遥测数据 ──→ telemetry_v2                      │  │
│   │         │                                            │  │
│   │         ↓                                            │  │
│   │   位置更新 ──→ entities_v2                           │  │
│   │         │                                            │  │
│   │         ↓                                            │  │
│   │   WebSocket ──→ 前端地图更新                         │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                  进度反馈                            │  │
│   │                                                      │  │
│   │   执行者上报:                                        │  │
│   │   • 任务进度百分比                                   │  │
│   │   • 现场情况描述                                     │  │
│   │   • 发现新情况(产生新事件)                           │  │
│   │   • 需要增援                                         │  │
│   │   • 任务完成确认                                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 状态机定义

### 3.1 事件状态机

```
                    ┌──────────────┐
                    │   pending    │ ← 初始状态(待确认)
                    └──────┬───────┘
                           │
            ┌──────────────┼──────────────┐
            ↓              ↓              ↓
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  confirmed  │ │  cancelled  │ │  escalated  │
    │  (已确认)    │ │  (已取消)   │ │  (已升级)   │
    └──────┬──────┘ └─────────────┘ └─────────────┘
           │
           ↓
    ┌─────────────┐
    │  planning   │ ← 制定方案中
    └──────┬──────┘
           │
           ↓
    ┌─────────────┐
    │  executing  │ ← 执行中
    └──────┬──────┘
           │
           ↓
    ┌─────────────┐
    │  resolved   │ ← 已解决
    └─────────────┘
```

### 3.2 方案状态机

```
    ┌─────────────┐
    │   draft     │ ← 草稿
    └──────┬──────┘
           │
           ↓
    ┌─────────────┐
    │pending_review│ ← 待审批
    └──────┬──────┘
           │
    ┌──────┴──────┐
    ↓             ↓
┌─────────┐ ┌──────────┐
│approved │ │ rejected │ → 返回draft修改
└────┬────┘ └──────────┘
     │
     ↓
┌─────────────┐
│  executing  │ ← 执行中
└──────┬──────┘
     │
     ├────────────┐
     ↓            ↓
┌─────────┐ ┌──────────┐
│completed│ │superseded│ ← 被新方案替代
└─────────┘ └──────────┘
```

### 3.3 任务状态机

```
    ┌─────────────┐
    │  created    │ ← 已创建
    └──────┬──────┘
           │
           ↓
    ┌─────────────┐
    │  assigned   │ ← 已分配
    └──────┬──────┘
           │
    ┌──────┴──────┐
    ↓             ↓
┌─────────┐ ┌──────────┐
│ accepted│ │ rejected │ → 重新分配
└────┬────┘ └──────────┘
     │
     ↓
┌─────────────┐
│ in_progress │ ← 执行中
└──────┬──────┘
     │
     ├────────────┐
     ↓            ↓
┌─────────┐ ┌──────────┐
│completed│ │  failed  │ → 重新分配或升级
└─────────┘ └──────────┘
```

---

## 4. 数据流转关系

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据关系图                                │
└─────────────────────────────────────────────────────────────────┘

scenarios_v2 (想定)
    │
    ├──→ events_v2 (事件)
    │        │
    │        ├──→ event_updates_v2 (事件更新记录)
    │        │
    │        └──→ schemes_v2 (方案)
    │                 │
    │                 ├──→ scheme_resource_allocations_v2 (资源分配)
    │                 │        │
    │                 │        ├── teams_v2 (救援队伍)
    │                 │        ├── vehicles_v2 (车辆)
    │                 │        └── devices_v2 (无人设备)
    │                 │
    │                 └──→ tasks_v2 (任务)
    │                          │
    │                          └──→ task_assignments_v2 (执行分配)
    │
    ├──→ entities_v2 (地图实体)
    │        │
    │        └──→ layers_v2 (图层)
    │
    ├──→ weather_conditions_v2 (天气)
    │
    ├──→ communication_networks_v2 (通信)
    │
    ├──→ evacuation_shelters_v2 (安置点)
    │
    └──→ telemetry_v2 (遥测数据)

ai_decision_logs_v2 (AI决策日志) ──→ 关联 events/schemes
conversations_v2 (对话) ──→ 关联 users
command_messages_v2 (指挥消息) ──→ 关联 scenarios/users
```

---

## 5. 异常处理流程

### 5.1 资源冲突处理

```
检测到资源冲突
      │
      ↓
┌─────────────────┐
│  冲突类型判断    │
└────────┬────────┘
         │
    ┌────┴────┐
    ↓         ↓
 时间冲突   能力不足
    │         │
    ↓         ↓
┌─────────┐ ┌─────────┐
│调整时间 │ │更换资源 │
│或排队   │ │或增援   │
└────┬────┘ └────┬────┘
     │           │
     └─────┬─────┘
           ↓
    ┌─────────────┐
    │  通知相关方  │
    └─────────────┘
```

### 5.2 任务失败处理

```
任务执行失败
      │
      ↓
┌─────────────────┐
│  分析失败原因    │
└────────┬────────┘
         │
    ┌────┼────┬────────┐
    ↓    ↓    ↓        ↓
  设备  人员  环境    其他
  故障  受伤  恶化
    │    │    │        │
    ↓    ↓    ↓        ↓
┌─────┐┌─────┐┌─────┐┌─────┐
│更换 ││医疗 ││暂停 ││上报 │
│设备 ││救援 ││等待 ││指挥 │
└──┬──┘└──┬──┘└──┬──┘└──┬──┘
   │      │      │      │
   └──────┴──────┴──────┘
              │
              ↓
       ┌─────────────┐
       │ 重新调度或   │
       │ 升级处理     │
       └─────────────┘
```
