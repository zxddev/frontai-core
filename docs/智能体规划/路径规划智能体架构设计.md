# 路径规划智能体架构设计

## 1. 设计背景

### 1.1 问题分析

在应急救援场景中，路径规划面临以下挑战：

| 挑战 | 说明 |
|------|------|
| 动态路况 | 灾害导致道路塌方、积水、封锁，需实时调整 |
| 多目标权衡 | 时间最短 vs 最安全 vs 燃油效率，不同场景优先级不同 |
| 自然语言交互 | 指挥员说"避开塌方区"需要转化为算法约束 |
| 失败恢复 | 算法找不到路径时需要智能决策下一步 |
| 结果解释 | 需要向指挥员解释为什么选择这条路 |

### 1.2 为什么需要LangGraph？

**错误做法（滥用框架）：**
```
请求 → LangGraph包装 → DatabaseRouteEngine → 返回
```
- LLM没有参与决策
- 没有循环/反馈机制
- 只是把算法套了个壳

**正确做法（本设计）：**
- LLM参与场景理解和策略决策
- 有评估-重规划循环
- 算法只负责纯计算

---

## 2. 学术研究支持

本设计参考了以下前沿研究：

### 2.1 DynamicRouteGPT (2024)

**论文**: *DynamicRouteGPT: A Real-Time Multi-Vehicle Dynamic Navigation Framework Based on Large Language Models*

**来源**: arXiv:2408.14185

**核心思想**:
- 传统A*/Dijkstra在动态条件下失效
- LLM用于理解复杂交通环境
- 实时多车辆动态导航决策

**对本设计的启发**:
- 场景分析节点的设计
- 动态重规划机制

### 2.2 PlanAgent (2024)

**论文**: *PlanAgent: A Multi-modal Large Language Agent for Closed-loop Vehicle Motion Planning*

**来源**: arXiv:2406.01587

**核心思想**:
- "Closed-loop"闭环 = 感知→规划→执行→反馈循环
- 多模态LLM整合信息做决策
- Agent架构实现自主规划

**对本设计的启发**:
- 评估-重规划循环的设计
- 闭环反馈机制

### 2.3 LeAD (2025)

**论文**: *LeAD: The LLM Enhanced Planning System Converged with End-to-end Autonomous Driving*

**来源**: arXiv:2507.05754

**核心思想**:
- **双频架构**: 高频E2E子系统 + 低频LLM模块
- 高频层处理实时控制（毫秒级）
- 低频层处理场景理解和决策（秒级）
- Chain-of-Thought推理增强决策

**对本设计的启发**:
- 双频架构的核心设计理念
- LLM用于场景理解而非替代算法

### 2.4 StuckSolver (2024)

**论文**: *Large Language Model-assisted Autonomous Vehicle Recovery from Immobilization*

**来源**: arXiv:2510.26023

**核心思想**:
- 车辆陷入困境时，LLM进行self-reasoning
- 支持乘客引导决策
- 作为插件模块，不修改底层架构

**对本设计的启发**:
- 失败恢复决策机制
- 结果评估节点的设计

---

## 3. 架构设计

### 3.1 双频架构

```
┌─────────────────────────────────────────────────────────────┐
│                    路径规划智能体                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              低频层 (LLM决策，秒级)                  │    │
│  │                                                      │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────┐  │    │
│  │  │ 场景分析     │  │ 策略选择     │  │ 结果评估  │  │    │
│  │  │ (analyze)    │→ │ (strategy)   │  │ (evaluate)│  │    │
│  │  └──────────────┘  └──────────────┘  └───────────┘  │    │
│  │         ↓                 ↑               │          │    │
│  │         ↓                 │               ↓          │    │
│  │         ↓          ┌──────┴───────┐  ┌───────────┐  │    │
│  │         ↓          │ 策略调整     │  │ 路径解释  │  │    │
│  │         ↓          │ (adjust)     │  │ (explain) │  │    │
│  │         ↓          └──────────────┘  └───────────┘  │    │
│  └─────────┼────────────────────────────────────────────┘    │
│            ↓                                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              高频层 (纯算法，毫秒级)                  │    │
│  │                                                      │    │
│  │  ┌──────────────────────────────────────────────┐   │    │
│  │  │              路径计算 (compute_route)         │   │    │
│  │  │                                               │   │    │
│  │  │  ┌─────────────┐    ┌─────────────────────┐  │   │    │
│  │  │  │ A* (单车)   │    │ VRP/OR-Tools (多车) │  │   │    │
│  │  │  │ Database    │    │ VehicleRouting      │  │   │    │
│  │  │  │ RouteEngine │    │ Planner             │  │   │    │
│  │  │  └─────────────┘    └─────────────────────┘  │   │    │
│  │  └──────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 LangGraph流程图

```
START
  │
  ▼
┌─────────────────────┐
│ analyze_scenario    │ ← LLM理解场景、评估紧急程度
│ (场景分析)          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ select_strategy     │ ← LLM选择规划策略、生成算法参数
│ (策略选择)          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ compute_route       │ ← 纯算法计算（A*/VRP）
│ (路径计算)          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ evaluate_result     │ ← LLM评估结果是否满足需求
│ (结果评估)          │
└──────────┬──────────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
[should_replan] [满足需求]
     │           │
     ▼           ▼
┌───────────┐  ┌─────────────────────┐
│ adjust    │  │ explain_route       │
│ strategy  │  │ (路径解释)          │
│ (策略调整)│  └──────────┬──────────┘
└─────┬─────┘             │
      │                   ▼
      │                  END
      │
      └──────────────────────┐
                             │
                             ▼
                    select_strategy (循环)
```

### 3.3 节点职责

| 节点 | 类型 | 职责 | 输入 | 输出 |
|------|------|------|------|------|
| analyze_scenario | LLM | 理解灾情、评估紧急程度、识别风险 | disaster_context, nl_request | scenario_analysis |
| select_strategy | LLM | 选择规划策略、生成算法参数 | scenario_analysis, constraints | strategy_selection |
| compute_route | 算法 | 调用A*/VRP计算路径 | start, end, vehicle, strategy | route_result |
| evaluate_result | LLM | 评估结果、决定是否重规划 | route_result, scenario | route_evaluation |
| adjust_strategy | 逻辑 | 增加重试计数、记录历史 | replan_count | replan_count+1 |
| explain_route | LLM | 生成自然语言路径说明 | route_result, evaluation | route_explanation |

---

## 4. 核心类型定义

### 4.1 状态定义 (TypedDict)

```python
class RoutePlanningState(TypedDict):
    # 输入
    request_id: str
    request_type: Literal["single", "multi", "replan"]
    start: Optional[Point]
    end: Optional[Point]
    vehicle_id: Optional[str]
    vehicles: List[VehicleInfo]
    task_points: List[TaskPoint]
    scenario_id: Optional[str]
    constraints: RouteConstraint
    disaster_context: Optional[DisasterContext]
    natural_language_request: Optional[str]
    
    # LLM决策结果
    scenario_analysis: Optional[ScenarioAnalysis]
    strategy_selection: Optional[StrategySelection]
    route_evaluation: Optional[RouteEvaluation]
    route_explanation: Optional[RouteExplanation]
    
    # 算法计算结果
    route_result: Optional[SingleRouteResult]
    multi_route_result: Optional[MultiVehicleRouteResult]
    
    # 重规划控制
    replan_count: int
    max_replan_attempts: int
    
    # 追踪
    trace: Dict[str, Any]
    errors: List[str]
```

### 4.2 策略预设

```python
STRATEGY_PRESETS = {
    "fastest": {
        "optimization_weights": {"time": 0.7, "safety": 0.1, "distance": 0.1, "fuel": 0.1},
        "algorithm_params": {"search_radius_km": 50.0, "speed_factor": 1.2, "risk_tolerance": 0.7},
    },
    "safest": {
        "optimization_weights": {"time": 0.1, "safety": 0.7, "distance": 0.1, "fuel": 0.1},
        "algorithm_params": {"search_radius_km": 100.0, "speed_factor": 0.8, "risk_tolerance": 0.2},
    },
    "balanced": {
        "optimization_weights": {"time": 0.4, "safety": 0.3, "distance": 0.2, "fuel": 0.1},
        "algorithm_params": {"search_radius_km": 80.0, "speed_factor": 1.0, "risk_tolerance": 0.5},
    },
    # ...
}
```

---

## 5. 应急救援场景适配

### 5.1 场景1: 动态重规划

**输入**: "前方道路塌方，3辆救援车正在途中"

**LLM场景分析**:
- 识别受影响车辆
- 评估紧急程度
- 判断是否有备选路线

**决策**: 为受影响车辆触发重规划，调整搜索范围

### 5.2 场景2: 多目标权衡

**输入**: 地震现场，需派遣5支队伍

**LLM策略选择**:
- 医疗队 → fastest（生命优先）
- 重型设备队 → capacity（道路承载力）
- 危化品处理队 → safest（安全优先）

**决策**: 为每支队伍选择不同策略

### 5.3 场景3: 失败恢复

**输入**: A*算法找不到路径

**LLM结果评估**:
- 分析失败原因
- 评估是否扩大搜索范围
- 判断是否降低约束
- 考虑备选交通方式

**决策**: 调整参数重试或报告无法到达

### 5.4 场景4: 指挥员交互

**输入**: "让消防车走南边，避开学校"

**LLM约束转换**:
- 理解"南边"的地理含义
- 识别需要避开的区域
- 转化为算法约束参数

**决策**: 修改constraints.avoid_areas

---

## 6. 与现有系统集成

### 6.1 调用方式

```python
from src.agents.route_planning import invoke

# 单车规划
result = await invoke(
    request_type="single",
    start={"lon": 104.06, "lat": 30.67},
    end={"lon": 104.12, "lat": 30.72},
    vehicle_id="vehicle-001",
    disaster_context={
        "disaster_type": "earthquake",
        "severity": "high",
        "urgency_level": "critical",
    },
    db=db_session,  # 可选，用于加载路网
)

# 多车规划
result = await invoke(
    request_type="multi",
    vehicles=[...],
    task_points=[...],
    depot_location={"lon": 104.06, "lat": 30.67},
)
```

### 6.2 与EmergencyAI集成

```
EmergencyAI (救援方案生成)
    │
    ├── htn_decompose → 产生任务
    │
    └── 调用 RoutePlanningAgent ← 作为子图/服务
            │
            └── 为每支队伍规划路径
```

---

## 7. API接口

### 7.1 REST API

**提交路径规划任务**
```http
POST /ai/route-planning
Content-Type: application/json

{
    "request_type": "single",
    "start": {"lon": 104.06, "lat": 30.67},
    "end": {"lon": 104.12, "lat": 30.72},
    "vehicle_id": "vehicle-001",
    "disaster_context": {
        "disaster_type": "earthquake",
        "severity": "high",
        "urgency_level": "critical"
    },
    "natural_language_request": "紧急救援任务，尽快到达现场"
}
```

**响应**
```json
{
    "success": true,
    "task_id": "route-abc12345",
    "request_type": "single",
    "status": "processing",
    "message": "路径规划任务已提交，预计完成时间3-10秒",
    "created_at": "2025-11-26T23:20:00Z"
}
```

**查询结果**
```http
GET /ai/route-planning/{task_id}
```

**结果响应**
```json
{
    "request_id": "route-abc12345",
    "request_type": "single",
    "success": true,
    "route": {
        "route_id": "xxx",
        "vehicle_id": "vehicle-001",
        "path_points": [...],
        "total_distance_m": 7988.97,
        "total_duration_seconds": 479.34,
        "risk_score": 0.5,
        "warnings": []
    },
    "explanation": {
        "summary": "从起点沿东北方向快速前进至终点...",
        "route_description": "...",
        "risk_warnings": [...],
        "commander_notes": "..."
    },
    "trace": {
        "phases_executed": ["analyze_scenario", "select_strategy", "compute_route", "evaluate_result", "explain_route"],
        "llm_calls": 4,
        "algorithm_calls": 1,
        "replan_count": 0
    }
}
```

---

## 8. 实测性能

### 8.1 测试结果 (2025-11-26)

**测试场景**: 单车点对点规划，地震灾情，critical紧急程度

| 阶段 | 耗时 | 说明 |
|------|------|------|
| 场景分析 (LLM) | 8.8秒 | 识别critical紧急程度，推荐fastest策略 |
| 策略选择 (LLM) | 8.0秒 | 选择fastest策略，生成算法参数 |
| 路径计算 (算法) | <1毫秒 | 直线距离估算（无路网数据） |
| 结果评估 (LLM) | 17.3秒 | 评估满足需求，无需重规划 |
| 路径解释 (LLM) | 24.5秒 | 生成自然语言解释 |
| **总耗时** | **58.7秒** | 主要是LLM调用时间 |

**结果输出**:
- 距离: 7.99km
- 预计时间: 6.7分钟
- LLM调用: 4次
- 算法调用: 1次
- 重规划次数: 0

**LLM生成的摘要**:
> "从起点(104.0600,30.6700)沿东北方向快速前进至终点(104.1200,30.7200)，全程约7.99公里，预计7分钟抵达，风险评分0.5，满足黄金救援时限。"

### 8.2 多车VRP测试

**测试场景**: 2辆车、3个任务点

| 指标 | 结果 |
|------|------|
| 耗时 | 30秒 |
| 服务任务 | 3/3 (100%) |
| 总距离 | 16km |
| 算法 | VehicleRoutingPlanner (OR-Tools) |

---

## 9. 目录结构

```
src/agents/route_planning/
├── __init__.py           # 模块入口
├── agent.py              # invoke入口函数
├── graph.py              # LangGraph流程定义
├── state.py              # 强类型状态定义
└── nodes/
    ├── __init__.py
    ├── analyze.py        # 场景分析 (LLM)
    ├── strategy.py       # 策略选择 (LLM)
    ├── routing.py        # 路径计算 (算法)
    ├── evaluate.py       # 结果评估 (LLM)
    └── explain.py        # 路径解释 (LLM)
```

**测试脚本**: `scripts/test_route_planning_agent.py`

---

## 10. 参考文献

1. Zhou, Z., Zhou, B., & Liu, H. (2024). *DynamicRouteGPT: A Real-Time Multi-Vehicle Dynamic Navigation Framework Based on Large Language Models*. arXiv:2408.14185.

2. Zheng, Y., et al. (2024). *PlanAgent: A Multi-modal Large Language Agent for Closed-loop Vehicle Motion Planning*. arXiv:2406.01587.

3. Chen, Y., et al. (2024). *Asynchronous Large Language Model Enhanced Planner for Autonomous Driving*. arXiv:2406.14556.

4. Zhang, Y., et al. (2025). *LeAD: The LLM Enhanced Planning System Converged with End-to-end Autonomous Driving*. arXiv:2507.05754.

5. Bao, Z., & Li, Q. (2024). *Large Language Model-assisted Autonomous Vehicle Recovery from Immobilization*. arXiv:2510.26023.

6. Patwary, A. U. Z., et al. (2025). *Bridging AI and Traffic Simulation: A Robust Framework for LLM-Based AI Replanning Agents in MATSim*. MUM 2025.
