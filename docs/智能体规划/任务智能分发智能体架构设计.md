# 任务智能分发智能体架构设计

## 1. 概述

任务智能分发智能体（TaskDispatchAgent）是应急救援AI系统的核心组件，负责将方案任务分配给执行者，并在执行过程中动态调整分配。

### 1.1 核心价值

任务分发的价值不在初始分配（算法驱动），而在**动态调整**：
- 任务被拒绝 → LLM决定谁替代
- 任务失败 → LLM评估等待/重分配/上报
- 资源变化 → LLM权衡抢占/等待

这正是Agent的定义：**感知-决策-执行的自主循环**。

### 1.2 为什么使用LangGraph

| 特性 | 需求 | LangGraph支持 |
|------|------|---------------|
| LLM决策 | 事件分析、行动决策 | ✓ 节点集成LLM |
| Human-in-the-loop | 重大决策人工确认 | ✓ interrupt_before |
| 状态持久化 | 跨请求保持上下文 | ✓ checkpointer |
| 条件路由 | 根据状态动态路由 | ✓ conditional_edges |

## 2. 架构设计

### 2.1 双模式架构

```
┌─────────────────────────────────────────────────────────────┐
│                    TaskDispatchAgent                        │
├─────────────────────────────────────────────────────────────┤
│  Mode 1: 初始分配                Mode 2: 动态调整           │
│  ┌─────────────────────┐        ┌─────────────────────┐    │
│  │ extract_needs       │        │ analyze_event (LLM) │    │
│  │ query_executors     │        │ decide_action (LLM) │    │
│  │ match_executors     │        │ human_review        │    │
│  │ schedule_tasks      │        │ execute_action      │    │
│  │ generate_orders     │        │ notify              │    │
│  │ notify              │        └─────────────────────┘    │
│  └─────────────────────┘                                    │
│         ↓                              ↓                    │
│    批量处理                      事件驱动+人工确认           │
│    算法为主                      LLM决策+interrupt          │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 LangGraph状态机

```
                        ┌─────────────────┐
                        │      START      │
                        └────────┬────────┘
                                 │
                    ┌────────────┴────────────┐
                    │     route_by_mode       │
                    └────────────┬────────────┘
                   /                           \
          [initial]                             [dynamic]
                 /                                 \
    ┌────────────────┐                    ┌─────────────────┐
    │ extract_needs  │                    │  analyze_event  │
    └───────┬────────┘                    │     (LLM)       │
            │                             └────────┬────────┘
    ┌───────┴────────┐                             │
    │ query_executors│                    ┌────────┴────────┐
    └───────┬────────┘                    │  decide_action  │
            │                             │     (LLM)       │
    ┌───────┴────────┐                    └────────┬────────┘
    │ match_executors│                             │
    └───────┬────────┘                    ┌────────┴────────┐
            │                             │ [requires_human?]│
    ┌───────┴────────┐                    └────────┬────────┘
    │ schedule_tasks │                            / \
    └───────┬────────┘                    [yes]  /   \ [no]
            │                                   /     \
    ┌───────┴────────┐              ┌──────────┐     │
    │ generate_orders│              │human_review│    │
    └───────┬────────┘              │(interrupt)│    │
            │                       └─────┬────┘     │
            │                             │          │
            │                       ┌─────┴──────────┘
            │                       │
    ┌───────┴────────┐      ┌───────┴────────┐
    │     notify     │      │ execute_action │
    └───────┬────────┘      └───────┬────────┘
            │                       │
            │               ┌───────┴────────┐
            │               │     notify     │
            │               └───────┬────────┘
            │                       │
            └───────────┬───────────┘
                        │
                   ┌────┴────┐
                   │   END   │
                   └─────────┘
```

## 3. 核心组件

### 3.1 状态定义 (state.py)

```python
class TaskDispatchState(TypedDict, total=False):
    # 基础信息
    event_id: str
    scheme_id: str
    dispatch_mode: str  # "initial" | "dynamic"
    
    # Mode 1: 初始分配
    scheme_tasks: List[Dict]
    allocated_teams: List[Dict]
    available_executors: List[ExecutorInfo]
    current_assignments: List[TaskAssignment]
    dispatch_orders: List[Dict]
    
    # Mode 2: 动态调整
    pending_events: List[DispatchEvent]
    current_event: DispatchEvent
    proposed_action: DispatchAction
    requires_human_approval: bool
    human_decision: str
    
    # 追踪
    trace: Dict[str, Any]
    errors: List[str]
```

### 3.2 事件类型

```python
class DispatchEventType(str, Enum):
    TASK_REJECTED = "task_rejected"         # 任务被拒绝
    TASK_FAILED = "task_failed"             # 任务执行失败
    TASK_TIMEOUT = "task_timeout"           # 任务超时
    RESOURCE_UNAVAILABLE = "resource_unavailable"  # 资源不可用
    NEW_URGENT_TASK = "new_urgent_task"     # 新增紧急任务
    PRIORITY_CHANGE = "priority_change"     # 优先级变更
    RESOURCE_STATUS_CHANGE = "resource_status_change"  # 资源状态变化
```

### 3.3 行动类型

```python
class DispatchActionType(str, Enum):
    REASSIGN = "reassign"    # 重新分配
    RETRY = "retry"          # 重试
    ESCALATE = "escalate"    # 上报人工
    PREEMPT = "preempt"      # 抢占资源
    WAIT = "wait"            # 等待
    CANCEL = "cancel"        # 取消任务
```

## 4. 节点实现

### 4.1 Mode 1: 初始分配节点

| 节点 | 功能 | 依赖 |
|------|------|------|
| extract_capability_needs | 从mt_library提取任务能力需求 | mt_library.json |
| query_available_executors | 查询数据库获取可用执行者 | rescue_teams_v2, vehicles_v2 |
| match_executors | 能力匹配（OR-Tools CSP） | CapabilityMatcher |
| schedule_tasks | 时间调度（优先级+依赖） | TaskScheduler |
| generate_dispatch_orders | 生成调度指令 | - |

### 4.2 Mode 2: 动态调整节点

| 节点 | 功能 | LLM |
|------|------|-----|
| analyze_dispatch_event | 分析事件影响和紧急程度 | ✓ |
| decide_dispatch_action | 决定具体行动和执行者 | ✓ |
| human_review | 人工审核（interrupt_before） | - |
| execute_dispatch_action | 执行重分配/重试/取消 | - |

### 4.3 LLM提示词示例

**事件分析提示词：**
```
你是应急救援任务调度系统的事件分析专家。

分析时请考虑：
1. 事件发生的直接原因是什么？
2. 事件对当前救援任务的影响有多大？
3. 是否需要立即处理？
4. 处理不当可能带来什么后果？

请用JSON格式输出：
{
    "event_summary": "事件简述",
    "root_cause": "根本原因分析",
    "impact_level": "high/medium/low",
    "urgency": "immediate/soon/can_wait",
    "recommended_action_type": "reassign/retry/escalate/wait"
}
```

## 5. Human-in-the-Loop

### 5.1 实现机制

使用LangGraph的`interrupt_before`在human_review节点前设置中断点：

```python
compiled = graph.compile(
    checkpointer=checkpointer,
    interrupt_before=["human_review"],
)
```

### 5.2 工作流程

```
1. 事件触发 → handle_event()
2. LLM分析 → analyze_dispatch_event
3. LLM决策 → decide_dispatch_action
4. 需要人工审核 → 图在human_review前暂停
5. 返回interrupt_info给客户端
6. 用户审核后调用 resume_with_human_decision()
7. 继续执行 → execute_action → notify
```

### 5.3 触发条件

以下情况需要人工确认：
- 置信度 < 0.6
- 关键任务(critical)的重新分配
- 上报(escalate)类型决策
- 抢占(preempt)类型决策
- 高风险影响

## 6. API接口

### 6.1 初始分配

```python
agent = TaskDispatchAgent(use_checkpointer=False)

result = await agent.initial_dispatch(
    event_id="evt-001",
    scheme_id="sch-001",
    scheme_tasks=[...],      # 来自HTN分解
    allocated_teams=[...],   # 来自EmergencyAI资源匹配
)

# 返回
{
    "success": True,
    "assignments": [...],      # 任务分配列表
    "dispatch_orders": [...],  # 调度指令列表
    "execution_time_ms": 232,
    "trace": {...}
}
```

### 6.2 动态调整

```python
agent = TaskDispatchAgent(use_checkpointer=True)

# 处理事件
result = await agent.handle_event(
    event_id="evt-001",
    event_type="task_rejected",
    task_id="EM06",
    executor_id="team-001",
    reason="设备故障",
)

# 如果需要人工确认，返回
{
    "success": True,
    "interrupted": True,
    "thread_id": "dispatch-evt-001-dynamic",
    "interrupt_info": {...}
}

# 人工审核后恢复
result = await agent.resume_with_human_decision(
    thread_id="dispatch-evt-001-dynamic",
    decision="approve",  # approve/reject/modify
)
```

## 7. 数据库依赖

### 7.1 表结构

| 表名 | 用途 |
|------|------|
| operational_v2.rescue_teams_v2 | 救援队伍信息 |
| operational_v2.vehicles_v2 | 车辆信息 |
| operational_v2.team_vehicles_v2 | 队伍-车辆关联 |

### 7.2 关键字段

```sql
-- rescue_teams_v2
SELECT id, name, team_type, status, total_personnel,
       properties->'capabilities' as capabilities,
       ST_Y(base_location::geometry) as lat,
       ST_X(base_location::geometry) as lng
FROM operational_v2.rescue_teams_v2
WHERE status IN ('available', 'standby')
```

## 8. 配置

### 8.1 LLM配置

```python
# 从环境变量读取
LLM_MODEL = os.environ.get('LLM_MODEL', '/models/openai/gpt-oss-120b')
OPENAI_BASE_URL = os.environ.get('OPENAI_BASE_URL', 'http://192.168.31.50:8000/v1')
REQUEST_TIMEOUT = int(os.environ.get('REQUEST_TIMEOUT', '120'))
```

### 8.2 Checkpointer配置

```python
# 开发环境：内存
checkpointer = InMemorySaver()

# 生产环境：PostgreSQL（TODO）
# checkpointer = PostgresSaver(connection_string)
```

## 9. 测试

### 9.1 运行测试

```bash
python3 scripts/test_task_dispatch.py
```

### 9.2 测试结果

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 图结构 | ✓ | 10个节点正确构建 |
| Mode 1 初始分配 | ✓ | 数据库查询+能力匹配+调度 |
| Mode 2 动态调整 | ✓ | LLM分析→决策→interrupt暂停 |

### 9.3 示例输出

**Mode 1:**
```
任务分配详情:
  - 埋压人员生命探测 -> 茂县消防救援大队
  - 被困人员救援 -> 成都特勤消防救援站
  - 伤员现场急救 -> 茂县人民医院急救队
  - 交通管制与道路抢通 -> 茂县消防救援大队
```

**Mode 2:**
```
事件分析:
  摘要: 任务 EM06 的执行者因生命探测仪故障而拒绝执行任务
  影响级别: high
  紧急程度: immediate
  建议行动: reassign

LLM决策:
  行动类型: escalate
  置信度: 0.96
  理由: 执行者的 life_detector 关键设备故障，维修需约4小时，
        远超任务的黄金救援时间窗口...必须立即上报至指挥中心
```

## 10. 文件结构

```
src/agents/task_dispatch/
├── __init__.py              # 模块导出
├── agent.py                 # TaskDispatchAgent主类
├── graph.py                 # LangGraph状态机定义
├── state.py                 # 状态类型定义
├── nodes/
│   ├── __init__.py
│   ├── initial_dispatch.py  # Mode 1: 初始分配节点
│   ├── analyze_event.py     # Mode 2: LLM事件分析
│   ├── decide_action.py     # Mode 2: LLM行动决策
│   ├── execute_action.py    # Mode 2: 执行行动
│   └── notify.py            # 通知相关方
└── tools/
    └── __init__.py          # 工具函数（预留）
```

## 11. 待完成事项

- [ ] PostgresSaver集成（生产环境持久化）
- [ ] WebSocket通知实现（替换模拟发送）
- [ ] TaskService.assign() API调用
- [ ] 完善能力匹配算法（考虑地理位置）
- [ ] 添加监控指标和日志
- [ ] 性能优化（执行者缓存）
