# 应急救援智能体架构设计

> 版本: 2.0  
> 更新日期: 2025-11-26  
> 模块路径: `src/agents/emergency_ai/`

## 1. 系统概述

应急救援智能体（EmergencyAI）是一个基于LangGraph构建的AI+规则混合系统，用于应急救援场景下的智能决策支持。系统采用4阶段流水线架构，结合大语言模型(LLM)、检索增强生成(RAG)、知识图谱(KG)和多目标优化算法，实现从灾情理解到**跨人装物多维度资源调度**方案生成的全流程自动化。

### 1.1 核心能力

- **灾情理解**: LLM解析自然语言灾情描述，提取结构化信息
- **规则推理**: 基于Neo4j知识图谱的TRR规则匹配
- **任务分解**: HTN层次任务网络分解，生成可执行任务序列
- **人装物调度**: 
  - **人**: 队伍调度（PostGIS空间查询 + 真实路径规划）
  - **装**: 装备调度（无人设备 + 传统装备）
  - **物**: 物资需求计算（基于国标人均标准）
- **方案优化**: NSGA-II多目标优化，5维评估体系

### 1.2 技术栈

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| 流程编排 | LangGraph 1.0 | 状态机管理、条件分支 |
| LLM | vLLM (gpt-oss-120b) | 灾情解析、方案解释 |
| RAG | Qdrant + Embedding | 相似案例检索 |
| KG | Neo4j | TRR规则存储、任务依赖查询 |
| 数据库 | PostgreSQL + PostGIS | 救援资源管理、空间查询 |
| 路径规划 | DatabaseRouteEngine (A*) | 真实路网路径规划 |
| 优化算法 | pymoo (NSGA-II) | 多目标Pareto优化 |

### 1.3 人装物调度架构

基于学术研究（OR-LLM-Agent, PLOS ONE 2025）的三层架构设计：

```
┌─────────────────────────────────────────────────────────────┐
│                    EmergencyAI Agent                        │
│                  (LangGraph 流程编排)                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              IntegratedResourceSchedulingCore               │
│                    (整合调度入口)                            │
├─────────────────┬─────────────────┬─────────────────────────┤
│ ResourceSchedul-│ EquipmentSched- │ SupplyDemandCalculator  │
│ ingCore (人)    │ uler (装)       │ (物)                     │
├─────────────────┼─────────────────┼─────────────────────────┤
│ - 队伍选择      │ - 无人设备调度   │ - 基于国标计算需求量     │
│ - NSGA-II优化   │ - 传统装备分配   │ - 支持5种灾害类型       │
│ - 真实路径规划   │ - 能力→装备映射  │ - 人均/天标准           │
└─────────────────┴─────────────────┴─────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   DatabaseRouteEngine                        │
│               (PostGIS路网 + A*路径规划)                     │
└─────────────────────────────────────────────────────────────┘
```

## 2. 系统架构

### 2.1 流程图

```
START
  │
  ▼
┌─────────────────────────────────────────┐
│ Phase 1: 灾情理解                        │
│ understand_disaster → enhance_with_cases │
│ [LLM解析] + [RAG检索] 并行执行            │
└─────────────────────────────────────────┘
  │
  ▼ (灾情解析成功?)
┌─────────────────────────────────────────┐
│ Phase 2: 规则推理                        │
│ query_rules → apply_rules                │
│ [Neo4j查询TRR规则] → [规则匹配与能力推导]  │
└─────────────────────────────────────────┘
  │
  ▼ (有匹配规则?)
┌─────────────────────────────────────────┐
│ Phase 2.5: HTN任务分解                   │
│ 场景识别 → 任务链合并 → 拓扑排序          │
│ [mt_library.json配置驱动]                │
└─────────────────────────────────────────┘
  │
  ▼ (有任务序列?)
┌─────────────────────────────────────────┐
│ Phase 3: 人装物资源调度                   │
│ match_resources → optimize_allocation    │
│ [队伍调度] + [装备调度] + [物资需求计算]   │
│ [IntegratedResourceSchedulingCore]       │
└─────────────────────────────────────────┘
  │
  ▼ (有候选方案?)
┌─────────────────────────────────────────┐
│ Phase 4: 方案优化                        │
│ filter_hard → score_soft → explain       │
│ [硬规则过滤] → [软规则评分] → [LLM解释]   │
└─────────────────────────────────────────┘
  │
  ▼
generate_output
  │
  ▼
END
```

### 2.2 状态定义

核心状态类型定义在 `state.py`:

```python
class EmergencyAIState(TypedDict):
    # 输入
    event_id: str                    # 事件ID
    scenario_id: str                 # 想定ID
    disaster_description: str        # 自然语言灾情描述
    structured_input: Dict           # 结构化输入（含location坐标）
    
    # 阶段1输出
    parsed_disaster: ParsedDisasterInfo   # LLM解析结果
    similar_cases: List[SimilarCase]      # RAG相似案例
    
    # 阶段2输出
    matched_rules: List[MatchedTRRRule]   # 匹配的TRR规则
    capability_requirements: List[...]     # 能力需求列表
    
    # 阶段2.5输出
    scene_codes: List[str]                # 场景代码 ["S1", "S2"]
    task_sequence: List[TaskSequenceItem] # 任务执行序列
    
    # 阶段3输出 - 人装物调度
    resource_candidates: List[...]         # 候选队伍（人）
    allocation_solutions: List[...]        # 分配方案
    equipment_allocations: List[...]       # 装备分配（装）★新增
    supply_requirements: List[...]         # 物资需求（物）★新增
    
    # 阶段4输出
    recommended_scheme: AllocationSolution # 推荐方案
    scheme_explanation: str               # 方案解释
```

## 3. 各阶段详解

### 3.1 Phase 1: 灾情理解

**文件**: `nodes/understanding.py`

**功能**:
1. LLM解析灾情描述，提取结构化信息
2. RAG检索相似历史案例
3. 两者并行执行，提高性能

**输出**:
```python
ParsedDisasterInfo:
    disaster_type: str       # earthquake/fire/hazmat/flood等
    severity: str            # critical/high/medium/low
    magnitude: float         # 震级（地震专用）
    estimated_trapped: int   # 预估被困人数
    affected_population: int # 受灾人口
    has_building_collapse: bool
    has_secondary_fire: bool
    has_hazmat_leak: bool
```

### 3.2 Phase 2: 规则推理

**文件**: `nodes/reasoning.py`

**功能**:
1. 从Neo4j查询TRR(Trigger-Response-Resource)规则
2. 根据灾情特征匹配适用规则
3. 推导能力需求列表

**TRR规则结构**:
```
(:Trigger {type, severity}) -[:TRIGGERS]-> (:Response {tasks})
(:Response) -[:REQUIRES]-> (:Resource {capabilities})
```

### 3.3 Phase 2.5: HTN任务分解

**文件**: `nodes/htn_decompose.py`, `utils/mt_library.py`

**功能**:
1. 场景识别: 根据灾情映射到场景代码(S1-S5)
2. 任务链加载: 从mt_library.json获取场景对应任务链
3. 任务合并: 多场景任务链合并去重
4. 拓扑排序: 基于依赖关系生成执行顺序

**场景映射**:
| 场景代码 | 场景名称 | 触发条件 |
|---------|---------|---------|
| S1 | 地震主灾 | disaster_type=earthquake |
| S2 | 次生火灾 | has_secondary_fire=true 或 disaster_type=fire |
| S3 | 危化品泄漏 | has_hazmat_leak=true 或 disaster_type=hazmat |
| S4 | 山洪泥石流 | disaster_type=flood/debris_flow/landslide |
| S5 | 暴雨内涝 | disaster_type=waterlogging |

### 3.4 Phase 3: 人装物资源调度 ★核心改进

**文件**: `nodes/matching.py`, `src/domains/resource_scheduling/`

**架构改进**: 基于OR-LLM-Agent学术研究，采用"LLM理解 → 传统算法求解 → LLM解释"模式。

#### 3.4.1 队伍调度（人）

**入口**: `ResourceSchedulingCore`

**功能**:
1. PostGIS空间查询可用队伍
2. 获取队伍关联车辆参数（速度、全地形能力）
3. DatabaseRouteEngine计算真实路径ETA（替代直线距离估算）
4. NSGA-II多目标优化生成Pareto方案

**ETA计算**:
```python
# 旧方案（已废弃）
eta = 直线距离 × 1.4 / 平均速度

# 新方案（真实路径规划）
route = DatabaseRouteEngine.plan_route(origin, destination, vehicle)
eta = route.duration_seconds / 60  # 考虑地形、坡度、灾害区域
```

**输出**:
```python
AllocationSolution:
    solution_id: str
    allocations: List[Dict]           # 队伍分配详情
    response_time_min: float          # 最大ETA（分钟）
    coverage_rate: float              # 能力覆盖率
    total_rescue_capacity: int        # 总救援容量
    capacity_warning: Optional[str]   # 容量不足警告
```

#### 3.4.2 装备调度（装）

**入口**: `EquipmentScheduler`

**功能**:
1. 查询能力→装备映射（capability_equipment_v2表）
2. 查询可用装备（devices_v2 + supplies_v2 where is_consumable=false）
3. 贪心策略分配（距离最近优先）

**数据表**:
```sql
-- 能力→装备映射表
capability_equipment_v2 (
    capability_code VARCHAR,    -- 能力编码
    equipment_type VARCHAR,     -- device/supply
    equipment_code VARCHAR,     -- 装备编码
    min_quantity INT,           -- 最少需求数量
    priority VARCHAR            -- required/recommended/optional
)
```

**初始数据示例**:
| 能力 | 装备类型 | 装备 | 数量 | 优先级 |
|------|---------|------|-----|-------|
| LIFE_DETECTION | supply | 雷达生命探测仪 | 1 | required |
| LIFE_DETECTION | device | 搜救机器狗 | 1 | optional |
| STRUCTURAL_RESCUE | supply | 液压破拆工具组 | 2 | required |
| WATER_RESCUE | supply | 冲锋舟 | 1 | required |
| WATER_RESCUE | device | 救援无人艇 | 1 | optional |

**输出**:
```python
EquipmentSchedulingResult:
    allocations: List[EquipmentAllocation]
    required_met: int           # 必须装备满足数
    required_total: int         # 必须装备总数
    fulfillment_rate: float     # 满足率
```

#### 3.4.3 物资需求计算（物）

**入口**: `SupplyDemandCalculator`

**功能**:
1. 查询物资需求标准（supply_standards_v2表）
2. 根据灾害类型、受灾人数、持续天数计算需求量
3. 公式: `需求量 = 人数 × 人均每天 × 天数`

**数据表**:
```sql
-- 物资需求标准表（参考国标GB/T 29426）
supply_standards_v2 (
    disaster_type VARCHAR,      -- 灾害类型
    supply_code VARCHAR,        -- 物资编码
    supply_name VARCHAR,        -- 物资名称
    per_person_per_day DECIMAL, -- 人均每天需求量
    unit VARCHAR,               -- 计量单位
    priority VARCHAR            -- critical/high/medium/low
)
```

**初始数据示例**:
| 灾害类型 | 物资 | 人均/天 | 单位 | 优先级 |
|---------|------|--------|------|-------|
| earthquake | 饮用水 | 2.5 | liter | critical |
| earthquake | 应急食品 | 0.5 | kg | critical |
| earthquake | 救灾帐篷 | 0.2 | unit | high |
| flood | 救生衣 | 1.0 | piece | critical |
| fire | 烧伤药膏 | 0.5 | tube | critical |

**输出**:
```python
DemandCalculationResult:
    disaster_type: str
    affected_count: int
    duration_days: int
    requirements: List[SupplyRequirement]  # 物资需求列表
```

**示例计算**（地震，1000人受灾，3天）:
```
饮用水: 1000 × 2.5 × 3 = 7500 升
应急食品: 1000 × 0.5 × 3 = 1500 kg
救灾帐篷: 1000 × 0.2 × 3 = 600 顶
```

### 3.5 Phase 4: 方案优化

**文件**: `nodes/optimization.py`

**功能**:
1. 硬规则过滤: 排除不满足强制约束的方案
2. 软规则评分: 5维评估体系加权评分
3. 方案排序: 选择最优推荐方案
4. LLM解释: 生成人类可读的方案说明

**5维评估体系**:
| 维度 | 权重 | 计算方式 |
|------|-----|---------|
| 成功率 | 0.35 | 基于能力覆盖和容量匹配 |
| 响应时间 | 0.30 | 基于最大ETA归一化 |
| 覆盖率 | 0.20 | 能力需求覆盖比例 |
| 风险 | 0.05 | 基于方案冗余度 |
| 冗余性 | 0.10 | 关键能力的备份覆盖 |

## 4. 数据库表结构

### 4.1 救援资源相关表

```sql
-- 救援队伍
rescue_teams_v2 (
    id UUID PRIMARY KEY,
    code VARCHAR,
    name VARCHAR,
    team_type team_type_enum,
    base_location GEOGRAPHY,
    total_personnel INT,
    available_personnel INT,
    capability_level INT,
    status VARCHAR
)

-- 队伍能力
team_capabilities_v2 (
    team_id UUID REFERENCES rescue_teams_v2,
    capability_code VARCHAR,
    capability_name VARCHAR,
    proficiency_level INT,
    max_capacity INT
)

-- 队伍车辆关联
team_vehicles_v2 (
    team_id UUID REFERENCES rescue_teams_v2,
    vehicle_id UUID REFERENCES vehicles_v2,
    is_primary BOOLEAN,
    status VARCHAR
)

-- 车辆
vehicles_v2 (
    id UUID PRIMARY KEY,
    code VARCHAR,
    name VARCHAR,
    max_speed_kmh INT,
    is_all_terrain BOOLEAN,
    terrain_capabilities TEXT[],
    terrain_speed_factors JSONB
)
```

### 4.2 装备调度相关表 ★新增

```sql
-- 能力→装备映射
capability_equipment_v2 (
    id UUID PRIMARY KEY,
    capability_code VARCHAR NOT NULL,
    equipment_type VARCHAR NOT NULL,  -- device/supply
    equipment_code VARCHAR NOT NULL,
    equipment_name VARCHAR,
    min_quantity INT DEFAULT 1,
    priority VARCHAR DEFAULT 'required'  -- required/recommended/optional
)

-- 物资需求标准
supply_standards_v2 (
    id UUID PRIMARY KEY,
    disaster_type VARCHAR NOT NULL,
    supply_code VARCHAR NOT NULL,
    supply_name VARCHAR,
    per_person_per_day DECIMAL NOT NULL,
    unit VARCHAR NOT NULL,
    priority VARCHAR DEFAULT 'medium'  -- critical/high/medium/low
)

-- 装备库存
equipment_inventory_v2 (
    id UUID PRIMARY KEY,
    equipment_type VARCHAR NOT NULL,
    equipment_id UUID NOT NULL,
    equipment_code VARCHAR NOT NULL,
    location_type VARCHAR NOT NULL,  -- shelter/team/vehicle/warehouse
    location_id UUID NOT NULL,
    total_quantity INT,
    available_quantity INT
)
```

### 4.3 路网相关表

```sql
-- 路网边
road_edges_v2 (
    id UUID PRIMARY KEY,
    from_node_id UUID,
    to_node_id UUID,
    geometry GEOGRAPHY,
    length_m FLOAT,
    max_speed_kmh INT,
    road_type VARCHAR,
    terrain_type VARCHAR,
    max_gradient_percent FLOAT,
    is_accessible BOOLEAN
)

-- 路网节点
road_nodes_v2 (
    id UUID PRIMARY KEY,
    lon FLOAT,
    lat FLOAT
)
```

## 5. API接口

### 5.1 同步分析接口

**路径**: `POST /api/v1/agents/emergency/analyze`

**请求体**:
```json
{
  "event_id": "evt-001",
  "scenario_id": "scn-001", 
  "disaster_description": "茂县发生6.5级地震，多处建筑倒塌，约150人被困",
  "structured_input": {
    "location": {"longitude": 103.8537, "latitude": 31.6815},
    "disaster_type": "earthquake"
  },
  "constraints": {
    "max_response_time_hours": 2.0,
    "max_teams": 200
  }
}
```

**响应体**:
```json
{
  "event_id": "evt-001",
  "recommended_scheme": {
    "solution_id": "nsga-abc123",
    "allocations": [
      {
        "resource_id": "team-001",
        "resource_name": "茂县消防救援大队",
        "assigned_capabilities": ["STRUCTURAL_RESCUE", "LIFE_DETECTION"],
        "eta_minutes": 12.5,
        "rescue_capacity": 30
      }
    ],
    "response_time_min": 25.3,
    "coverage_rate": 1.0,
    "total_rescue_capacity": 521
  },
  "equipment_allocations": [
    {
      "equipment_code": "SP-RESCUE-DETECTOR",
      "equipment_name": "雷达生命探测仪",
      "allocated_quantity": 2,
      "source_name": "茂县应急物资仓库",
      "for_capability": "LIFE_DETECTION"
    }
  ],
  "supply_requirements": [
    {
      "supply_code": "SP-LIFE-WATER",
      "supply_name": "饮用水",
      "quantity": 1125.0,
      "unit": "liter",
      "priority": "critical"
    }
  ],
  "task_sequence": [
    {"task_id": "EM01", "task_name": "无人机广域侦察", "sequence": 1},
    {"task_id": "EM06", "task_name": "人员搜救", "sequence": 2}
  ],
  "scheme_explanation": "本方案调度8支救援队伍，配备生命探测仪2台..."
}
```

## 6. 模块路径

```
src/
├── agents/
│   └── emergency_ai/
│       ├── __init__.py
│       ├── agent.py              # Agent入口
│       ├── graph.py              # LangGraph流程定义
│       ├── state.py              # 状态类型定义
│       └── nodes/
│           ├── understanding.py  # Phase 1: 灾情理解
│           ├── reasoning.py      # Phase 2: 规则推理
│           ├── htn_decompose.py  # Phase 2.5: HTN分解
│           ├── matching.py       # Phase 3: 人装物调度 ★
│           └── optimization.py   # Phase 4: 方案优化
│
├── domains/
│   └── resource_scheduling/      # 资源调度模块 ★新增
│       ├── __init__.py
│       ├── core.py               # 队伍调度核心
│       ├── schemas.py            # 队伍调度数据模型
│       ├── equipment_schemas.py  # 装备调度数据模型
│       ├── equipment_scheduler.py # 装备调度器
│       ├── demand_calculator.py  # 物资需求计算器
│       └── integrated_core.py    # 整合调度入口
│
├── planning/
│   └── algorithms/
│       └── routing/
│           └── db_route_engine.py # 路径规划引擎
│
└── sql/
    └── v6_resource_scheduling_tables.sql  # 装备/物资表定义
```

## 7. 配置文件

### 7.1 元任务库配置

**路径**: `config/emergency/mt_library.json`

### 7.2 私有配置

**路径**: `config/private.yaml`

```yaml
# LLM配置
OPENAI_BASE_URL: "http://192.168.31.50:8000/v1"
LLM_MODEL: "/models/gpt-oss-120b"

# RAG配置
QDRANT_URL: "http://192.168.31.50:6333"

# Neo4j配置
NEO4J_URI: "bolt://192.168.31.50:7687"

# PostgreSQL配置
POSTGRES_DSN: "postgresql://postgres:xxx@192.168.31.40:5432/emergency_agent"
```

## 8. 性能指标

| 指标 | 目标值 | 实测值 |
|-----|-------|-------|
| 端到端延迟 | <60s | ~45s |
| LLM调用次数 | ≤3 | 2 (并行) |
| 能力覆盖率 | ≥95% | 100% |
| 装备满足率 | ≥80% | 90%+ |
| 冗余度 | ≥0.5 | 0.69 |

## 9. 相关文档

- [路径规划智能体架构设计](./路径规划智能体架构设计.md)
- [任务智能分发智能体架构设计](./任务智能分发智能体架构设计.md)
- [算法设计文档](../algorithm_design.md)
