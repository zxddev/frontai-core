# 驻扎点选址智能体架构设计

> 版本: 2.0  
> 更新日期: 2025-11-27  
> 模块路径: `src/agents/staging_area/`

## 1. 系统概述

驻扎点选址智能体（StagingAreaAgent）是一个基于LangGraph构建的人机协作决策系统，用于地震救援场景下的救援队前沿驻扎点推荐。系统采用**Hybrid Agent**架构，结合LLM语义分析与传统算法计算，实现从灾情理解到可解释推荐的全流程智能化。

### 1.1 核心能力

- **灾情理解**: LLM解析自然语言灾情描述，提取约束条件
- **多维度分析**:
  - **地形分析**: 评估坡度、稳定性、展开空间
  - **通信分析**: 评估网络覆盖、备用方案
  - **安全分析**: 评估次生灾害风险、余震影响
- **智能评估**: PostGIS空间查询 + A*路径规划 + 多目标评分
- **动态权重**: 根据分析结果动态调整评分权重
- **可解释输出**: 生成推荐理由、风险警示、备选方案

### 1.2 技术栈

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| 流程编排 | LangGraph 1.0 | 状态机管理、并行执行 |
| LLM | vLLM (gpt-oss-120b) | 灾情解析、多维分析、解释生成 |
| 数据库 | PostgreSQL + PostGIS | 候选点搜索、空间查询 |
| 路径规划 | DatabaseRouteEngine (A*) | 真实路网路径验证 |

### 1.3 架构模式：Hybrid Agent

```
┌──────────────────────────────────────────────────────────────────┐
│                    StagingAreaAgent (LangGraph)                  │
├──────────────────────────────────────────────────────────────────┤
│  [灾情理解] → [地形分析] → [通信分析] → [安全分析] → [决策解释]  │
│     LLM        LLM           LLM          LLM          LLM       │
│      │           └─────────────┼────────────┘            │       │
│      │                    并行执行                        │       │
│      └─────────────────> [评估排序] <────────────────────┘       │
│                          算法计算                                │
├──────────────────────────────────────────────────────────────────┤
│          StagingAreaService → StagingAreaCore (算法层)           │
└──────────────────────────────────────────────────────────────────┘
```

## 2. 系统架构

### 2.1 6节点流程图

```
START
  │
  ▼
┌─────────────────────────────────────┐
│ understand_disaster                 │
│ [LLM解析灾情描述，提取约束]          │
└─────────────────────────────────────┘
  │
  ▼ (skip_llm_analysis?)
  ├── True ──────────────────────────────────────┐
  │                                              │
  ▼ False                                        │
┌───────────────┬───────────────┬───────────────┐│
│ analyze_      │ analyze_      │ analyze_      ││
│ terrain       │ communication │ safety        ││
│ [地形分析]    │ [通信分析]    │ [安全分析]    ││
│   LLM         │   LLM         │   LLM         ││
└───────┬───────┴───────┬───────┴───────┬───────┘│
        │               │               │        │
        └───────────────┼───────────────┘        │
                        │ 并行执行后汇聚          │
                        ▼                        │
┌─────────────────────────────────────┐          │
│ evaluate_candidates                 │◄─────────┘
│ [PostGIS搜索 + A*路径 + 多目标评分] │
│ [动态权重调整]                      │
└─────────────────────────────────────┘
  │
  ▼ (ranked_sites.length > 0?)
┌─────────────────────────────────────┐
│ explain_decision                    │
│ [LLM生成推荐理由、风险警示]          │
└─────────────────────────────────────┘
  │
  ▼
END
```

### 2.2 状态定义

核心状态类型定义在 `state.py`:

```python
class StagingAreaAgentState(TypedDict, total=False):
    # ===== 输入 =====
    disaster_description: str         # 自然语言灾情描述
    scenario_id: Optional[UUID]       # 想定ID
    epicenter_lon: Optional[float]    # 震中经度
    epicenter_lat: Optional[float]    # 震中纬度
    magnitude: Optional[float]        # 震级
    team_id: Optional[UUID]           # 队伍ID
    team_base_lon: Optional[float]    # 队伍驻地经度
    team_base_lat: Optional[float]    # 队伍驻地纬度
    rescue_targets: Optional[List[dict]]  # 救援目标列表
    skip_llm_analysis: bool           # 是否跳过LLM分析
    top_n: int                        # 返回前N个推荐
    
    # ===== LLM分析结果 =====
    parsed_disaster: Optional[ParsedDisasterInfo]      # 灾情解析结果
    terrain_assessments: Optional[List[TerrainAssessment]]  # 地形评估
    communication_assessments: Optional[List[CommunicationAssessment]]  # 通信评估
    safety_assessments: Optional[List[SafetyAssessment]]   # 安全评估
    
    # ===== 算法计算结果 =====
    candidate_sites: Optional[List[dict]]   # 候选点列表
    ranked_sites: Optional[List[dict]]      # 排序后的推荐
    
    # ===== 输出 =====
    site_explanations: Optional[List[SiteExplanation]]  # 推荐解释
    risk_warnings: Optional[List[RiskWarning]]          # 风险警示
    alternatives: Optional[List[AlternativeSuggestion]] # 备选方案
    summary: Optional[str]                              # 总结
    
    # ===== 元数据 =====
    processing_mode: str              # agent / algorithm_only / fallback
    overall_confidence: float         # 整体置信度
    errors: List[str]                 # 错误列表
    timing: dict                      # 各阶段耗时
```

## 3. 各节点详解

### 3.1 understand_disaster - 灾情理解节点

**文件**: `nodes/understand.py`

**功能**:
1. LLM解析自然语言灾情描述
2. 提取关键约束条件（道路阻断、区域淹没等）
3. 输出结构化灾情信息

**LLM Prompt核心**:
```
你是地震灾害分析专家。请分析以下灾情描述，提取：
1. 灾害类型和基本参数
2. 可能影响驻扎点选择的约束条件
3. 主要关切点
```

**输出** (`ParsedDisasterInfo`):
```python
{
    "disaster_type": "earthquake",
    "magnitude": 7.0,
    "epicenter_description": "茂县叠溪镇",
    "key_concerns": ["道路损毁严重", "通信可能中断"],
    "extracted_constraints": [
        {
            "constraint_type": "road_blocked",
            "description": "国道213线多处被滑坡阻断",
            "severity": "high",
            "confidence": 0.85
        }
    ]
}
```

### 3.2 analyze_terrain - 地形分析节点

**文件**: `nodes/terrain.py`

**功能**:
1. 评估候选点地形适宜性
2. 分析坡度、稳定性、展开空间
3. 识别地形风险

**输入数据**:
- `slope_degree`: 坡度（理想值<10°）
- `area_m2`: 面积（最小2000m²）
- `ground_stability`: 地质稳定性

**输出** (`TerrainAssessment`):
```python
{
    "site_id": "uuid",
    "site_name": "叠溪镇广场",
    "terrain_suitability": "good",
    "slope_assessment": "坡度5°，适合展开重型设备",
    "stability_assessment": "地质稳定，无滑坡风险",
    "expansion_space": "面积8000m²，可容纳50人营地",
    "terrain_risks": ["周边有裸岩，需注意落石"],
    "confidence": 0.85
}
```

### 3.3 analyze_communication - 通信分析节点

**文件**: `nodes/communication.py`

**功能**:
1. 评估网络覆盖质量
2. 识别通信风险
3. 提供通信冗余方案建议

**输入数据**:
- `primary_network_type`: 主要网络类型（5g/4g_lte/satellite等）
- `signal_quality`: 信号质量

**输出** (`CommunicationAssessment`):
```python
{
    "site_id": "uuid",
    "site_name": "叠溪镇广场",
    "primary_network_quality": "fair",
    "backup_options": ["卫星电话", "应急通信车"],
    "communication_risks": ["基站可能因余震损坏"],
    "recommended_equipment": ["北斗卫星终端", "短波电台"],
    "confidence": 0.80
}
```

### 3.4 analyze_safety - 安全分析节点

**文件**: `nodes/safety.py`

**功能**:
1. 评估次生灾害风险（滑坡、泥石流、堰塞湖）
2. 评估余震影响
3. 评估撤离可行性
4. 生成安全警示

**输入数据**:
- `distance_to_danger_m`: 距危险区距离
- 震中距离（用于余震评估）

**安全等级判定**:
| 等级 | 条件 |
|------|------|
| safe | 距危险区>1km，无次生灾害风险 |
| moderate_risk | 距危险区500-1000m，或有中等次生风险 |
| high_risk | 距危险区<500m，或有高次生风险 |
| dangerous | 位于危险区内，或有多重高风险 |

**输出** (`SafetyAssessment`):
```python
{
    "site_id": "uuid",
    "site_name": "叠溪镇广场",
    "safety_level": "moderate_risk",
    "secondary_hazard_risks": ["周边有滑坡隐患点"],
    "aftershock_impact": "震中距离15km，M7+地震72小时内余震风险高",
    "evacuation_feasibility": "有2条撤离路线，其中1条可能受滑坡影响",
    "safety_warnings": ["建议设置安全监测点"],
    "confidence": 0.85
}
```

### 3.5 evaluate_candidates - 评估排序节点

**文件**: `nodes/evaluate.py`

**功能**:
1. 调用StagingAreaService执行核心算法
2. PostGIS空间查询候选点
3. A*路径验证可达性
4. 多目标评分排序
5. **动态权重调整**（基于分析结果）

**动态权重调整逻辑**:
```python
# 默认权重
response_time = 0.35, safety = 0.25, logistics = 0.20, 
facility = 0.10, communication = 0.10

# 安全分析检测到高风险 → 提升 safety 权重
if high_risk_count > 0:
    safety = 0.35, response_time = 0.25

# 通信分析检测到问题 → 提升 communication 权重
if poor_comm_count > 50%:
    communication = 0.15, logistics = 0.15

# 地形分析检测到问题 → 调整 logistics 权重
if poor_terrain_count > 50%:
    logistics = 0.25, facility = 0.05
```

**输出** (`ranked_sites`):
```python
{
    "site_id": "uuid",
    "name": "叠溪镇广场",
    "total_score": 0.823,
    "scores": {
        "response_time": 0.85,
        "safety": 0.78,
        "logistics": 0.82,
        "facility": 0.90,
        "communication": 0.75
    },
    "route_from_base_distance_m": 85000,
    "route_from_base_duration_s": 5400,
    "avg_response_time_to_targets_s": 1200
}
```

### 3.6 explain_decision - 决策解释节点

**文件**: `nodes/explain.py`

**功能**:
1. 为每个推荐生成可理解的理由
2. 识别风险并生成警示
3. 提供备选方案建议

**输出**:
- `site_explanations`: 推荐理由、优势、注意事项
- `risk_warnings`: 风险警示及缓解建议
- `alternatives`: 备选方案（如道路进一步阻断时）
- `summary`: 总体推荐摘要

## 4. 数据库表结构

### 4.1 候选驻扎点表

```sql
CREATE TABLE operational_v2.rescue_staging_sites_v2 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    scenario_id UUID,
    site_code VARCHAR(50),
    name VARCHAR(200) NOT NULL,
    site_type VARCHAR(50),          -- open_ground/parking_lot/sports_field/...
    location GEOGRAPHY(POINT, 4326) NOT NULL,
    area_m2 NUMERIC(10,2),
    slope_degree NUMERIC(5,2),
    ground_stability VARCHAR(20),   -- excellent/good/moderate/poor/unknown
    has_water_supply BOOLEAN DEFAULT FALSE,
    has_power_supply BOOLEAN DEFAULT FALSE,
    can_helicopter_land BOOLEAN DEFAULT FALSE,
    primary_network_type VARCHAR(20),  -- 5g/4g_lte/satellite/...
    signal_quality VARCHAR(20),     -- excellent/good/fair/poor
    nearest_supply_depot_m NUMERIC(10,2),
    nearest_medical_point_m NUMERIC(10,2),
    nearest_command_post_m NUMERIC(10,2),
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 4.2 危险区域表

```sql
CREATE TABLE operational_v2.disaster_affected_areas_v2 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    scenario_id UUID NOT NULL,
    area_type VARCHAR(50),          -- danger_zone/blocked/flooded/fire/landslide
    geometry GEOGRAPHY(POLYGON, 4326),
    risk_level INT DEFAULT 5,       -- 1-10
    passable BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 5. API接口

### 5.1 Agent推荐接口

**路径**: `POST /api/v2/ai/staging-area`

**请求体**:
```json
{
  "scenario_id": "uuid",
  "epicenter_lon": 103.8537,
  "epicenter_lat": 31.6815,
  "magnitude": 7.0,
  "team_id": "uuid",
  "team_base_lon": 103.6177,
  "team_base_lat": 30.9884,
  "rescue_targets": [
    {"id": "uuid", "lon": 103.85, "lat": 31.70, "name": "叠溪镇", "priority": "critical"}
  ],
  "disaster_description": "茂县叠溪镇发生7.0级地震，多处道路被滑坡阻断...",
  "team_name": "四川消防救援总队",
  "top_n": 5,
  "skip_llm_analysis": false
}
```

**响应体**:
```json
{
  "success": true,
  "processing_mode": "agent",
  "recommended_sites": [
    {
      "site_id": "uuid",
      "name": "叠溪镇广场",
      "total_score": 0.823,
      "scores": {"response_time": 0.85, "safety": 0.78, ...}
    }
  ],
  "site_explanations": [
    {
      "site_id": "uuid",
      "site_name": "叠溪镇广场",
      "rank": 1,
      "recommendation_reason": "综合评分最高，响应时间短，安全性好",
      "advantages": ["有水电供应", "可直升机起降"],
      "concerns": ["周边有滑坡隐患点"],
      "confidence": 0.85
    }
  ],
  "risk_warnings": [
    {
      "warning_type": "secondary_hazard",
      "severity": "warning",
      "message": "推荐点#2位于潜在堰塞湖影响范围",
      "affected_sites": ["松坪沟停车场"],
      "mitigation_advice": "建议设置水位监测"
    }
  ],
  "alternatives": [
    {
      "scenario": "如果国道213线完全阻断",
      "suggested_site_id": "uuid",
      "suggested_site_name": "飞虹乡直升机坪",
      "reason": "该点可通过空运补给"
    }
  ],
  "summary": "推荐叠溪镇广场作为首选驻扎点，综合评分0.823...",
  "timing": {
    "understand_ms": 1200,
    "terrain_ms": 800,
    "communication_ms": 750,
    "safety_ms": 900,
    "evaluate_ms": 2500,
    "explain_ms": 1500,
    "total_ms": 7650
  }
}
```

### 5.2 纯算法接口（保留）

**路径**: `POST /api/v1/staging-area/recommend`

快速返回，无LLM分析，适用于需要低延迟的场景。

## 6. 模块路径

```
src/
├── agents/
│   └── staging_area/
│       ├── __init__.py           # 模块导出
│       ├── agent.py              # Agent入口类
│       ├── graph.py              # LangGraph流程定义（6节点）
│       ├── state.py              # 状态类型定义
│       ├── router.py             # FastAPI路由
│       ├── nodes/
│       │   ├── __init__.py
│       │   ├── understand.py     # 灾情理解节点
│       │   ├── terrain.py        # 地形分析节点
│       │   ├── communication.py  # 通信分析节点
│       │   ├── safety.py         # 安全分析节点
│       │   ├── evaluate.py       # 评估排序节点
│       │   └── explain.py        # 决策解释节点
│       └── tools/
│           └── __init__.py
│
├── domains/
│   └── staging_area/
│       ├── core.py               # 核心算法
│       ├── service.py            # 服务层
│       ├── repository.py         # 数据访问层
│       ├── schemas.py            # 数据模型
│       └── router.py             # 纯算法API
│
└── planning/
    └── algorithms/
        └── routing/
            └── db_route_engine.py  # A*路径规划
```

## 7. 降级机制

### 7.1 LLM超时降级

```
触发条件: LLM服务响应超时（>30秒）
处理方式: 自动调用StagingAreaCore纯算法
响应标注: processing_mode = "fallback"
```

### 7.2 skip_llm_analysis模式

```
触发条件: 请求参数 skip_llm_analysis = true
处理方式: 跳过所有LLM分析节点，直接执行evaluate
响应标注: processing_mode = "algorithm_only"
```

### 7.3 单节点失败容错

```
触发条件: terrain/communication/safety任一节点失败
处理方式: 捕获异常，记录错误，继续执行后续节点
权重调整: 缺失分析结果时使用默认权重
```

## 8. 性能指标

| 指标 | Agent模式 | 纯算法模式 |
|-----|----------|-----------|
| 端到端延迟 | ~8s | ~3s |
| LLM调用次数 | 5次（并行3次） | 0次 |
| 解释质量 | 高（含风险警示） | 基础（仅评分） |
| 权重调整 | 动态 | 固定 |

## 9. 相关文档

- [应急救援智能体架构设计](./应急救援智能体架构设计.md)
- [路径规划智能体架构设计](./路径规划智能体架构设计.md)
- [预警监测智能体架构设计](./预警监测智能体架构设计.md)
- [OpenSpec设计文档](../../openspec/changes/refactor-staging-area-to-agent/design.md)
