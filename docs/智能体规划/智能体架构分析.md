# EmergencyAI vs FrontlineRescueAgent æ™ºèƒ½ä½“æ¶æ„åˆ†æ

> **åˆ›å»ºæ—¶é—´**: 2025-12-02  
> **åˆ†æåŸºç¡€**: å®é™…ä»£ç æ·±åº¦åˆ†æ (1734è¡Œ matching.py + 403è¡Œ state.py + 328è¡Œ graph.py)  
> **ç»“è®º**: EmergencyAIè´¨é‡æ°´å¹³æ˜¾è‘—é«˜äºFrontlineRescueAgentï¼ŒçŸ­æœŸå†…éš¾ä»¥è¾¾åˆ°åŒç­‰æ°´å¹³

---

## ğŸ“Š ä»£ç è§„æ¨¡å¯¹æ¯”

### EmergencyAI Agent
```
src/agents/emergency_ai/
â”œâ”€â”€ agent.py              203è¡Œ   è¯¦ç»†æ–‡æ¡£+ç±»å‹æ³¨è§£+é”™è¯¯å¤„ç†
â”œâ”€â”€ state.py              403è¡Œ   50+ä¸ªTypedDictç±»å‹å®šä¹‰
â”œâ”€â”€ graph.py              328è¡Œ   å¤æ‚æ¡ä»¶è¾¹+æ™ºèƒ½è·¯ç”±  
â”œâ”€â”€ nodes/
â”‚   â”œâ”€â”€ matching.py       1734è¡Œ  ğŸ”¥æ ¸å¿ƒç®—æ³•å®ç°
â”‚   â”œâ”€â”€ understanding.py  350è¡Œ   LLM+RAG+ç‰©ç†æ¨¡å‹
â”‚   â”œâ”€â”€ optimization.py   709è¡Œ   ç¡¬è§„åˆ™+è½¯è§„åˆ™+LLMè§£é‡Š
â”‚   â””â”€â”€ ...
â””â”€â”€ tools/                è¯¦ç»†çš„å·¥å…·é›†
```

### FrontlineRescueAgent  
```
src/agents/frontline_rescue/
â”œâ”€â”€ agent.py              74è¡Œ    åŸºç¡€ç»“æ„
â”œâ”€â”€ state.py              ç®€å•çŠ¶æ€å®šä¹‰
â”œâ”€â”€ nodes/
â”‚   â”œâ”€â”€ allocate_resources.py  197è¡Œ  ä¸»è¦è°ƒç”¨å¤–éƒ¨æœåŠ¡
â”‚   â”œâ”€â”€ prioritize_events.py   147è¡Œ  åŸºæœ¬ä¼˜å…ˆçº§è®¡ç®—
â”‚   â””â”€â”€ ...
```

**è§„æ¨¡å·®å¼‚**: EmergencyAIæ ¸å¿ƒä»£ç  **2800+è¡Œ** vs FrontlineRescue **400è¡Œ**

---

## ğŸ¯ è´¨é‡ç»´åº¦è¯¦ç»†å¯¹æ¯”

### 1. ç±»å‹æ³¨è§£å®Œæ•´æ€§

#### EmergencyAI âœ… ä¼˜ç§€ç¤ºä¾‹
```python
@dataclass  
class VehicleProfile:
    """è½¦è¾†å‚æ•°é…ç½®"""
    speed_kmh: float           # æ­£å¸¸é“è·¯é€Ÿåº¦(km/h)
    mountain_speed_kmh: float  # å±±åŒºé“è·¯é€Ÿåº¦(km/h)
    is_all_terrain: bool       # æ˜¯å¦å…¨åœ°å½¢è½¦è¾†
    road_factor: float         # é“è·¯ç³»æ•°ï¼ˆç›´çº¿è·ç¦»â†’å®é™…è·ç¦»ï¼‰

class TaskResourceAssignment(TypedDict):
    """ä»»åŠ¡-èµ„æºåˆ†é…ï¼ˆå¯¹åº”æ€ä¼¤é“¾è·¯å¾„æ¦‚å¿µï¼‰"""
    task_id: str                          # HTNä»»åŠ¡ID
    task_name: str                        # ä»»åŠ¡åç§°
    resource_id: str                      # æ‰§è¡Œèµ„æºID
    resource_name: str                    # æ‰§è¡Œèµ„æºåç§°
    resource_type: str                    # èµ„æºç±»å‹
    execution_sequence: int               # æ‰§è¡Œé¡ºåº
    phase: str                            # ä»»åŠ¡é˜¶æ®µ
    eta_minutes: float                    # é¢„è®¡åˆ°è¾¾æ—¶é—´
    match_score: float                    # åŒ¹é…åˆ†æ•°(0-1)
    match_reason: str                     # åŒ¹é…åŸå› è¯´æ˜
```

#### FrontlineRescueAgent âš ï¸ åŸºç¡€æ°´å¹³
```python
async def allocate_resources_node(state: FrontlineRescueState) -> dict[str, Any]:
    # ç±»å‹æ³¨è§£ç›¸å¯¹ç®€å•ï¼Œç¼ºå°‘è¯¦ç»†çš„ä¸šåŠ¡ç±»å‹å®šä¹‰
```

### 2. é”™è¯¯å¤„ç†æœºåˆ¶

#### EmergencyAI âœ… å®Œå–„çš„å¼‚å¸¸å¤„ç†
```python
try:
    final_state = await self._graph.ainvoke(initial_state)
except Exception as e:
    logger.exception("EmergencyAIæ‰§è¡Œå¤±è´¥", extra={"error": str(e)})
    return {
        "success": False,
        "errors": [str(e)],
        "execution_time_ms": elapsed_ms,
        "trace": {...}  # è¯¦ç»†çš„æ‰§è¡Œè¿½è¸ª
    }
```

#### FrontlineRescueAgent âš ï¸ åŸºç¡€é”™è¯¯å¤„ç†
```python
# è™½ç„¶æœ‰_safe_åŒ…è£…ï¼Œä½†é”™è¯¯åä»ç»§ç»­æ‰§è¡Œåç»­æ— æ„ä¹‰èŠ‚ç‚¹
# ç¼ºå°‘è¯¦ç»†çš„é”™è¯¯ä¸Šä¸‹æ–‡å’Œæ¢å¤ç­–ç•¥
```

### 3. è¿½è¸ªå’Œç›‘æ§ç³»ç»Ÿ

#### EmergencyAI âœ… å®Œæ•´çš„Traceç³»ç»Ÿ
```python
# state.pyä¸­å®šä¹‰çš„è¯¦ç»†è¿½è¸ªå­—æ®µ
trace: Dict[str, Any]                    # æ‰§è¡Œè¿½è¸ª
execution_time_ms: int                   # æ‰§è¡Œæ—¶é—´
current_phase: str                       # å½“å‰é˜¶æ®µ
optimization_weights: Dict[str, float]   # ä¼˜åŒ–æƒé‡

# matching.pyä¸­çš„è¯¦ç»†æ€§èƒ½è¿½è¸ª
trace["supply_calculation"] = {
    "disaster_type": disaster_type,
    "affected_count": affected_population,
    "duration_days": 3,
    "supply_types": len(supply_requirements),
    "source": "SphereDemandCalculator",
    "elapsed_ms": supply_result.elapsed_ms,
}
```

#### FrontlineRescueAgent âŒ ç¼ºå°‘ç³»ç»Ÿæ€§è¿½è¸ª
```python
# åŸºæœ¬çš„current_phaseçŠ¶æ€ï¼Œç¼ºå°‘è¯¦ç»†çš„æ€§èƒ½å’Œæ‰§è¡Œè¿½è¸ª
```

---

## ğŸ§  ä¸šåŠ¡é€»è¾‘æ·±åº¦å¯¹æ¯”

### EmergencyAI: æ·±åº¦é¢†åŸŸé›†æˆ ğŸ†

#### ä¸“ä¸šæ¨¡å‹é›†æˆ
```python
# ä¼¤äº¡ä¼°ç®—ä¸“ä¸šæ¨¡å‹
casualty = await casualty_estimator.estimate_casualties(
    disaster_type=DisasterTypeEnum.EARTHQUAKE,
    severity=severity,
    affected_population=affected_population,
)

# Sphereå›½é™…äººé“ä¸»ä¹‰æ ‡å‡†
supply_result = await sphere_calculator.calculate(
    phase=ResponsePhase.IMMEDIATE,
    casualty_estimate=casualty,
    duration_days=3,
    climate=ClimateType.TEMPERATE,
)
```

#### å¤æ‚ç®—æ³•å®ç° 
```python
# è½¦è¾†å‚æ•°é…ç½®ï¼ˆåŸºäºé˜Ÿä¼ç±»å‹æ¨æ–­ï¼‰
TEAM_VEHICLE_PROFILES: Dict[str, VehicleProfile] = {
    "fire_rescue": VehicleProfile(
        speed_kmh=60.0,           # æ¶ˆé˜²è½¦åœ¨åŸå¸‚é“è·¯
        mountain_speed_kmh=35.0,  # å±±åŒºé“è·¯é™é€Ÿ
        is_all_terrain=True,      # æ¶ˆé˜²è½¦é€šå¸¸æœ‰è¶Šé‡èƒ½åŠ›
        road_factor=1.3,          # åŸå¸‚é“è·¯ç³»æ•°
    ),
    "medical": VehicleProfile(
        speed_kmh=70.0,           # æ•‘æŠ¤è½¦é€Ÿåº¦è¾ƒå¿«
        mountain_speed_kmh=40.0,
        is_all_terrain=False,     # æ ‡å‡†æ•‘æŠ¤è½¦éå…¨åœ°å½¢
        road_factor=1.25,
    ),
    # ... è¯¦ç»†é…ç½®
}
```

#### å¤šç›®æ ‡ä¼˜åŒ–ç®—æ³•
```python
def _greedy_allocation_with_capacity(
    candidates: List[Dict],
    capability_requirements: List[Dict], 
    strategy: str,
    solution_id: str,
    estimated_trapped: int,
    capacity_safety_factor: float,
) -> Optional[AllocationSolution]:
    # 100+è¡Œå¤æ‚è´ªå¿ƒç®—æ³•
    # åŒ…æ‹¬ï¼šèƒ½åŠ›åŒ¹é…ã€å®¹é‡è®¡ç®—ã€å†—ä½™æ€§å¢å¼º
    # NSGA-IIå¤šç›®æ ‡ä¼˜åŒ–é›†æˆ
```

### FrontlineRescueAgent: åŸºç¡€å¤–éƒ¨æœåŠ¡è°ƒç”¨

```python
# ä¸»è¦ä¾èµ–IntegratedResourceSchedulingCore
result = await team_scheduler.schedule(
    destination_lon=float(lon),
    destination_lat=float(lat),
    requirements=requirements,
    constraints=constraints,
    objectives=objectives,
)
# è‡ªèº«ä¸šåŠ¡é€»è¾‘è¾ƒå°‘ï¼Œä¸»è¦æ˜¯æ•°æ®è½¬æ¢å’Œç»“æœå°è£…
```

---

## ğŸ” å…³é”®æŠ€æœ¯å·®å¼‚

### 1. å›¾ç»“æ„å’Œæµç¨‹æ§åˆ¶

#### EmergencyAI: æ™ºèƒ½æ¡ä»¶è¾¹
```python
# graph.pyä¸­çš„æ™ºèƒ½è·¯ç”±é€»è¾‘
workflow.add_conditional_edges(
    "htn_decompose",
    should_continue_after_htn_decompose,  # æ™ºèƒ½åˆ¤æ–­ä¸‹ä¸€æ­¥
    {
        "classify_domains": "classify_domains",
        "generate_output": "generate_output", 
    }
)

def should_continue_after_resource_matching(state: EmergencyAIState) -> Literal["filter_hard_rules", "generate_output"]:
    """åˆ¤æ–­èµ„æºåŒ¹é…åæ˜¯å¦ç»§ç»­"""
    solutions = state.get("allocation_solutions", [])
    if not solutions:
        logger.warning("æ— å€™é€‰æ–¹æ¡ˆï¼Œè·³è½¬åˆ°è¾“å‡º")
        return "generate_output"
    return "filter_hard_rules"
```

#### FrontlineRescueAgent: çº¿æ€§æµç¨‹
```python
# ç®€å•çš„çº¿æ€§è¾¹è¿æ¥ï¼Œæ— æ™ºèƒ½è·¯ç”±
graph.add_edge("load_context", "prioritize_events")
graph.add_edge("prioritize_events", "allocate_resources")
graph.add_edge("allocate_resources", "hard_rules_check")
```

### 2. é…ç½®ç®¡ç†

#### EmergencyAI: ä¸¥æ ¼é…ç½®ç®¡ç†
```python
# ä»æ•°æ®åº“è·å–é…ç½®ï¼Œæ— fallbackï¼ˆç¬¦åˆç”¨æˆ·è¦æ±‚ï¼‰
async with AsyncSessionLocal() as config_db:
    config_service = AlgorithmConfigService(config_db)
    road_factor_config = await config_service.get_config_value(
        "ROAD_FACTOR_ADJUSTMENT", 
        default_value=None
    )
    if road_factor_config is None:
        raise ValueError("ç¼ºå°‘ROAD_FACTOR_ADJUSTMENTé…ç½®ï¼Œæ— æ³•è®¡ç®—çœŸå®è¡Œé©¶è·ç¦»")
```

#### FrontlineRescueAgent: é…ç½®ä¾èµ–é—®é¢˜
```python
# allocate_resources.pyç¬¬47è¡Œä¾èµ–FRONTLINE_ALLOCATION_CONSTRAINTS_V1
# é…ç½®ç¼ºå¤±å¯¼è‡´"æš‚æ— å¯ç”¨é˜Ÿä¼"é—®é¢˜
```

### 3. å•ä¾‹æ¨¡å¼å’Œæ€§èƒ½ä¼˜åŒ–

#### EmergencyAI: ä¼˜åŒ–çš„å›¾ç¼–è¯‘
```python
_compiled_graph = None

def get_emergency_ai_graph():
    """è·å–ç¼–è¯‘åçš„å›¾ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    global _compiled_graph
    if _compiled_graph is None:
        _compiled_graph = workflow.compile()
    return _compiled_graph
```

#### FrontlineRescueAgent: æ¯æ¬¡é‡æ–°ç¼–è¯‘
```python
def build_frontline_rescue_graph():
    return graph.compile(checkpointer=checkpointer)  # æ€§èƒ½æŸè€—
```

---

## ğŸ“ˆ è´¨é‡å·®è·é‡åŒ–åˆ†æ

| ç»´åº¦ | EmergencyAI | FrontlineRescueAgent | å·®è·è¯„ä¼° |
|------|-------------|---------------------|----------|
| **ä»£ç è§„æ¨¡** | 2800+è¡Œæ ¸å¿ƒé€»è¾‘ | 400è¡Œ | **7å€å·®è·** |
| **ç±»å‹æ³¨è§£å®Œæ•´æ€§** | 50+ä¸ªè¯¦ç»†TypedDict | åŸºç¡€ç±»å‹æ³¨è§£ | **æ˜¾è‘—å·®è·** |
| **é”™è¯¯å¤„ç†** | å®Œæ•´å¼‚å¸¸æ¢å¤+è¿½è¸ª | åŸºç¡€try-catch | **è¾ƒå¤§å·®è·** |
| **ä¸šåŠ¡é€»è¾‘æ·±åº¦** | æ·±åº¦é¢†åŸŸæ¨¡å‹é›†æˆ | å¤–éƒ¨æœåŠ¡è°ƒç”¨ | **å·¨å¤§å·®è·** |
| **ç®—æ³•å¤æ‚åº¦** | å¤šç›®æ ‡ä¼˜åŒ–+è´ªå¿ƒç®—æ³• | åŸºç¡€èµ„æºåŒ¹é… | **æ˜¾è‘—å·®è·** |
| **æ€§èƒ½ä¼˜åŒ–** | å•ä¾‹+ç¼“å­˜+å¹¶è¡Œ | åŸºç¡€å®ç° | **è¾ƒå¤§å·®è·** |
| **é…ç½®ç®¡ç†** | ä¸¥æ ¼æ•°æ®åº“é…ç½® | é…ç½®ä¾èµ–é—®é¢˜ | **ä¸­ç­‰å·®è·** |

**ç»¼åˆè¯„ä¼°**: EmergencyAIåœ¨æ‰€æœ‰ç»´åº¦éƒ½æ˜¾è‘—é¢†å…ˆï¼Œæ•´ä½“è´¨é‡å·®è·çº¦ä¸º **3-5å€**

---

## ğŸ¯ å·®è·æ ¹å› åˆ†æ

### 1. å¼€å‘æ—¶é—´æŠ•å…¥å·®å¼‚
- **EmergencyAI**: æ˜æ˜¾ç»è¿‡é•¿æœŸè¿­ä»£å’Œä¸“ä¸šå¼€å‘
- **FrontlineRescueAgent**: ç›¸å¯¹ç®€å•çš„å®ç°ï¼Œä¸»è¦ä¾èµ–å¤–éƒ¨æœåŠ¡

### 2. ä¸šåŠ¡å¤æ‚åº¦å·®å¼‚
- **EmergencyAI**: å•äº‹ä»¶æ·±åº¦åˆ†æï¼Œéœ€è¦å¤æ‚ç®—æ³•å’Œé¢†åŸŸçŸ¥è¯†
- **FrontlineRescueAgent**: å¤šäº‹ä»¶å…¨å±€è°ƒåº¦ï¼Œæ›´æ³¨é‡èµ„æºå†²çªé¿å…

### 3. è®¾è®¡ç†å¿µå·®å¼‚
- **EmergencyAI**: è‡ªåŒ…å«å®Œæ•´ç®—æ³•å®ç°
- **FrontlineRescueAgent**: ä¾èµ–å¤–éƒ¨æœåŠ¡çš„è½»é‡çº§Agent

---

## ğŸ’¡ å…³é”®æ´å¯Ÿ

### âœ… æ­£ç¡®è®¤çŸ¥
1. **EmergencyAIæ˜¯ä¸“ä¸šçº§ç³»ç»Ÿ**: ä¸æ˜¯ç®€å•çš„Agentï¼Œè€Œæ˜¯åŒ…å«æ·±åº¦é¢†åŸŸçŸ¥è¯†çš„ä¸“ä¸šæ•‘æ´åˆ†æç³»ç»Ÿ
2. **å¤æ‚åº¦è¢«ä½ä¼°**: 1734è¡Œçš„matching.pyåŒ…å«è½¦è¾†å‚æ•°ã€åœ°å½¢è°ƒæ•´ã€ä¼¤äº¡ä¼°ç®—ã€ä¾›åº”è®¡ç®—ç­‰å¤æ‚é€»è¾‘
3. **è´¨é‡å·®è·æ˜¾è‘—**: åœ¨ä»£ç è§„æ¨¡ã€ç±»å‹æ³¨è§£ã€é”™è¯¯å¤„ç†ã€ä¸šåŠ¡é€»è¾‘ç­‰æ‰€æœ‰ç»´åº¦éƒ½æœ‰æ˜æ˜¾å·®è·

### âš ï¸ é”™è¯¯å‡è®¾
1. ~~"å¯ä»¥å¿«é€Ÿé‡æ„åˆ°åŒç­‰è´¨é‡"~~ - **ç°å®**: éœ€è¦å¤§é‡æ—¶é—´å’Œä¸“ä¸šçŸ¥è¯†
2. ~~"ä¸»è¦æ˜¯æ¶æ„é—®é¢˜"~~ - **ç°å®**: æ›´å¤šæ˜¯ç®—æ³•å®ç°å’Œä¸šåŠ¡å»ºæ¨¡é—®é¢˜  
3. ~~"é…ç½®ä¸€ä¸‹å°±èƒ½å·¥ä½œ"~~ - **ç°å®**: éœ€è¦æ·±åº¦çš„é¢†åŸŸçŸ¥è¯†é›†æˆ

### ğŸ¯ ç°å®ç»“è®º
**çŸ­æœŸå†…æ— æ³•è¾¾åˆ°EmergencyAIçš„è´¨é‡æ°´å¹³**ï¼Œéœ€è¦è¯šå®é¢å¯¹æŠ€æœ¯å€ºåŠ¡ï¼Œé€‰æ‹©ç°å®å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚

---

## ğŸ“‹ å‚è€ƒä»£ç ä½ç½®

- **EmergencyAIæ ¸å¿ƒç®—æ³•**: `/src/agents/emergency_ai/nodes/matching.py:1-1734`
- **EmergencyAIçŠ¶æ€å®šä¹‰**: `/src/agents/emergency_ai/state.py:1-403`  
- **EmergencyAIå›¾ç»“æ„**: `/src/agents/emergency_ai/graph.py:1-328`
- **FrontlineRescueèµ„æºåˆ†é…**: `/src/agents/frontline_rescue/nodes/allocate_resources.py:1-197`
- **FrontlineRescueäº‹ä»¶ä¼˜å…ˆçº§**: `/src/agents/frontline_rescue/nodes/prioritize_events.py:1-147`

---

*æœ¬æ–‡æ¡£åŸºäº2025-12-02çš„å®é™…ä»£ç åˆ†æï¼Œä¸ºåç»­ä¼˜åŒ–å†³ç­–æä¾›å®¢è§‚ä¾æ®ã€‚*
