# 预警监测智能体架构设计

> 版本: 1.0  
> 更新日期: 2025-11-27  
> 模块路径: `src/agents/early_warning/`

## 1. 系统概述

预警监测智能体（EarlyWarningAgent / RealTimeRiskAgent）是一个基于LangGraph构建的实时风险预警系统，用于应急救援场景下的灾害预警和风险预测。系统采用双流程架构：**预警流程**（实时灾害通知）和**风险预测流程**（AI辅助决策），并实现了**Human-in-the-Loop**机制对红色风险进行人工审核。

### 1.1 核心能力

- **灾害数据接入**: 接收第三方灾情数据，存储灾害态势
- **影响分析**: 检测车辆和救援队伍是否在预警范围内或路径受影响
- **预警决策**: 根据距离阈值自动确定预警级别（红/橙/黄/蓝）
- **实时通知**: 通过WebSocket推送预警消息到前端
- **风险预测**:
  - **路径风险预测**: 综合气象、灾害态势分析行进路径风险
  - **作业风险评估**: 评估现场救援作业的安全风险
  - **灾害扩散预测**: 预测灾害在1h/6h/24h的扩散范围
- **人工审核**: 对红色风险实施Human-in-the-Loop审核机制

### 1.2 技术栈

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| 流程编排 | LangGraph 1.0 | 状态机管理、条件分支、中断恢复 |
| 数据库 | PostgreSQL + PostGIS | 灾害态势存储、空间查询 |
| 气象服务 | WeatherService (OpenMeteo) | 实时/预报气象数据 |
| 实时通信 | WebSocket | 预警消息推送 |
| 人工审核 | LangGraph interrupt_before | Human-in-the-Loop |

### 1.3 预警级别定义

| 级别 | 颜色 | 距离阈值 | 说明 |
|------|------|---------|------|
| 红色 | RED | <1km | 紧急预警，建议立即撤离或绕行 |
| 橙色 | ORANGE | 1-3km | 高度警戒，准备应急措施 |
| 黄色 | YELLOW | 3-5km | 注意预警，保持关注 |
| 蓝色 | BLUE | >5km | 提示信息，暂无直接威胁 |

## 2. 系统架构

### 2.1 双流程架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    EarlyWarningAgent                            │
│                  (LangGraph 流程编排)                            │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┴─────────────────────┐
        ▼                                           ▼
┌───────────────────────┐              ┌───────────────────────────┐
│   预警流程 (Warning)   │              │   风险预测流程 (Prediction) │
│   5个核心节点          │              │   4个预测节点              │
├───────────────────────┤              ├───────────────────────────┤
│ 1. ingest_disaster    │              │ 1. predict_path_risk      │
│ 2. analyze_impact     │              │ 2. predict_operation_risk │
│ 3. decide_warning     │              │ 3. predict_disaster_spread│
│ 4. generate_message   │              │ 4. human_review_gate      │
│ 5. send_notifications │              │    (interrupt_before)     │
└───────────────────────┘              └───────────────────────────┘
        │                                           │
        ▼                                           ▼
┌───────────────────────┐              ┌───────────────────────────┐
│    WebSocket推送       │              │    Human-in-the-Loop      │
│ (实时预警通知)         │              │ (红色风险人工审核)         │
└───────────────────────┘              └───────────────────────────┘
```

### 2.2 预警流程图

```
START
  │
  ▼
┌─────────────────────────────────────┐
│ ingest_disaster                     │
│ [接收灾害数据，解析边界和中心点]     │
└─────────────────────────────────────┘
  │
  ▼ (disaster_situation != null?)
┌─────────────────────────────────────┐
│ analyze_impact                      │
│ [查询影响范围内的车辆和队伍]         │
│ [计算距离，检查路径交叉]             │
└─────────────────────────────────────┘
  │
  ▼ (affected_vehicles + affected_teams > 0?)
┌─────────────────────────────────────┐
│ decide_warning                      │
│ [根据距离确定预警级别]              │
│ [生成预警标题和消息]                │
└─────────────────────────────────────┘
  │
  ▼ (warning_decisions.length > 0?)
┌─────────────────────────────────────┐
│ generate_message                    │
│ [创建预警记录对象]                  │
│ [准备存储数据]                      │
└─────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────┐
│ send_notifications                  │
│ [通过WebSocket推送预警]             │
│ [生成处理摘要]                      │
└─────────────────────────────────────┘
  │
  ▼ (prediction_request exists?)
  ├── yes ──> 进入风险预测流程
  │
  ▼ no
END
```

### 2.3 风险预测流程图

```
START (从预警流程notify节点进入)
  │
  ▼
┌─────────────────────────────────────┐
│ predict_path_risk                   │
│ [获取气象数据(WeatherService)]      │
│ [分析灾害距离影响]                  │
│ [计算综合路径风险]                  │
└─────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────┐
│ predict_operation_risk              │
│ [分析作业类型固有风险]              │
│ [评估灾害对作业的影响]              │
│ [生成安全建议]                      │
└─────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────┐
│ predict_disaster_spread             │
│ [获取风向风速数据]                  │
│ [计算1h/6h/24h扩散距离]             │
│ [生成扩散多边形]                    │
└─────────────────────────────────────┘
  │
  ▼ (pending_human_review.length > 0?)
  ├── yes ──┐
  │         ▼
  │   ┌─────────────────────────────────────┐
  │   │ human_review_gate                   │
  │   │ [interrupt_before 暂停执行]         │
  │   │ [等待人工审核决策]                  │
  │   │ (approved/rejected/modified)        │
  │   └─────────────────────────────────────┘
  │         │
  ▼         ▼
END ◄───────┘
```

## 3. 状态定义

核心状态类型定义在 `state.py`:

```python
class EarlyWarningState(TypedDict):
    # ========== 输入参数 ==========
    request_id: str                          # 请求ID
    scenario_id: Optional[str]               # 想定ID
    disaster_input: Optional[Dict[str, Any]] # 灾害数据输入
    
    # ========== 阶段1: 数据接入 ==========
    disaster_situation: Optional[DisasterSituation]  # 灾害态势
    
    # ========== 阶段2: 影响分析 ==========
    affected_vehicles: List[AffectedObject]  # 受影响车辆
    affected_teams: List[AffectedObject]     # 受影响队伍
    
    # ========== 阶段3: 预警决策 ==========
    warning_decisions: List[WarningDecision] # 预警决策列表
    
    # ========== 阶段4: 消息生成 ==========
    warning_records: List[WarningRecord]     # 预警记录
    
    # ========== 阶段5: 通知发送 ==========
    notifications_sent: int                  # 已发送通知数
    notification_errors: List[str]           # 通知错误
    
    # ========== 风险预测扩展 ==========
    prediction_request: Optional[Dict]       # 预测请求参数
    risk_predictions: List[RiskPrediction]   # 风险预测结果
    weather_context: Optional[Dict]          # 气象数据上下文
    pending_human_review: List[str]          # 待人工审核的预测ID
    
    # ========== 最终输出 ==========
    success: bool                            # 处理是否成功
    summary: str                             # 处理摘要
    
    # ========== 追踪信息 ==========
    trace: Dict[str, Any]                    # 执行追踪
    errors: List[str]                        # 错误列表
    current_phase: str                       # 当前阶段
```

### 3.1 核心数据结构

```python
class DisasterSituation(TypedDict):
    """灾害态势数据"""
    id: str
    scenario_id: Optional[str]
    disaster_type: str          # fire/flood/chemical/landslide/earthquake
    disaster_name: Optional[str]
    boundary: Polygon           # GeoJSON多边形
    center_point: Point         # 中心坐标
    buffer_distance_m: int      # 预警缓冲距离(米)
    spread_direction: Optional[str]   # 扩散方向 N/NE/E/SE/S/SW/W/NW
    spread_speed_mps: Optional[float] # 扩散速度 m/s
    severity_level: int         # 严重程度 1-5
    status: str                 # active/contained/resolved

class AffectedObject(TypedDict):
    """受影响对象"""
    object_type: str            # vehicle/team
    object_id: str
    object_name: str
    current_location: Point
    distance_to_disaster_m: float
    estimated_contact_minutes: Optional[int]
    route_affected: bool
    route_intersection_point: Optional[Point]
    notify_target_type: str     # commander/team_leader
    notify_target_id: Optional[str]
    notify_target_name: Optional[str]

class RiskPrediction(TypedDict):
    """风险预测结果"""
    prediction_id: str
    prediction_type: str        # path_risk/operation_risk/disaster_spread
    target_type: str            # team/area
    target_id: Optional[str]
    target_name: Optional[str]
    risk_level: str             # red/orange/yellow/blue
    risk_score: float           # 0-100
    confidence_score: float     # 0-1
    risk_factors: List[RiskFactor]
    recommendations: List[str]
    explanation: str
    prediction_horizon_hours: int
    requires_human_review: bool # True if risk_level == "red"
    weather_data: Optional[Dict]
    created_at: str
```

## 4. 各节点详解

### 4.1 ingest_disaster - 数据接入节点

**文件**: `nodes/ingest.py`

**功能**:
1. 接收第三方灾害数据
2. 解析边界多边形和中心点
3. 构建灾害态势对象

**输入**: `disaster_input` (Dict)
**输出**: `disaster_situation` (DisasterSituation)

**处理逻辑**:
```python
# 解析边界数据
boundary = Polygon(
    type="Polygon",
    coordinates=disaster_input["boundary"]["coordinates"]
)

# 计算中心点（如果未提供）
center_point = _calculate_center(boundary)

# 构建灾害态势
disaster_situation = DisasterSituation(
    id=str(uuid4()),
    disaster_type=disaster_input["disaster_type"],
    boundary=boundary,
    center_point=center_point,
    buffer_distance_m=disaster_input.get("buffer_distance_m", 3000),
    severity_level=disaster_input.get("severity_level", 3),
    ...
)
```

### 4.2 analyze_impact - 影响分析节点

**文件**: `nodes/analyze.py`

**功能**:
1. 查询场景中的车辆和队伍数据
2. 计算每个对象到灾害中心的距离（Haversine公式）
3. 检查路径是否与灾害边界相交
4. 筛选受影响对象

**距离计算**:
```python
def _haversine_distance(lon1, lat1, lon2, lat2) -> float:
    """Haversine公式计算球面距离(米)"""
    lat1_rad = math.radians(lat1)
    lat2_rad = math.radians(lat2)
    delta_lat = math.radians(lat2 - lat1)
    delta_lon = math.radians(lon2 - lon1)
    
    a = (math.sin(delta_lat / 2) ** 2 +
         math.cos(lat1_rad) * math.cos(lat2_rad) * 
         math.sin(delta_lon / 2) ** 2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    
    return EARTH_RADIUS_M * c  # 6371000 * c
```

**受影响判定**:
- 当前位置在缓冲区内 (`distance_m <= buffer_distance_m`)
- 或规划路径与灾害边界相交

### 4.3 decide_warning - 预警决策节点

**文件**: `nodes/decide.py`

**功能**:
1. 根据距离确定预警级别
2. 如果路径受影响但距离较远，提升预警级别
3. 生成预警标题和消息

**预警级别阈值**:
```python
WARNING_THRESHOLDS = {
    "red": 1000,      # <1km
    "orange": 3000,   # 1-3km
    "yellow": 5000,   # 3-5km
    "blue": float('inf'),  # >5km
}
```

**消息生成示例**:
```
标题: 【路径预警-橙色】救援队伍茂县消防大队
消息: 当前位置距火灾区域2500米，预计8分钟后可能接触危险区域，请及时处置
```

### 4.4 generate_message - 消息生成节点

**文件**: `nodes/generate.py`

**功能**:
1. 为每个预警决策创建预警记录
2. 生成唯一ID
3. 记录创建时间

**输出**: `warning_records` (List[WarningRecord])

### 4.5 send_notifications - 通知发送节点

**文件**: `nodes/notify.py`

**功能**:
1. 构建WebSocket通知消息
2. 通过ws_manager广播到订阅客户端
3. 记录发送结果和错误

**WebSocket消息格式**:
```json
{
  "warning_id": "uuid",
  "warning_level": "orange",
  "warning_title": "【路径预警-橙色】救援队伍茂县消防大队",
  "warning_message": "当前位置距火灾区域2500米...",
  "disaster_type": "fire",
  "disaster_name": "茂县山火",
  "affected_type": "team",
  "affected_id": "team-001",
  "affected_name": "茂县消防大队",
  "distance_m": 2500,
  "estimated_contact_minutes": 8,
  "route_affected": false,
  "actions": ["detour", "continue", "standby"],
  "created_at": "2025-11-27T10:00:00Z"
}
```

### 4.6 predict_path_risk - 路径风险预测节点

**文件**: `nodes/predict_path_risk.py`

**功能**:
1. 通过WeatherService获取气象数据（风速、降水）
2. 分析灾害距离对路径的影响
3. 计算综合风险等级和置信度
4. 生成行动建议

**风险因素**:
| 因素类型 | 数据来源 | 风险阈值 |
|---------|---------|---------|
| 风速 (wind) | WeatherService | >17m/s 红色, >10m/s 橙色, >5m/s 黄色 |
| 降水 (precipitation) | WeatherService | >50mm 红色, >25mm 橙色, >10mm 黄色 |
| 灾害距离 (disaster_proximity) | 空间计算 | <1km 红色, <3km 橙色, <5km 黄色 |

**置信度计算**:
```python
confidence = 0.6  # 基础置信度
if weather_available:
    confidence += 0.15
if disaster_available:
    confidence += 0.15
if route_available:
    confidence += 0.1
return min(confidence, 1.0)
```

### 4.7 predict_operation_risk - 作业风险评估节点

**文件**: `nodes/predict_operation_risk.py`

**功能**:
1. 获取当前气象条件
2. 分析灾害类型对作业的二次风险
3. 评估作业类型的固有风险
4. 生成安全建议

**作业类型固有风险**:
| 作业类型 | 风险因素 | 默认级别 | 描述 |
|---------|---------|---------|------|
| rescue | confined_space | yellow | 密闭空间作业风险 |
| firefighting | heat_exposure | orange | 高温暴露风险 |
| hazmat | chemical_exposure | red | 化学品接触风险 |
| height_work | fall_risk | orange | 高空坠落风险 |
| demolition | collapse_risk | orange | 结构坍塌风险 |

**灾害二次风险**:
| 灾害类型 | 二次风险 | 严重程度≥3时级别 |
|---------|---------|-----------------|
| fire | 燃烧蔓延风险 | orange |
| flood | 水位上涨风险 | orange |
| chemical | 化学品泄漏风险 | red |
| landslide | 二次滑坡风险 | red |
| earthquake | 余震风险 | orange |

### 4.8 predict_disaster_spread - 灾害扩散预测节点

**文件**: `nodes/predict_disaster_spread.py`

**功能**:
1. 获取风向风速数据
2. 计算不同时间尺度的扩散距离
3. 生成扩散区域多边形
4. 评估扩散风险级别

**扩散距离计算**:
```python
def _calculate_spread_distance(
    spread_speed_mps: float,    # 灾害自身扩散速度
    hours: int,                 # 预测时间
    wind_speed_ms: float = 0,   # 风速影响
    wind_factor: float = 0.3,   # 风速影响系数
) -> float:
    base_distance = spread_speed_mps * hours * 3600
    wind_contribution = wind_speed_ms * wind_factor * hours * 3600
    return base_distance + wind_contribution
```

**默认扩散速度**:
| 灾害类型 | 默认速度 (m/s) |
|---------|---------------|
| fire | 0.5 |
| flood | 0.3 |
| chemical | 0.2 |
| landslide | 0.1 |
| earthquake | 0 |

**扩散多边形生成**:
- 以灾害中心为顶点
- 沿风向（或指定扩散方向）展开
- 生成60°-90°的扇形区域

### 4.9 human_review_gate - 人工审核门控节点

**文件**: `nodes/human_review.py`

**功能**:
1. 检查是否有待审核的红色风险预测
2. 使用LangGraph的`interrupt_before`机制暂停执行
3. 等待人工审核决策
4. 支持三种决策：approved/rejected/modified

**Human-in-the-Loop机制**:
```python
# 图定义时启用中断
prediction_graph = build_prediction_only_graph().compile(
    interrupt_before=["human_review"]
)
```

**审核决策API**:
- `approve_prediction()`: 批准，按原风险等级执行
- `reject_prediction()`: 拒绝，降级为蓝色风险
- `modify_prediction()`: 修改风险等级

## 5. 数据库表结构

### 5.1 灾害态势表

```sql
CREATE TABLE operational_v2.disaster_situations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    scenario_id UUID,                           -- 关联想定ID
    disaster_type VARCHAR(50) NOT NULL,         -- fire/flood/chemical/landslide/earthquake
    disaster_name VARCHAR(200),
    boundary GEOGRAPHY(POLYGON, 4326),          -- 灾害范围多边形
    center_point GEOGRAPHY(POINT, 4326),        -- 中心点
    buffer_distance_m INT DEFAULT 3000,         -- 预警缓冲距离
    spread_direction VARCHAR(20),               -- 扩散方向 N/NE/E/SE/S/SW/W/NW
    spread_speed_mps NUMERIC(10,2),             -- 扩散速度 m/s
    severity_level INT DEFAULT 3,               -- 严重程度 1-5
    status VARCHAR(20) DEFAULT 'active',        -- active/contained/resolved
    source VARCHAR(100),                        -- 数据来源
    source_update_time TIMESTAMP,               -- 数据源更新时间
    properties JSONB DEFAULT '{}',              -- 扩展属性
    needs_response BOOLEAN DEFAULT TRUE,        -- 是否需要救援响应
    linked_event_id UUID,                       -- 关联事件ID
    map_entity_id UUID,                         -- 关联地图实体ID
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 5.2 预警记录表

```sql
CREATE TABLE operational_v2.warning_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    disaster_id UUID REFERENCES operational_v2.disaster_situations(id),
    scenario_id UUID,
    
    -- 受影响对象
    affected_type VARCHAR(20) NOT NULL,         -- vehicle/team
    affected_id UUID NOT NULL,
    affected_name VARCHAR(200),
    affected_location GEOGRAPHY(POINT, 4326),
    
    -- 通知目标
    notify_target_type VARCHAR(20) NOT NULL,    -- commander/team_leader
    notify_target_id UUID,
    notify_target_name VARCHAR(100),
    
    -- 预警信息
    warning_level VARCHAR(10) NOT NULL DEFAULT 'yellow',  -- red/orange/yellow/blue
    distance_m NUMERIC(10,2),
    estimated_contact_minutes INT,
    route_affected BOOLEAN DEFAULT FALSE,
    route_intersection_point GEOGRAPHY(POINT, 4326),
    
    -- 预警内容
    warning_title VARCHAR(200),
    warning_message TEXT,
    
    -- 状态跟踪
    status VARCHAR(20) DEFAULT 'pending',       -- pending/acknowledged/responded/resolved/cancelled
    response_action VARCHAR(20),                -- continue/detour/standby
    response_reason TEXT,
    selected_route_id VARCHAR(100),             -- 选择的绕行路线ID
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    acknowledged_at TIMESTAMP,
    responded_at TIMESTAMP,
    resolved_at TIMESTAMP,
    
    properties JSONB DEFAULT '{}'
);

-- 索引
CREATE INDEX idx_warning_records_disaster ON operational_v2.warning_records(disaster_id);
CREATE INDEX idx_warning_records_scenario ON operational_v2.warning_records(scenario_id);
CREATE INDEX idx_warning_records_status ON operational_v2.warning_records(status);
CREATE INDEX idx_warning_records_affected ON operational_v2.warning_records(affected_type, affected_id);
```

## 6. API接口

### 6.1 灾害数据更新接口

**路径**: `POST /api/v1/agents/early-warning/disasters/update`

**请求体**:
```json
{
  "scenario_id": "uuid",
  "disaster_type": "fire",
  "disaster_name": "茂县山火",
  "boundary": {
    "type": "Polygon",
    "coordinates": [[[103.85, 31.68], [103.86, 31.68], [103.86, 31.69], [103.85, 31.69], [103.85, 31.68]]]
  },
  "buffer_distance_m": 3000,
  "spread_direction": "NE",
  "spread_speed_mps": 0.5,
  "severity_level": 4,
  "source": "第三方监测系统",
  "needs_response": true
}
```

**响应体**:
```json
{
  "disaster_id": "uuid",
  "scenario_id": "uuid",
  "linked_event_id": "uuid",
  "map_entity_id": "uuid",
  "warnings_generated": 5,
  "affected_vehicles": 0,
  "affected_teams": 5,
  "notifications_sent": 5,
  "message": "已发送5条预警通知，涉及5个受影响对象",
  "scenario_warning": null
}
```

### 6.2 预警列表查询接口

**路径**: `GET /api/v1/agents/early-warning/warnings`

**查询参数**:
- `scenario_id`: 想定ID (可选)
- `status`: 状态过滤 pending/acknowledged/responded/resolved (可选)
- `page`: 页码，默认1
- `page_size`: 每页数量，默认20，最大100

**响应体**:
```json
{
  "items": [
    {
      "id": "uuid",
      "disaster_id": "uuid",
      "affected_type": "team",
      "affected_name": "茂县消防大队",
      "warning_level": "orange",
      "distance_m": 2500,
      "warning_title": "【路径预警-橙色】救援队伍茂县消防大队",
      "status": "pending",
      "created_at": "2025-11-27T10:00:00Z"
    }
  ],
  "total": 50,
  "page": 1,
  "page_size": 20
}
```

### 6.3 预警响应接口

**路径**: `POST /api/v1/agents/early-warning/warnings/{warning_id}/respond`

**请求体**:
```json
{
  "action": "detour",
  "reason": "路径存在火灾风险，选择绕行"
}
```

**action可选值**:
- `continue`: 继续前进
- `detour`: 申请绕行
- `standby`: 原地待命

### 6.4 绕行选项查询接口

**路径**: `GET /api/v1/agents/early-warning/warnings/{warning_id}/detour-options`

**响应体**:
```json
{
  "warning_id": "uuid",
  "original_route_distance_m": 5000,
  "original_route_duration_seconds": 600,
  "avoid_area": { "type": "Polygon", "coordinates": [...] },
  "options": [
    {
      "route_id": "uuid",
      "path_points": [{"lon": 103.85, "lat": 31.68}, ...],
      "total_distance_m": 6200,
      "total_duration_seconds": 744,
      "additional_distance_m": 1200,
      "additional_time_seconds": 144,
      "risk_level": "low",
      "description": "推荐路线：向北绕行，避开灾害区域"
    }
  ]
}
```

### 6.5 路径风险预测接口

**路径**: `POST /api/v1/agents/early-warning/predict/path-risk`

**请求体**:
```json
{
  "scenario_id": "uuid",
  "team_id": "uuid",
  "team_name": "茂县消防大队",
  "origin": {"lon": 103.85, "lat": 31.68},
  "destination": {"lon": 103.90, "lat": 31.72},
  "prediction_hours": 6
}
```

**响应体**:
```json
{
  "request_id": "uuid",
  "predictions": [
    {
      "prediction_id": "uuid",
      "prediction_type": "path_risk",
      "target_name": "茂县消防大队",
      "risk_level": "orange",
      "risk_score": 70,
      "confidence_score": 0.75,
      "risk_factors": [
        {"factor_type": "wind", "risk_level": "yellow", "value": 8.5, "description": "风速 8.5m/s"},
        {"factor_type": "disaster_proximity", "risk_level": "orange", "value": 2000, "description": "距灾害中心 2000m（较近）"}
      ],
      "recommendations": ["建议减速行驶，提高警惕", "准备备用路线"],
      "explanation": "气象分析：未来6小时\n  - 风速较大\n灾害态势：fire类型",
      "prediction_horizon_hours": 6,
      "requires_human_review": false
    }
  ],
  "pending_human_review": [],
  "success": true,
  "message": "路径风险预测完成，风险等级: orange"
}
```

### 6.6 人工审核接口

**路径**: `POST /api/v1/agents/early-warning/predictions/{prediction_id}/review`

**请求体**:
```json
{
  "prediction_id": "uuid",
  "reviewer_id": "user-001",
  "decision": "modified",
  "new_risk_level": "orange",
  "notes": "现场情况已得到控制，降低风险等级"
}
```

**decision可选值**:
- `approved`: 批准，按原风险等级执行
- `rejected`: 拒绝，降级为蓝色风险
- `modified`: 修改风险等级（需提供new_risk_level）

## 7. 模块路径

```
src/
├── agents/
│   └── early_warning/
│       ├── __init__.py           # 模块导出
│       ├── agent.py              # Agent入口类
│       ├── graph.py              # LangGraph流程定义
│       ├── state.py              # 状态类型定义
│       ├── models.py             # SQLAlchemy ORM模型
│       ├── schemas.py            # Pydantic请求响应模型
│       ├── repository.py         # 数据访问层
│       ├── router.py             # FastAPI路由
│       └── nodes/
│           ├── __init__.py
│           ├── ingest.py         # 数据接入节点
│           ├── analyze.py        # 影响分析节点
│           ├── decide.py         # 预警决策节点
│           ├── generate.py       # 消息生成节点
│           ├── notify.py         # 通知发送节点
│           ├── predict_path_risk.py        # 路径风险预测
│           ├── predict_operation_risk.py   # 作业风险评估
│           ├── predict_disaster_spread.py  # 灾害扩散预测
│           └── human_review.py   # 人工审核门控
│
├── domains/
│   └── weather/                  # 气象服务模块
│       ├── __init__.py
│       └── service.py            # WeatherService (OpenMeteo)
│
└── infra/
    └── clients/
        └── openmeteo/            # OpenMeteo API客户端
```

## 8. 依赖服务

### 8.1 WeatherService

**功能**: 提供气象数据查询服务

**主要方法**:
```python
class WeatherService:
    async def get_current_weather(lon: float, lat: float) -> CurrentWeather
    async def get_weather_forecast(lon: float, lat: float, hours: int) -> WeatherForecast
    async def get_weather_risk_summary(lon: float, lat: float, hours: int) -> WeatherRisk
```

**风险等级判定**:
- 风速: >17m/s 红色, >10m/s 橙色, >5m/s 黄色
- 降水: >50mm/h 红色, >25mm/h 橙色, >10mm/h 黄色

### 8.2 WebSocket Manager

**功能**: 管理WebSocket连接，广播预警消息

**主要方法**:
```python
class WebSocketManager:
    async def broadcast_disaster(data: Dict)
    async def broadcast_alert(scenario_id: UUID, alert_type: str, alert_data: Dict)
    async def broadcast_to_channel(channel: str, event_type: str, payload: Dict)
```

## 9. 配置参数

### 9.1 预警阈值配置

```python
# 预警级别距离阈值（米）
WARNING_THRESHOLDS = {
    "red": 1000,      # <1km
    "orange": 3000,   # 1-3km  
    "yellow": 5000,   # 3-5km
    "blue": float('inf'),  # >5km
}

# 默认缓冲距离（米）
DEFAULT_BUFFER_DISTANCE = 3000

# 假设行进速度（km/h）
ASSUMED_SPEED_KMH = 30
```

### 9.2 风险预测配置

```python
# 风险等级分数
RISK_SCORES = {
    "red": 90,
    "orange": 70,
    "yellow": 50,
    "blue": 20,
}

# 置信度计算权重
CONFIDENCE_WEIGHTS = {
    "base": 0.6,
    "weather": 0.15,
    "disaster": 0.15,
    "route": 0.1,
}
```

## 10. 相关文档

- [应急救援智能体架构设计](./应急救援智能体架构设计.md)
- [路径规划智能体架构设计](./路径规划智能体架构设计.md)
- [任务智能分发智能体架构设计](./任务智能分发智能体架构设计.md)
