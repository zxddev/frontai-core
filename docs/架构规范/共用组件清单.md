# 共用组件清单

本文档详细列出项目中所有可共用的组件能力，包括工具、服务、算法和类型定义。

> **注意**：本文档已根据实际代码库（`src/`）进行校准。

---

## 1. LLM 工具（可共用）

**位置**：`src/agents/emergency_ai/tools/llm_tools.py`

| 工具函数 | 功能 | 输入 | 输出 | 可复用场景 |
|---------|------|------|------|-----------|
| `parse_disaster_description` | 解析灾情文本 | 灾情描述文本 | DisasterParseResult | 任何需要理解灾情的场景 |
| `reason_rescue_priority` | 推理救援优先级 | 灾情信息+任务列表 | RescuePriorityResult | 任务排序、资源分配 |
| `explain_scheme` | 生成方案解释 | 方案对象 | 自然语言解释 | 所有需要输出解释的场景 |

**输出结构** (`DisasterParseResult`)：
```python
class DisasterParseResult(BaseModel):
    disaster_type: str      # 灾害类型
    severity: str           # 严重程度
    magnitude: Optional[float] # 震级
    has_building_collapse: bool
    has_trapped_persons: bool
    estimated_trapped: int
    has_secondary_fire: bool
    has_hazmat_leak: bool
    has_road_damage: bool
    affected_population: int
    building_damage_level: str # 建筑损坏等级 (severity/moderate/minor/none)
    key_entities: List[str]
    urgency_factors: List[str]
```

---

## 2. RAG 工具（可共用）

**位置**：`src/agents/emergency_ai/tools/rag_tools.py`
**底层客户端**：`src/infra/clients/qdrant_client.py` (类 `RagClient`)

| 工具函数 | 功能 | 输入 | 输出 | 可复用场景 |
|---------|------|------|------|-----------|
| `search_similar_cases` | 检索相似历史案例 | 查询文本、灾害类型、数量 | 案例列表 | 方案参考、经验借鉴 |

**依赖**：Qdrant 向量数据库

---

## 3. 知识图谱工具（可共用）

**位置**：`src/agents/emergency_ai/tools/kg_tools.py`
**底层客户端**：`src/infra/clients/neo4j_client.py` (类 `Neo4jClient`)

| 工具函数 | 功能 | 输入 | 输出 | 可复用场景 |
|---------|------|------|------|-----------|
| `query_trr_rules` | 查询 TRR 规则 | 灾害类型、严重程度 | 规则列表 | 任务分解、能力需求 |
| `query_capability_mapping` | 查询能力映射 | 能力编码列表 | 能力详情+队伍类型 | 资源匹配 |
| `query_task_dependencies` | 查询任务依赖 | 任务编码列表 | 前置/后置任务 | 任务调度 |

**依赖**：Neo4j 知识图谱

---

## 4. 路径规划算法（可共用）

**位置**：`src/planning/algorithms/routing/`

### 4.1 DatabaseRouteEngine (核心引擎)

**文件**：`src/planning/algorithms/routing/db_route_engine.py`
**类型**：独立引擎类 (不继承 AlgorithmBase)

| 方法 | 功能 | 输入 | 输出 |
|------|------|------|------|
| `plan_route` | A* 路径规划 | 起点、终点、车辆能力、灾害区域 | RouteResult |

**特性**：
- 基于 PostgreSQL 路网数据
- **定义了** `VehicleCapability` 类型
- 支持车辆约束（坡度、宽度、限重、限高、地形）
- 支持灾害区域避障

**调用者**：`RoutePlanningService`

### 4.2 VehicleRoutingPlanner (多车调度)

**文件**：`src/planning/algorithms/routing/vehicle_routing.py`

| 方法 | 功能 | 接口规范 |
|------|------|----------|
| `solve` | VRP 多车规划 | 继承 `AlgorithmBase` |

**特性**：
- 基于 OR-Tools
- 支持 CVRP（容量约束）和 VRPTW（时间窗约束）

### 4.3 OffroadEngine (越野)

**文件**：`src/planning/algorithms/routing/offroad_engine.py`

| 方法 | 功能 | 接口规范 |
|------|------|----------|
| `solve` | 越野 A* 规划 | 继承 `AlgorithmBase` |

---

## 5. 匹配算法（可共用）

**位置**：`src/planning/algorithms/matching/`

### 5.1 CapabilityMatcher (能力匹配)

**文件**：`src/planning/algorithms/matching/capability_matcher.py`

| 方法 | 功能 | 接口规范 |
|------|------|----------|
| `solve` | 能力-资源匹配 | 继承 `AlgorithmBase` |

**输入**：`capability_needs`, `resources`, `constraints`
**输出**：`AlgorithmResult` (含 `Assignment` 列表)

---

## 6. 优化算法（可共用）

**位置**：`src/planning/algorithms/optimization/`

### 6.1 PymooOptimizer (多目标优化)

**文件**：`src/planning/algorithms/optimization/pymoo_optimizer.py`

| 方法 | 功能 | 接口规范 |
|------|------|----------|
| `solve` | NSGA-II/III 优化 | 继承 `AlgorithmBase` |

**特性**：
- 自动选择 NSGA-II (2-3目标) 或 NSGA-III (>3目标)
- 支持自定义 Pymoo Problem

---

## 7. 评估算法（可共用）

**位置**：`src/planning/algorithms/assessment/`
**规范**：所有评估类均继承 `AlgorithmBase` 并实现 `solve` 方法。

*   `DisasterAssessment`: 灾情评估
*   `SecondaryHazardPredictor`: 次生灾害预测
*   `LossEstimator`: 损失估算
*   `ConfirmationScorer`: 事件确认度评分

---

## 8. 调度算法（可共用）

**位置**：`src/planning/algorithms/scheduling/`

### 8.1 TaskScheduler (任务调度)

**文件**：`src/planning/algorithms/scheduling/task_scheduler.py`

| 方法 | 功能 | 接口规范 |
|------|------|----------|
| `solve` | 任务调度 | 继承 `AlgorithmBase` |

---

## 9. 仲裁与仿真（可共用）

*   `ConflictResolver`: 冲突消解 (src/planning/algorithms/arbitration/)
*   `SceneArbitrator`: 场景仲裁
*   `DiscreteEventSimulator`: 离散事件仿真 (src/planning/algorithms/simulation/)

**接口**：均遵循 `AlgorithmBase.solve()` 规范。

---

## 11. 共用类型定义

**位置**：`src/planning/algorithms/routing/types.py`

| 类型 | 说明 | 字段 |
|------|------|------|
| `Point` | 经纬度点 | lon, lat |
| `CapabilityMetrics` | 车辆能力参数(简版) | width_m, height_m, slope_percent... |
| `Obstacle` | 障碍物 | id, type, hard, geometry |
| `PathCandidate` | 路径候选 | points, distance_m, duration_s... |

**位置**：`src/planning/algorithms/routing/db_route_engine.py`

| 类型 | 说明 | 字段 |
|------|------|------|
| `VehicleCapability` | **完整**车辆能力 | max_gradient_percent, terrain_capabilities... |

**位置**：`src/planning/algorithms/base.py`

| 类型 | 说明 | 字段 |
|------|------|------|
| `Location` | 位置 | lat, lng |
| `TimeWindow` | 时间窗 | start, end |
| `Resource` | 资源 | id, type, location, capabilities |
| `Task` | 任务 | id, location, duration... |
| `DisasterProfile` | 灾情画像 | type, level, location... |

---

## 12. 共用工具函数

**位置**：`src/planning/algorithms/routing/types.py`
*   `slope_deg_to_percent`: 角度转百分比
*   `slope_percent_to_deg`: 百分比转角度
*   `dedupe`: 列表去重

**位置**：`src/planning/algorithms/base.py`
*   `haversine_distance`: 计算两点距离
*   `estimate_travel_time`: 估算行驶时间

---

## 13. 共用服务 (Domains Services)

**位置**：`src/domains/`

| 服务类名 | 文件路径 | 功能 |
|---------|---------|------|
| `RoutePlanningService` | `routing/service.py` | 路径规划（高德 + 内部 DB 引擎 Fallback） |
| `TaskService` | `tasks/service.py` | 任务全生命周期管理 (CRUD, 状态流转) |
| `EventService` | `events/service.py` | 事件管理 |
| `SchemeService` | `schemes/service.py` | 方案管理 |
| `ResourceSchedulingService`| `resource_scheduling/service.py` | 资源调度服务 |
| `StagingAreaService` | `staging_area/service.py` | 驻扎点服务 |
| `PlottingService` | `plotting/service.py` | 态势标绘服务（点/圆/多边形/路线） |

---

## 14. 外部客户端 (Infra Clients)

**位置**：`src/infra/clients/`

| 客户端类/函数 | 文件 | 功能 |
|--------------|------|------|
| `RagClient` | `qdrant_client.py` | Qdrant 向量检索封装 (禁止降级) |
| `Neo4jClient` | `neo4j_client.py` | Neo4j 图谱查询封装 |
| `build_chat_model` | `llm_client.py` | LLM 客户端工厂函数 (vLLM 直连) |
| (模块) | `amap/` | 高德地图 API (路径规划、地理编码) |
| `amap_geocode_async` | `amap/geocode.py` | 地址转坐标 |
| (模块) | `tts/` | 语音合成 |
| (模块) | `asr/` | 语音识别 |
