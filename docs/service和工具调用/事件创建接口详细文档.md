# 事件创建接口详细文档

> 版本: 1.0  
> 创建时间: 2025-12-01  
> 作者: AI Assistant

---

## 一、概述

本文档详细说明如何通过API创建各类灾害事件，包括地震、人员被困、道路损毁、建筑物倒塌等。

### 1.1 接口总览

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 通用事件创建 | POST | `/api/v2/events` | 创建任意类型的事件 |
| 地震事件触发 | POST | `/api/v1/events/earthquake/trigger` | 模拟仿真专用，自动创建地图实体和风险区域 |

> **路径前缀说明**：
> - 通用事件接口挂载在 `/api/v2` 下
> - 前端适配接口支持两个前缀：`/api/v1` 和 `/web-api/api/v1`（功能相同）

---

## 二、支持的事件类型

```python
class EventType(str, Enum):
    earthquake = "earthquake"           # 地震（主震）
    trapped_person = "trapped_person"   # 人员被困
    fire = "fire"                       # 火灾
    flood = "flood"                     # 洪水
    landslide = "landslide"             # 泥石流/滑坡
    building_collapse = "building_collapse"  # 建筑物倒塌
    road_damage = "road_damage"         # 道路损毁
    power_outage = "power_outage"       # 电力中断
    communication_lost = "communication_lost"  # 通信中断
    hazmat_leak = "hazmat_leak"         # 危化品泄漏
    epidemic = "epidemic"               # 疫情
    earthquake_secondary = "earthquake_secondary"  # 次生灾害
    other = "other"                     # 其他
```

---

## 三、通用事件创建接口

### 3.1 接口信息

- **路径**: `POST /api/v2/events`
- **Content-Type**: `application/json`

### 3.2 请求参数

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| scenario_id | UUID | 是 | 想定ID |
| event_type | string | 是 | 事件类型枚举值 |
| source_type | string | 否 | 来源类型，默认 `manual_report` |
| source_detail | object | 否 | 来源详情（自定义JSON） |
| title | string | 是 | 事件标题（最大500字符） |
| description | string | 否 | 事件描述 |
| location | object | 是 | 位置坐标 `{longitude, latitude}` |
| address | string | 否 | 地址描述 |
| priority | string | 否 | 优先级，默认 `medium` |
| estimated_victims | int | 否 | 预估受灾/被困人数，默认 0 |
| is_time_critical | bool | 否 | 是否时间紧迫（黄金救援），默认 false |
| golden_hour_deadline | datetime | 否 | 黄金救援截止时间 |
| media_attachments | array | 否 | 媒体附件列表 |
| confirmation_score | float | 否 | AI确认评分 (0-1)，用于自动确认逻辑 |
| is_main_event | bool | 否 | 是否为想定主事件，默认 false |

### 3.3 来源类型枚举

```python
class EventSourceType(str, Enum):
    manual_report = "manual_report"       # 人工上报
    ai_detection = "ai_detection"         # AI检测
    sensor_alert = "sensor_alert"         # 传感器告警
    system_inference = "system_inference" # 系统推断
    external_system = "external_system"   # 外部系统
```

### 3.4 优先级枚举

```python
class EventPriority(str, Enum):
    critical = "critical"  # 紧急（红色）
    high = "high"          # 高（橙色）
    medium = "medium"      # 中（黄色）
    low = "low"            # 低（蓝色）
```

---

## 四、各类事件创建示例

### 4.1 地震事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "earthquake",
    "source_type": "sensor_alert",
    "source_detail": {
      "magnitude": 6.5,
      "depth_km": 10,
      "seismic_station": "SC-001"
    },
    "title": "北川县发生6.5级地震",
    "description": "震中位于北川县，震源深度10公里，预计影响范围30公里",
    "location": {
      "longitude": 104.4640,
      "latitude": 31.8234
    },
    "address": "四川省绵阳市北川县",
    "priority": "critical",
    "estimated_victims": 500,
    "is_time_critical": true,
    "golden_hour_deadline": "2025-12-01T20:00:00+08:00",
    "is_main_event": true
  }'
```

### 4.2 人员被困事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "trapped_person",
    "source_type": "manual_report",
    "source_detail": {
      "reporter_name": "张三",
      "reporter_phone": "138xxxx0001",
      "reporter_type": "victim_family"
    },
    "title": "凤仪镇居民楼有人员被困",
    "description": "5层居民楼部分倒塌，3楼有老人被困，可以听到呼救声",
    "location": {
      "longitude": 103.8510,
      "latitude": 31.6820
    },
    "address": "茂县凤仪镇幸福路12号",
    "priority": "critical",
    "estimated_victims": 3,
    "is_time_critical": true,
    "golden_hour_deadline": "2025-12-01T19:30:00+08:00"
  }'
```

### 4.3 道路损毁/抢修事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "road_damage",
    "source_type": "manual_report",
    "source_detail": {
      "road_name": "G213国道",
      "road_section": "K105+200 - K105+500",
      "damage_type": "collapse",
      "damage_length_m": 300,
      "passable": false
    },
    "title": "G213国道路面塌陷中断",
    "description": "G213国道K105路段发生塌陷，塌陷长度约300米，深度约5米，双向交通完全中断，需紧急抢修",
    "location": {
      "longitude": 103.9200,
      "latitude": 31.7500
    },
    "address": "G213国道K105+200路段",
    "priority": "high",
    "estimated_victims": 0,
    "is_time_critical": true
  }'
```

### 4.4 建筑物倒塌事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "building_collapse",
    "source_type": "ai_detection",
    "source_detail": {
      "building_type": "residential",
      "floors": 6,
      "collapse_degree": "partial",
      "detection_source": "drone_imagery"
    },
    "title": "曲山镇6层住宅楼部分倒塌",
    "description": "曲山镇中心6层住宅楼东侧3-6层倒塌，预计有住户被困",
    "location": {
      "longitude": 104.4500,
      "latitude": 31.8100
    },
    "address": "北川县曲山镇新民路28号",
    "priority": "critical",
    "estimated_victims": 15,
    "is_time_critical": true,
    "golden_hour_deadline": "2025-12-01T20:30:00+08:00"
  }'
```

### 4.5 火灾事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "fire",
    "source_type": "sensor_alert",
    "source_detail": {
      "fire_type": "building_fire",
      "fire_scale": "medium",
      "smoke_detected": true,
      "spread_risk": "high"
    },
    "title": "永昌镇化工厂发生火灾",
    "description": "化工厂仓库区域发生火灾，火势中等，有蔓延风险，周边500米需疏散",
    "location": {
      "longitude": 104.5100,
      "latitude": 31.7800
    },
    "address": "北川县永昌镇工业园区",
    "priority": "critical",
    "estimated_victims": 0,
    "is_time_critical": true
  }'
```

### 4.6 泥石流/滑坡事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "landslide",
    "source_type": "system_inference",
    "source_detail": {
      "landslide_type": "debris_flow",
      "volume_estimate_m3": 50000,
      "trigger": "earthquake_aftershock",
      "affected_area_m2": 20000
    },
    "title": "青片乡山体滑坡掩埋道路",
    "description": "青片乡后山发生滑坡，约5万立方米土石掩埋县道，可能有过往车辆被埋",
    "location": {
      "longitude": 104.3800,
      "latitude": 31.9000
    },
    "address": "北川县青片乡县道X098段",
    "priority": "high",
    "estimated_victims": 5,
    "is_time_critical": true
  }'
```

### 4.7 洪水事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "flood",
    "source_type": "sensor_alert",
    "source_detail": {
      "water_level_m": 8.5,
      "warning_level": "red",
      "dam_name": "通口河水库",
      "overflow_risk": true
    },
    "title": "通口河水位超警戒线",
    "description": "通口河水库水位达8.5米，超警戒线1.5米，下游村庄需紧急转移",
    "location": {
      "longitude": 104.5500,
      "latitude": 31.8500
    },
    "address": "北川县通口镇",
    "priority": "critical",
    "estimated_victims": 200,
    "is_time_critical": true
  }'
```

### 4.8 电力中断事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "power_outage",
    "source_type": "external_system",
    "source_detail": {
      "affected_substations": ["110kV北川站", "35kV曲山站"],
      "affected_households": 15000,
      "cause": "earthquake_damage",
      "estimated_restore_hours": 48
    },
    "title": "北川县城大面积停电",
    "description": "地震导致110kV北川站受损，县城及周边乡镇约1.5万户停电",
    "location": {
      "longitude": 104.4640,
      "latitude": 31.8234
    },
    "address": "北川县城区",
    "priority": "high",
    "estimated_victims": 0,
    "is_time_critical": false
  }'
```

### 4.9 通信中断事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "communication_lost",
    "source_type": "system_inference",
    "source_detail": {
      "affected_base_stations": 12,
      "affected_area_km2": 150,
      "signal_status": "no_signal",
      "landline_status": "damaged"
    },
    "title": "青片乡通信完全中断",
    "description": "青片乡12个基站全部失联，固话光缆中断，约3000人失联",
    "location": {
      "longitude": 104.3800,
      "latitude": 31.9000
    },
    "address": "北川县青片乡",
    "priority": "high",
    "estimated_victims": 0,
    "is_time_critical": true
  }'
```

### 4.10 危化品泄漏事件

```bash
curl -X POST "http://localhost:8000/api/v2/events" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario_id": "550e8400-e29b-41d4-a716-446655440000",
    "event_type": "hazmat_leak",
    "source_type": "manual_report",
    "source_detail": {
      "chemical_name": "液氨",
      "leak_volume_kg": 500,
      "leak_rate": "medium",
      "wind_direction": "NE",
      "evacuation_radius_m": 1000
    },
    "title": "工业园区液氨泄漏",
    "description": "地震导致化工厂储罐破裂，约500kg液氨泄漏，需疏散周边1公里居民",
    "location": {
      "longitude": 104.5100,
      "latitude": 31.7800
    },
    "address": "北川县永昌镇工业园区",
    "priority": "critical",
    "estimated_victims": 0,
    "is_time_critical": true
  }'
```

---

## 五、地震事件触发接口（模拟仿真专用）

### 5.1 接口信息

- **路径**: `POST /api/v1/events/earthquake/trigger`
- **备选路径**: `POST /web-api/api/v1/events/earthquake/trigger`
- **Content-Type**: `application/json`
- **特点**: 自动创建地图实体、风险区域、推送WebSocket动画

### 5.2 请求参数

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| scenarioId | UUID | 否 | 想定ID，不传则自动使用当前活动想定 |
| magnitude | decimal | 是 | 震级 (1.0-10.0) |
| location | object | 是 | 震中坐标 `{longitude, latitude}` |
| depthKm | decimal | 否 | 震源深度（公里），默认10 |
| epicenterName | string | 是 | 震中地名 |
| message | string | 否 | 自定义推送消息，不传则自动生成 |
| estimatedVictims | int | 否 | 预估受灾人数，默认0 |
| affectedAreaKm2 | decimal | 否 | 影响范围（平方公里） |
| animationDurationMs | int | 否 | 动画时长（毫秒），默认3000 |

### 5.3 请求示例

**不传 scenarioId（自动使用活动想定）：**

```bash
curl -X POST "http://localhost:8000/api/v1/events/earthquake/trigger" \
  -H "Content-Type: application/json" \
  -d '{
    "magnitude": 6.5,
    "location": {
      "longitude": 104.4640,
      "latitude": 31.8234
    },
    "depthKm": 10,
    "epicenterName": "北川县",
    "message": "北川县发生6.5级地震",
    "estimatedVictims": 500,
    "affectedAreaKm2": 2000,
    "animationDurationMs": 3000
  }'
```

**指定 scenarioId：**

```bash
curl -X POST "http://localhost:8000/api/v1/events/earthquake/trigger" \
  -H "Content-Type: application/json" \
  -d '{
    "scenarioId": "550e8400-e29b-41d4-a716-446655440000",
    "magnitude": 6.5,
    "location": {
      "longitude": 104.4640,
      "latitude": 31.8234
    },
    "epicenterName": "北川县"
  }'
```

> **注意**：如果不传 `scenarioId`，系统会自动查询数据库中状态为 `active` 的想定。如果没有活动想定，返回400错误。

### 5.4 响应示例

```json
{
  "code": 0,
  "message": "地震事件触发成功: 北川县发生6.5级地震",
  "data": {
    "eventId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "eventCode": "EVT-20251201-0001",
    "message": "北川县发生6.5级地震",
    "animationSent": true,
    "duplicate": false
  }
}
```

### 5.5 自动创建的内容

该接口会自动：

1. **创建事件记录** - 写入 `events_v2` 表
2. **创建地图实体** - 写入 `map_entities_v2` 表，包含热力图数据
3. **创建风险区域** - 写入 `disaster_affected_areas_v2` 表，包含：
   - 核心区（红色）：震中半径内，救援车辆可通行
   - 影响区（橙色）：较大范围，所有车辆降速通行
   - 外围区（黄色）：外围范围，正常通行
4. **推送WebSocket消息** - 广播到 `/topic/scenario.disaster.triggered`

---

## 六、事件状态流转

### 6.1 状态枚举

```python
class EventStatus(str, Enum):
    pending = "pending"            # 待确认
    pre_confirmed = "pre_confirmed"  # 预确认（30分钟倒计时）
    confirmed = "confirmed"        # 已确认
    planning = "planning"          # 方案制定中
    executing = "executing"        # 执行中
    resolved = "resolved"          # 已解决
    escalated = "escalated"        # 已升级
    cancelled = "cancelled"        # 已取消
```

### 6.2 自动确认逻辑

创建事件时，如果提供了 `confirmation_score`：

- `score >= 0.85`: 自动确认（auto_confirmed=true）
- `0.60 <= score < 0.85`: 预确认（30分钟倒计时）
- `score < 0.60` 或未提供: 待确认（pending）

特殊情况：`priority=critical` 且 `is_time_critical=true` 时，即使分数低于0.60也会进入预确认。

---

## 七、WebSocket推送格式

事件创建后会自动广播到 `/topic/scenario.disaster.triggered`：

```json
{
  "eventId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "title": "北川县发生6.5级地震",
  "eventLevel": 4,
  "eventType": 1,
  "location": [104.4640, 31.8234],
  "time": "2025-12-01T14:30:00Z",
  "origin": "sensor_alert",
  "data": "震中位于北川县，震源深度10公里",
  "eventCode": "EVT-20251201-0001",
  "status": "pending",
  "address": "四川省绵阳市北川县",
  "estimatedVictims": 500,
  "isTimeCritical": true,
  "scenarioId": "550e8400-e29b-41d4-a716-446655440000"
}
```

### eventLevel 映射

| priority | eventLevel | 显示颜色 |
|----------|------------|----------|
| critical | 4 | 红色 |
| high | 3 | 橙色 |
| medium | 2 | 黄色 |
| low | 1 | 蓝色 |

### eventType 映射

| event_type | eventType | 说明 |
|------------|-----------|------|
| earthquake | 1 | 地震 |
| trapped_person | 1 | 人员被困 |
| fire | 2 | 火灾 |
| flood | 3 | 洪水 |
| landslide | 4 | 泥石流 |
| building_collapse | 5 | 建筑倒塌 |
| road_damage | 6 | 道路损毁 |
| power_outage | 7 | 电力中断 |
| communication_lost | 8 | 通信中断 |
| hazmat_leak | 9 | 危化品泄漏 |
| epidemic | 10 | 疫情 |
| earthquake_secondary | 11 | 次生灾害 |
| other | 99 | 其他 |

---

## 八、错误处理

### 8.1 常见错误码

| 错误码 | HTTP状态 | 说明 |
|-------|---------|------|
| EV4001 | 404 | 事件不存在 |
| EV4004 | 400 | 想定不存在或未激活 |
| EV4005 | 409 | 无法更新已解决或已取消的事件 |

### 8.2 错误响应示例

```json
{
  "code": 400,
  "message": "无效的ID格式: badly formed hexadecimal UUID string",
  "data": null
}
```

---

## 九、最佳实践

### 9.1 创建事件时

1. **始终提供准确的位置信息** - `location` 是必填字段，精确的坐标有助于路径规划和资源调度
2. **合理设置优先级** - 根据实际紧急程度设置，避免所有事件都标为 `critical`
3. **填写预估受灾人数** - 即使是估计值，也有助于资源分配决策
4. **时间紧迫事件设置截止时间** - 对于人员被困等事件，设置 `golden_hour_deadline`

### 9.2 地震仿真时

1. **使用专用接口** - 地震事件优先使用 `/api/v1/events/earthquake/trigger`
2. **注意幂等性** - 同一想定下相同震中+震级的地震只会创建一次
3. **设置合理震级** - 震级影响风险区域大小和优先级自动计算

### 9.3 来源类型选择

- `manual_report`: 人工电话/现场上报
- `ai_detection`: AI图像/视频分析检测
- `sensor_alert`: 传感器（地震仪、水位计等）自动告警
- `system_inference`: 系统根据其他数据推断
- `external_system`: 第三方系统（110、119等）推送
