# 态势标绘服务

## 概述

态势标绘服务提供统一的地图标绘能力，封装 `EntityService`，根据标绘类型自动填充正确的 `properties`，确保前端能正确渲染动画效果。

## 架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        态势标绘能力                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────────────┐          ┌─────────────────────┐            │
│   │  PlottingService │          │ SituationPlotAgent  │            │
│   │  (独立标绘服务)   │◄─────────│ (对话式Agent)        │            │
│   └────────┬─────────┘          └─────────────────────┘            │
│            │                                                        │
│            ▼                                                        │
│   ┌──────────────────┐                                             │
│   │  EntityService   │ ───────► WebSocket ───────► 前端渲染        │
│   │  (map_entities)  │                                             │
│   └──────────────────┘                                             │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  调用方:                                                            │
│  1. POST /ai/plotting/* (直接调用API)                              │
│  2. POST /ai/situation-plot (对话式)                               │
│  3. 其他业务模块 (import PlottingService)                           │
└─────────────────────────────────────────────────────────────────────┘
```

## 标绘类型与前端渲染映射

| 标绘类型 | 前端事件 | 渲染效果 | 颜色 |
|---------|---------|---------|------|
| `event_point` | `ADD_EVENT_POINT` | 事件图标 | - |
| `rescue_target` | `ADD_POINT_IMG` | **波纹动画** | - |
| `situation_point` | `ADD_POINT_LABEL` | 文字标签 | - |
| `resettle_point` | `ADD_POINT_IMG` | 安置点图标 | - |
| `resource_point` | `ADD_POINT_IMG` | 资源点图标 | - |
| `danger_area` | `ADD_AREA_POINT` | 圆形区域 | 橙色 |
| `safety_area` | `ADD_AREA_POINT` | 圆形区域 | 绿色 |
| `command_post_candidate` | `ADD_AREA_POINT` | 圆形区域 | 蓝色 |
| `investigation_area` | `ADD_POLYGON_AREA` | 多边形 | 青色 |
| `planned_route` | `ADD_NAVIGATION_ROUTE` | 导航路线动画 | - |

## API 接口

### 1. 标绘点位

```
POST /ai/plotting/point
```

**请求体**:
```json
{
  "scenario_id": "uuid",
  "plotting_type": "rescue_target",
  "name": "救援点A",
  "longitude": 116.4,
  "latitude": 39.9,
  "description": "需紧急救援",
  "level": 3
}
```

**响应**:
```json
{
  "success": true,
  "entity_id": "uuid",
  "entity_type": "rescue_target",
  "message": "已标绘rescue_target: 救援点A"
}
```

### 2. 标绘圆形区域

```
POST /ai/plotting/circle
```

**请求体**:
```json
{
  "scenario_id": "uuid",
  "plotting_type": "danger_area",
  "name": "危化品泄漏区",
  "center_longitude": 116.4,
  "center_latitude": 39.9,
  "radius_m": 500,
  "description": "需紧急疏散"
}
```

### 3. 标绘多边形

```
POST /ai/plotting/polygon
```

**请求体**:
```json
{
  "scenario_id": "uuid",
  "plotting_type": "investigation_area",
  "name": "侦查区域A",
  "coordinates": [[116.4, 39.9], [116.5, 39.9], [116.5, 40.0], [116.4, 40.0]]
}
```

### 4. 标绘路线

```
POST /ai/plotting/route
```

**请求体**:
```json
{
  "scenario_id": "uuid",
  "name": "救援路线1",
  "coordinates": [[116.4, 39.9], [116.45, 39.92], [116.5, 39.95]],
  "device_type": "car",
  "is_selected": true
}
```

### 5. 标绘事件区域范围（三层多边形）

```
POST /ai/plotting/event-range
```

**请求体**:
```json
{
  "scenario_id": "uuid",
  "name": "滑坡影响范围",
  "outer_ring": [[103.80, 31.60], [103.90, 31.60], [103.90, 31.75], [103.80, 31.75], [103.80, 31.60]],
  "middle_ring": [[103.82, 31.63], [103.88, 31.63], [103.88, 31.72], [103.82, 31.72], [103.82, 31.63]],
  "inner_ring": [[103.84, 31.66], [103.86, 31.66], [103.86, 31.69], [103.84, 31.69], [103.84, 31.66]],
  "description": "外/中/内三层影响区域"
}
```

### 6. 标绘天气区域（雨区）

```
POST /ai/plotting/weather
```

**请求体**:
```json
{
  "scenario_id": "uuid",
  "name": "暴雨区域",
  "min_longitude": 103.48,
  "min_latitude": 31.06,
  "max_longitude": 103.50,
  "max_latitude": 31.12,
  "description": "预计持续强降雨"
}
```

### 7. 删除标绘

```
DELETE /ai/plotting/{entity_id}
```

### 8. 对话式标绘

```
POST /ai/situation-plot
```

**请求体**:
```json
{
  "scenario_id": "uuid",
  "message": "在北京市朝阳区画一个500米的危险区，标记为危化品泄漏"
}
```

**响应**:
```json
{
  "success": true,
  "response": "已在北京市朝阳区(116.4074, 39.9042)创建危险区域，半径500米，名称'危化品泄漏', ID: xxx-xxx"
}
```

## 前端刷新接口（页面初始化）

前端页面刷新/初始化时，通过 REST API 获取所有已存在的实体数据。

### 1. 获取所有实体

```
GET /api/v1/entities
```

**查询参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| scenarioId | string | 场景ID（必填，按场景筛选） |
| layerCode | string | 按图层编码筛选 |
| type | string | 按实体类型筛选 |
| includeHidden | boolean | 是否包含隐藏实体 |
| updatedSince | string | 返回指定时间后更新的实体 |
| page | number | 页码 (默认1) |
| pageSize | number | 每页数量 (默认20，最大100) |

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [...],
    "total": 15,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  }
}
```

### 2. 按图层获取实体

```
GET /api/v1/layers/{layerCode}/entities
```

**路径参数**: `layerCode` - 图层编码（如 `layer.rescue`、`layer.event`）

**查询参数**: 同上

### 3. 批量获取实体

```
POST /api/v1/entities/by-ids
```

**请求体**:
```json
{
  "ids": ["uuid-1", "uuid-2", "uuid-3"]
}
```

## 代码调用示例

### Python 直接调用

```python
from src.domains.plotting.service import PlottingService
from src.domains.plotting.schemas import PlotCircleRequest, PlottingType

# 标绘危险区域
result = await PlottingService.plot_circle(PlotCircleRequest(
    scenario_id=scenario_id,
    plotting_type=PlottingType.danger_area,
    name="危化品泄漏区",
    center_longitude=116.4,
    center_latitude=39.9,
    radius_m=500,
    description="需紧急疏散",
))

print(f"Entity ID: {result.entity_id}")
```

### 在其他Agent中调用

```python
from src.domains.plotting.service import PlottingService
from src.domains.plotting.schemas import PlotPointRequest, PlottingType

# 在救援方案生成后，自动标绘救援点
async def after_scheme_approved(scheme, scenario_id):
    for allocation in scheme["allocations"]:
        await PlottingService.plot_point(PlotPointRequest(
            scenario_id=scenario_id,
            plotting_type=PlottingType.rescue_target,
            name=allocation["team_name"],
            longitude=allocation["destination"]["longitude"],
            latitude=allocation["destination"]["latitude"],
            description=allocation["task_description"],
        ))
```

## 文件结构

```
src/domains/plotting/
├── __init__.py           # 模块导出
├── schemas.py            # Pydantic 数据模型
└── service.py            # PlottingService 实现

src/agents/situation_plot/
├── __init__.py           # Agent 模块导出
├── agent.py              # ReAct Agent 定义
├── schemas.py            # API 请求/响应 Schema
└── tools.py              # LangChain Tools

src/infra/clients/amap/
├── geocode.py            # 高德地理编码 (新增)
└── ...
```

## 依赖

- `EntityService` (`src/domains/map_entities/service.py`)
- `broadcast_entity_update()` (`src/core/websocket.py`)
- `create_react_agent` (`langgraph.prebuilt`)
- 高德地图 API Key (`AMAP_API_KEY`)
