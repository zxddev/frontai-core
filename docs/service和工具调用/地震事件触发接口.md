# 地震事件触发接口

## 概述

用于模拟仿真推演的地震事件触发接口，支持前端传入完整参数，**先推送动画效果，后创建真实事件记录**。

## 接口信息

| 属性 | 值 |
|------|-----|
| 路径 | `POST /api/v1/events/earthquake/trigger` |
| 认证 | 无（测试接口） |
| Content-Type | `application/json` |

## 执行流程

```
前端调用接口
    │
    ├─→ 1. 参数验证
    │
    ├─→ 2. 创建真实事件记录（入库）
    │       └─ 自动广播 /topic/scenario.disaster.triggered（事件数据）
    │
    ├─→ 3. 创建地震风险区域（入库 disaster_affected_areas_v2）
    │       ├─ 核心区: passage_status=needs_reconnaissance（需侦察）
    │       ├─ 影响区: passage_status=passable_with_caution（谨慎通行）
    │       └─ 外围区: passage_status=clear（安全通行）
    │
    ├─→ 4. 创建地震地图实体（热力图）
    │       └─ 广播 entity.created（前端地图渲染）
    │
    └─→ 5. 广播地震动画 WebSocket
            └─ /topic/scenario.disaster.triggered（动画数据）
            └─ 前端通过 animationType: "earthquake" 识别
```

## 请求参数

```json
{
    "scenarioId": "550e8400-e29b-41d4-a716-446655440000",  // 必填：想定ID（UUID格式）
    "magnitude": 6.5,               // 必填：震级（1.0-10.0）
    "location": {                   // 必填：震中位置
        "longitude": 104.5,
        "latitude": 31.2
    },
    "depthKm": 10,                  // 可选：震源深度（公里），默认10
    "epicenterName": "北川县",       // 必填：震中地名
    "message": "北川县发生6.5级地震", // 可选：自定义消息，不传则自动生成
    "estimatedVictims": 100,        // 可选：预估受灾人数，默认0
    "affectedAreaKm2": 500,         // 可选：影响范围（平方公里）
    "animationDurationMs": 3000     // 可选：动画时长（毫秒），默认3000
}
```

### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| scenarioId | UUID | ✅ | 想定ID |
| magnitude | Decimal | ✅ | 里氏震级，范围 1.0-10.0 |
| location | Object | ✅ | 震中坐标 |
| location.longitude | float | ✅ | 经度 -180~180 |
| location.latitude | float | ✅ | 纬度 -90~90 |
| depthKm | Decimal | ❌ | 震源深度（公里），默认10km |
| epicenterName | string | ✅ | 震中地名，如"北川县" |
| message | string | ❌ | 推送消息，不传则自动生成 |
| estimatedVictims | int | ❌ | 预估受灾人数 |
| affectedAreaKm2 | Decimal | ❌ | 影响范围（平方公里） |
| animationDurationMs | int | ❌ | 动画时长，范围1000-10000ms |

## 响应格式

### 成功响应

```json
{
    "code": 200,
    "message": "地震事件触发成功: 北川县发生6.5级地震",
    "data": {
        "eventId": "uuid",
        "eventCode": "EV-2024-001",
        "message": "北川县发生6.5级地震",
        "animationSent": true
    },
    "timestamp": "2024-11-28T10:00:00.000Z"
}
```

### 错误响应

```json
{
    "code": 500,
    "message": "地震事件触发失败: 详细错误信息",
    "data": null,
    "timestamp": "2024-11-28T10:00:00.000Z"
}
```

## WebSocket 消息格式

### 1. 地震动画消息

**主题**: `/topic/scenario.earthquake.triggered`

```json
{
    "payload": {
        "animationType": "earthquake",
        "magnitude": 6.5,
        "location": [104.5, 31.2],
        "epicenterName": "北川县",
        "depthKm": 10,
        "message": "北川县发生6.5级地震",
        "animationDurationMs": 3000,
        "timestamp": "2024-11-28T10:00:00.000Z",
        "scenarioId": "uuid",
        "estimatedVictims": 100,
        "affectedAreaKm2": 500
    }
}
```

### 2. 灾害事件消息

**主题**: `/topic/scenario.disaster.triggered`

由 `EventService.create()` 自动推送，格式与现有灾害事件一致。

## 震级与优先级映射

| 震级范围 | 优先级 | 说明 |
|---------|--------|------|
| ≥7.0 | critical | 特大地震 |
| 6.0-6.9 | high | 强烈地震 |
| 4.5-5.9 | medium | 中强地震 |
| <4.5 | low | 有感地震 |

## 前端集成指南

### 1. 订阅 WebSocket 主题

```javascript
// 订阅地震动画主题
stompClient.subscribe('/topic/scenario.earthquake.triggered', (message) => {
    const data = JSON.parse(message.body).payload;
    
    // 播放地震动画
    playEarthquakeAnimation({
        center: data.location,
        magnitude: data.magnitude,
        duration: data.animationDurationMs
    });
    
    // 显示弹窗
    showNotification({
        type: 'earthquake',
        title: '地震预警',
        message: data.message,
        location: data.epicenterName
    });
});
```

### 2. 调用触发接口

```javascript
const response = await fetch('/api/v1/events/earthquake/trigger', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        scenarioId: 'your-scenario-uuid',
        magnitude: 6.5,
        location: { longitude: 104.5, latitude: 31.2 },
        epicenterName: '北川县',
        message: '北川县发生6.5级地震'
    })
});

const result = await response.json();
console.log('事件ID:', result.data.eventId);
```

## 风险区域与通行状态

地震触发时会自动创建三个同心圆风险区域，写入 `disaster_affected_areas_v2` 表：

### 区域划分

| 区域 | area_type | 半径计算 | risk_level | passage_status |
|------|-----------|----------|------------|----------------|
| 核心区 | seismic_red | 2km × 1.5^(M-4) | 10 | needs_reconnaissance |
| 影响区 | seismic_orange | 核心区 × 2 | 7 | passable_with_caution |
| 外围区 | seismic_yellow | 核心区 × 4 | 4 | clear |

### passage_status 枚举

| 状态 | 说明 | 路径规划行为 |
|------|------|-------------|
| `confirmed_blocked` | 已确认不可通行（塌方、断桥） | 绝对绕行 |
| `needs_reconnaissance` | 高危但未确认，需侦察判断 | 默认绕行，标记为待侦察点 |
| `passable_with_caution` | 可通行但有风险（降速） | 增加成本权重，非必要绕行 |
| `clear` | 已确认安全 | 正常通行 |
| `unknown` | 未知状态（初始值） | 兼容旧数据，按 passable 字段处理 |

### 路径规划绕行逻辑

```python
# db_route_engine._get_blocked_edges() 核心逻辑
WHERE (
    passage_status = 'confirmed_blocked'  -- 绝对绕行
    OR (
        passage_status = 'needs_reconnaissance'
        AND allow_unverified_areas = false  -- 非侦察任务时绕行
    )
    OR (
        passable = false 
        AND passage_status = 'unknown'  -- 兼容旧数据
    )
)
```

### 侦察结果更新

侦察队/无人机返回后，可更新 passage_status：

```sql
UPDATE disaster_affected_areas_v2
SET passage_status = 'confirmed_blocked',  -- 或 'clear'
    reconnaissance_required = false,
    last_verified_at = NOW(),
    verified_by = :team_id
WHERE id = :area_id;
```

## 关联代码

| 文件 | 说明 |
|------|------|
| `src/domains/frontend_api/event/router.py` | 接口实现、`_create_earthquake_risk_zones()` |
| `src/domains/frontend_api/event/schemas.py` | 请求/响应模型 |
| `src/domains/events/schemas.py` | EventType.earthquake 定义 |
| `src/domains/events/service.py` | 事件创建服务 |
| `src/core/stomp/broker.py` | WebSocket 广播 |
| `src/planning/algorithms/routing/db_route_engine.py` | 路径规划绕行逻辑 |
| `src/domains/staging_area/schemas.py` | PassageStatus 枚举 |
| `sql/v15_passage_status_extension.sql` | 数据库迁移脚本 |

## 更新记录

| 日期 | 版本 | 说明 |
|------|------|------|
| 2024-11-28 | v1.0 | 初始版本，支持地震事件触发 |
| 2024-11-28 | v1.1 | 新增 passage_status 通行状态支持，风险区域自动创建 |
