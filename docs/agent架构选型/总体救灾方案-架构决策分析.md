# 总体救灾方案 - 架构决策分析

> 创建时间: 2024-11-29
> 状态: **决策完成**

## 一、核心结论

### 1.1 最终决策

| 决策项 | 结论 | 原因 |
|--------|------|------|
| 是否需要MetaGPT单独项目 | ❌ 不需要 | 现有算法库已覆盖所有核心计算 |
| 是否用MetaGPT替代现有算法 | ❌ 不建议 | 涉及人命的数字需要确定性算法 |
| 是否引入CrewAI | ⚠️ 可选 | 仅用于态势感知的信息综合 |
| 核心计算方式 | ✅ 现有算法库 | SphereDemandCalculator等 |
| 文本生成方式 | ✅ LLM + Jinja2模板 | instructor + vLLM guided_json |

### 1.2 核心原则

> **涉及人命的数字，用确定性算法；涉及理解的文本，用LLM**

---

## 二、现有算法库能力分析

### 2.1 已实现的15个核心算法

```
src/planning/algorithms/
├── assessment/                    # 灾情评估 [自实现]
│   ├── disaster_assessment.py     # 地震/洪涝/危化品评估
│   ├── secondary_hazard.py        # 次生灾害预测
│   └── loss_estimation.py         # 损失估算
│
├── matching/                      # 资源匹配 [OR-Tools + 贪心]
│   ├── capability_matcher.py      # CSP能力-资源匹配
│   └── vehicle_cargo_matcher.py   # 车辆-物资匹配
│
├── routing/                       # 路径规划 [OR-Tools + A*]
│   ├── vehicle_routing.py         # VRP多车辆路径
│   ├── offroad_engine.py          # 全地形A* (DEM+水域)
│   └── road_engine.py             # 路网A*
│
├── optimization/                  # 多目标优化 [pymoo]
│   ├── pymoo_optimizer.py         # NSGA-II/III
│   └── mcts_planner.py            # MCTS任务序列
│
├── arbitration/                   # 冲突仲裁 [自实现]
│   ├── conflict_resolver.py       # 资源冲突消解
│   └── scene_arbitrator.py        # TOPSIS多准则决策
│
├── scheduling/                    # 任务调度 [自实现]
│   └── task_scheduler.py          # 优先级/关键路径
│
└── simulation/                    # 仿真评估 [自实现]
    └── discrete_event_sim.py      # 蒙特卡洛仿真
```

### 2.2 Sphere标准实现

```
src/domains/disaster/
├── sphere_standards.py            # Sphere 2018标准定义
├── casualty_estimator.py          # USGS PAGER伤亡估算
└── sphere_demand_calculator.py    # 物资需求计算器

src/domains/resource_scheduling/
└── sphere_demand_calculator.py    # 整合版物资计算
```

**关键特性：**
- 17/17 单元测试通过
- 符合Sphere Handbook 2018标准
- 支持气候因素调整
- 支持特殊需求群体

---

## 三、MetaGPT vs 现有算法的对比分析

### 3.1 可靠性对比

| 维度 | 现有算法库 | MetaGPT动态代码 | 纯LLM计算 |
|------|-----------|----------------|-----------|
| **确定性** | ✅ 相同输入=相同输出 | ❌ 每次可能不同 | ❌ 高度不确定 |
| **可追溯** | ✅ 代码可审查 | ⚠️ 需记录生成代码 | ❌ 黑盒 |
| **可测试** | ✅ 单元测试 | ⚠️ 难以测试 | ❌ 无法测试 |
| **可审计** | ✅ 计算日志 | ⚠️ 需额外机制 | ❌ 无法审计 |
| **风险等级** | 低 | 中-高 | 极高 |

### 3.2 场景适用性对比

| 场景 | 现有算法 | MetaGPT | 推荐 |
|------|----------|---------|------|
| 物资需求计算 | SphereDemandCalculator | Data Interpreter | ✅ 现有算法 |
| 资源匹配 | CapabilityMatcher (OR-Tools) | 动态CSP代码 | ✅ 现有算法 |
| 路径规划 | VRP + A* | 无法替代 | ✅ 现有算法 |
| 伤亡估算 | CasualtyEstimator (PAGER) | 动态建模 | ✅ 现有算法 |
| 态势综述 | LLM + 模板 | CrewAI协作 | ⚠️ 两者皆可 |
| 文档生成 | Jinja2模板 | SOP流程 | ✅ Jinja2 |

### 3.3 为什么MetaGPT的PRD能力不适用于救灾方案

| PRD（产品需求文档） | 救灾方案（行动指令） |
|-------------------|-------------------|
| 强调创意和用户故事 | 强调精确和可执行 |
| 允许模糊表达 | 每个数字都必须精确 |
| 面向产品设计 | 面向应急执行 |
| 迭代修改 | 一次性定稿 |

---

## 四、推荐架构

### 4.1 三层分离架构

```
┌─────────────────────────────────────────────────────────────┐
│                     LangGraph Orchestrator                   │
│                 (状态管理 + HITL审批 + 容错)                  │
└────────────────────────┬────────────────────────────────────┘
                         │
    ┌────────────────────┼────────────────────┐
    │                    │                    │
    ▼                    ▼                    ▼
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│ LLM层   │      │ 算法层      │      │ 模板层      │
│ (感知)  │      │ (计算)      │      │ (生成)      │
└─────────┘      └─────────────┘      └─────────────┘
    │                    │                    │
    ▼                    ▼                    ▼
• 总体描述        • SphereDemand-       • Jinja2模板
• 灾情综述          Calculator          • Word模板
• 次生灾害分析    • CasualtyEstimator   • 格式化输出
  (定性部分)      • CapabilityMatcher
                 • VRP路径规划
```

### 4.2 并发执行方案

```python
async def generate_plan(scenario_id):
    # 1. 加载上下文
    context = await load_context_node(state)
    
    # 2. 并发执行各模块（7章对应的计算）
    results = await asyncio.gather(
        # === 算法计算（确定性，可并发） ===
        calculate_casualty_estimate(context),      # 伤亡估算
        calculate_sphere_demands(context),         # Sphere物资需求
        match_rescue_teams(context),               # 资源匹配
        calculate_logistics(context),              # 物资调配计算
        
        # === LLM生成（叙事性，可并发） ===
        generate_overview_llm(context),            # 总体描述
        generate_situation_summary_llm(context),   # 灾情综述
        analyze_secondary_hazards_llm(context),    # 次生灾害定性分析
        generate_command_structure_llm(context),   # 组织指挥描述
    )
    
    # 3. 汇总到模板
    document = render_template(results)
    
    # 4. HITL审批
    return await human_review(document)
```

### 4.3 7章内容的分工

| 章节 | 任务特性 | 实现方式 | 并发组 |
|------|----------|----------|--------|
| 0. 总体描述 | 叙事综合 | LLM | A |
| 1. 灾情评估 | 数据汇总+格式化 | 算法+LLM | A |
| 2. 组织指挥 | 模板填充 | 数据库查询+模板 | B |
| 3. 救援力量部署 | 资源匹配 | CapabilityMatcher | B |
| 4. 次生灾害 | 预测+分析 | 算法+LLM | A |
| 5. 通信保障 | Sphere计算 | SphereDemandCalculator | C |
| 6. 物资调配 | Sphere计算+缺口分析 | SphereDemandCalculator | C |
| 7. 救援自身保障 | Sphere计算 | SphereDemandCalculator | C |

**并发组说明：**
- A组：感知类（依赖相同的灾情数据）
- B组：匹配类（依赖资源数据）
- C组：计算类（纯Sphere标准计算）

---

## 五、未来扩展场景

### 5.1 何时考虑引入MetaGPT

1. **新灾害类型建模**
   - 场景：出现未知病毒爆发，需要动态建立传播模型
   - MetaGPT价值：Data Interpreter可以根据论文动态编写模型代码

2. **非结构化数据集成**
   - 场景：需要分析大量历史救灾案例文档
   - MetaGPT价值：可以动态编写NLP处理代码

3. **创新策略生成**
   - 场景：研究性质的"如果...会怎样"分析
   - MetaGPT价值：多Agent头脑风暴

4. **外部API动态集成**
   - 场景：需要接入未知的气象API
   - MetaGPT价值：可以根据API文档动态生成调用代码

### 5.2 如果决定引入MetaGPT

建议作为**独立的研究模块**，而非替代核心计算：

```
frontai-core/                 # 主项目（生产）
├── src/planning/algorithms/  # 确定性算法
└── src/agents/overall_plan/  # LangGraph编排

frontai-research/             # 研究项目（实验）
└── src/metagpt_experiments/  # MetaGPT实验
    ├── dynamic_modeling/     # 动态建模
    ├── case_analysis/        # 案例分析
    └── strategy_innovation/  # 策略创新
```

---

## 六、需求-能力差距分析

### 6.1 7章内容 vs 现有算法对照

| 章节 | 子项 | 需求 | 现有算法 | 状态 |
|------|------|------|----------|------|
| **一、灾情评估** | 人员伤亡 | 死亡/受伤/失踪/被困 | `CasualtyEstimator` | ✅ 完整 |
| | 房屋损毁 | 倒塌/严重/一般损坏 | `LossEstimator.BuildingDamage` | ✅ 完整 |
| | 交通设施 | 道路/桥梁损毁 | `LossEstimator.Infrastructure` | ✅ 完整 |
| | 通信电力 | 中断情况 | `LossEstimator.Infrastructure` | ✅ 完整 |
| **二、组织指挥** | 工作组配置 | 12类工作组 | `command_group_templates_v2` | ✅ 数据库 |
| | 指挥机制 | 文本描述 | LLM生成 | ✅ LLM |
| **三、救援部署** | 力量配置 | 按队伍类型分配 | `CapabilityMatcher` | ✅ 完整 |
| | 医疗部署 | 医疗点/床位/医护 | `SphereDemandCalculator` | ⚠️ 需扩展 |
| | 工程抢险 | 抢修安排 | `LossEstimator` + LLM | ⚠️ 需扩展 |
| | 群众安置 | 安置物资 | `SphereDemandCalculator` | ✅ 完整 |
| **四、次生灾害** | 监测预警 | 火灾/滑坡/余震 | `SecondaryHazardPredictor` | ✅ 完整 |
| | 防范措施 | 建议措施 | `SecondaryHazardPredictor.recommendations` | ✅ 完整 |
| **五、通信保障** | 设备调配 | 卫星电话/对讲机 | `SphereDemandCalculator` | ❌ 需新增 |
| | 民生通信 | 恢复计划 | `LossEstimator` + LLM | ✅ 完整 |
| **六、物资调配** | 战略物资 | WASH/FOOD/SHELTER等 | `SphereDemandCalculator` | ✅ 完整 |
| | 运输保障 | 路线/调度 | `VehicleRoutingPlanner` | ✅ 完整 |
| **七、自身保障** | 轮换休息 | 作业周期/休息时间 | `SphereDemandCalculator` | ❌ 需新增 |
| | 饮食保障 | 救援人员热食/饮水 | `SphereDemandCalculator` | ❌ 需新增 |
| | 防护装备 | 按任务类型配置 | `SphereDemandCalculator` | ❌ 需新增 |

### 6.2 需要补充的标准

#### P0优先级（必需）

**1. 通信设备配置标准（第五章）**

| 编码 | 名称 | 数量 | 单位 | 缩放基准 | 来源 |
|------|------|------|------|----------|------|
| COMM-001 | 卫星电话 | 1 | unit | 每救援队 | 国家地震应急预案 |
| COMM-002 | 数字对讲机 | 1 | unit | 每救援人员 | 国家地震应急预案 |
| COMM-003 | 便携中继台 | 1 | unit | 每指挥组 | 国家地震应急预案 |
| COMM-004 | 应急通信车 | 0.002 | unit | 每500受灾群众 | 国家地震应急预案 |

**2. 救援人员保障标准（第七章）**

| 编码 | 名称 | 数量 | 单位 | 说明 | 来源 |
|------|------|------|------|------|------|
| RES-001 | 救援人员饮水 | 5 | L/人/天 | Sphere的2倍（高强度） | 消防员健康标准 |
| RES-002 | 救援人员热食 | 3 | 餐/人/天 | 含能量补充 | 应急救援作业规范 |
| RES-003 | 轮换周期 | 8 | 小时 | 连续作业上限 | 消防员健康标准 |
| RES-004 | 休息时间 | 6 | 小时 | 每轮换后 | 消防员健康标准 |

#### P1优先级（建议）

**3. 医疗资源扩展标准（第三章）**

| 编码 | 名称 | 数量 | 单位 | 缩放基准 | 来源 |
|------|------|------|------|----------|------|
| HEALTH-004 | 基础医疗点 | 0.0001 | unit | 每10000受灾群众 | WHO Emergency Standards |
| HEALTH-005 | 伤员床位 | 1.2 | unit | 每名重伤员×1.2 | WHO Emergency Standards |
| HEALTH-006 | 医护人员 | 0.3 | person | 每床位×0.3 | WHO Emergency Standards |

### 6.3 需要新增的ScalingBasis枚举

```python
class ScalingBasis(str, Enum):
    PER_PERSON = "per_person"           # 每名受灾群众
    PER_DISPLACED = "per_displaced"     # 每名转移安置人员
    PER_CASUALTY = "per_casualty"       # 每名伤员
    PER_TRAPPED = "per_trapped"         # 每名被困人员
    PER_AREA_KM2 = "per_area_km2"       # 每平方公里
    PER_TEAM = "per_team"               # 每支救援队伍
    PER_RESCUER = "per_rescuer"         # 🆕 每名救援人员
    PER_COMMAND_GROUP = "per_command_group"  # 🆕 每个指挥组
    PER_BED = "per_bed"                 # 🆕 每张床位
    FIXED = "fixed"                     # 固定数量
```

### 6.4 验证结论

| 验证项 | 结果 |
|--------|------|
| 现有算法覆盖率 | ~85% |
| 缺失类型 | 配置标准数据（非算法逻辑）|
| 是否需要MetaGPT | ❌ 不需要 |
| 补充工作量 | P0: 2-4小时, P1: 4-8小时 |

---

## 七、总结

### 7.1 核心决策

**不需要用MetaGPT替代现有算法库。**

原因：
1. 现有算法库已经覆盖所有核心计算需求
2. 涉及人命的数字需要确定性、可追溯、可审计
3. MetaGPT的优势（动态代码生成）在这个场景下是风险而非优势
4. Sphere标准是固定公式，不需要"创造性"计算

### 7.2 正确的分工

- **算法库**：负责所有数值计算（确定性）
- **LLM**：负责文本综合和格式化（叙事性）
- **LangGraph**：负责流程编排和HITL审批
- **Jinja2模板**：负责最终文档生成

### 7.3 行动建议

1. ✅ 继续使用现有架构
2. ✅ 实现并发执行优化
3. ✅ 完善LLM的叙事生成（使用instructor）
4. ❌ 不启动独立的MetaGPT项目
5. ⚠️ 保留未来扩展的可能性
6. 🆕 **补充P0标准**：通信设备 + 救援人员保障（2-4小时）
7. 🆕 **补充P1标准**：医疗资源扩展（4-8小时）
