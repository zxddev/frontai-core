# 移动仿真系统

> 版本: 1.0  
> 创建时间: 2025-11-27

---

## 一、模块概述

移动仿真系统提供车辆、无人设备（无人机/机器狗/无人艇）、救援队伍的路径移动仿真能力。

**核心功能：**
- 单实体移动仿真
- 批量移动（编队）
- 暂停/恢复/取消控制
- 任务停靠点执行
- 实时位置推送

---

## 二、模块结构

```
src/domains/movement_simulation/
├── __init__.py           # 模块入口
├── schemas.py            # Pydantic数据模型
├── service.py            # MovementSimulationManager核心服务
├── batch_service.py      # 批量移动服务
├── interpolator.py       # 路径插值算法
├── speed_resolver.py     # 速度获取
├── persistence.py        # Redis状态持久化
└── router.py             # FastAPI路由
```

---

## 三、API接口

### 3.1 单实体移动

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v2/movement/start` | 启动移动 |
| POST | `/api/v2/movement/{session_id}/pause` | 暂停 |
| POST | `/api/v2/movement/{session_id}/resume` | 恢复 |
| POST | `/api/v2/movement/{session_id}/cancel` | 取消 |
| GET | `/api/v2/movement/{session_id}/status` | 状态查询 |
| GET | `/api/v2/movement/active` | 活跃会话列表 |

### 3.2 批量移动

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v2/movement/batch/start` | 启动批量移动 |
| POST | `/api/v2/movement/batch/{batch_id}/pause` | 批量暂停 |
| POST | `/api/v2/movement/batch/{batch_id}/resume` | 批量恢复 |
| POST | `/api/v2/movement/batch/{batch_id}/cancel` | 批量取消 |
| GET | `/api/v2/movement/batch/{batch_id}/status` | 批量状态 |

---

## 四、使用示例

### 4.1 启动单实体移动

```python
POST /api/v2/movement/start
{
    "entity_id": "550e8400-e29b-41d4-a716-446655440000",
    "entity_type": "vehicle",
    "resource_id": "550e8400-e29b-41d4-a716-446655440001",
    "route": [
        [103.85, 31.68],
        [103.86, 31.69],
        [103.87, 31.70]
    ],
    "waypoints": [
        {
            "point_index": 1,
            "task_type": "rescue",
            "task_duration_s": 300,
            "task_data": {"target_count": 3}
        }
    ]
}
```

**响应：**
```json
{
    "session_id": "abc123",
    "entity_id": "550e8400-e29b-41d4-a716-446655440000",
    "state": "moving",
    "total_distance_m": 2500.5,
    "estimated_duration_s": 150.3,
    "speed_mps": 16.67
}
```

### 4.2 启动批量移动（编队）

```python
POST /api/v2/movement/batch/start
{
    "movements": [
        {"entity_id": "uuid1", "entity_type": "vehicle", "resource_id": "v1"},
        {"entity_id": "uuid2", "entity_type": "uav", "resource_id": "d1"},
        {"entity_id": "uuid3", "entity_type": "team", "resource_id": "t1"}
    ],
    "shared_route": [[103.85, 31.68], [103.86, 31.69], [103.87, 31.70]],
    "formation": "convoy",
    "interval_s": 10.0
}
```

---

## 五、核心流程

### 5.1 移动仿真流程

```
启动请求 → 验证实体 → 获取速度 → 创建会话 → 启动后台任务
                                           ↓
                                    [位置更新循环]
                                           ↓
                              计算位置 → 检查停靠点 → 广播位置
                                           ↓
                                    完成/取消 → 清理
```

### 5.2 位置计算算法

使用 `RouteInterpolator` 进行路径插值：

1. 计算各路段距离（Haversine公式）
2. 根据行驶时间和速度计算已行驶距离
3. 定位当前所在路段
4. 线性插值计算精确坐标
5. 计算朝向角度

---

## 六、速度获取规则

| 实体类型 | 速度来源 | 默认值 |
|---------|---------|--------|
| vehicle | `Vehicle.max_speed_kmh` | 60 km/h |
| team | `Team.properties.speed_kmh` | 5 km/h |
| uav | `Device.properties.max_speed_kmh` | 50 km/h |
| robotic_dog | `Device.properties.max_speed_kmh` | 10 km/h |
| usv | `Device.properties.max_speed_kmh` | 30 km/h |

---

## 七、WebSocket事件

位置更新通过现有 `/topic/realtime.location` 推送：

```json
{
    "payload": {
        "id": "entity-uuid",
        "type": "vehicle",
        "location": {"longitude": 103.86, "latitude": 31.69},
        "speed_kmh": 60,
        "heading": 45
    }
}
```

移动状态事件通过 `/topic/movement.*` 推送：

| Topic | 说明 |
|-------|------|
| `/topic/movement.started` | 移动开始 |
| `/topic/movement.paused` | 移动暂停 |
| `/topic/movement.resumed` | 移动恢复 |
| `/topic/movement.completed` | 移动完成 |
| `/topic/movement.cancelled` | 移动取消 |
| `/topic/movement.waypoint_reached` | 到达任务点 |

---

## 八、状态持久化

使用Redis存储移动会话状态，支持应用重启后恢复：

```
Key: movement:session:{session_id}
Value: JSON(MovementSession)
TTL: 24小时

Key: movement:active
Value: SET[session_id, ...]

Key: movement:entity:{entity_id}
Value: session_id
```

---

## 九、错误码

| 错误码 | HTTP状态 | 说明 |
|--------|---------|------|
| MV4001 | 409 | 实体已有活跃移动会话 |
| MV4002 | 400 | 路径无效（少于2个点） |
| MV4003 | 409 | 只能暂停移动中的会话 |
| MV4004 | 409 | 只能恢复暂停的会话 |
| MV4005 | 409 | 会话已结束 |
| MV4010 | 400 | 批量移动至少需要1个实体 |
