# 灾害-想定-事件关联机制

## 概述

本文档描述应急救援系统中灾害(Disaster)、想定(Scenario)、事件(Event)三层概念的关系和业务逻辑。

## 核心概念

### 层级关系

```
想定(Scenario) ─ 应急响应顶层容器
    │
    ├── 灾害态势(Disaster) ─ 危险区域/预警信息
    │   ├── 触发型：severity>=3, needs_response=true → 自动创建事件
    │   └── 预警型：needs_response=false → 仅通知，不创建事件
    │
    ├── 事件(Event) ─ 具体救援任务（街道级/点位级）
    │   └── 关联灾害（disaster_id）
    │
    └── 预警(Warning) ─ 通知机制
        └── 关联灾害
```

### 概念定义

| 概念 | 想定 Scenario | 灾害 Disaster | 事件 Event |
|------|--------------|---------------|------------|
| **级别** | 战略级 | 态势级 | 战术级 |
| **范围** | 整个应急响应 | 区域/危险范围 | 具体点位 |
| **作用** | 统一指挥框架 | 态势感知+预警 | 触发救援任务 |
| **来源** | 人工创建 | 第三方系统/传感器 | 人工上报/系统推断 |
| **示例** | 茂县地震响应 | 山火蔓延区域 | A村有3人被困 |

## 灾害分类

### 触发型灾害（needs_response=true）

需要启动救援响应的灾害：
- 地震影响区域
- 山火蔓延范围
- 洪水淹没区
- 化学品泄漏区

**处理逻辑**：
1. 创建灾害记录
2. 关联到想定
3. 自动创建事件（severity>=3时）
4. 创建地图实体（danger_zone）
5. 生成预警通知

### 预警型灾害（needs_response=false）

仅用于通知和态势感知的灾害：
- 天气预警（暴雨、大风）
- 地质风险预警（滑坡风险区）
- 交通管制通知

**处理逻辑**：
1. 创建灾害记录
2. 关联到想定
3. **不创建事件**
4. 生成预警通知给相关队伍

## 数据流程

### 第三方灾情推送流程

```
POST /api/v2/ai/early-warning/disasters/update
    │
    ├─① 关联想定
    │   ├── 有 scenario_id → 直接关联
    │   └── 无 scenario_id → 自动查找活动想定
    │
    ├─② 创建 disaster_situations 记录
    │
    ├─③ 判断是否创建事件
    │   ├── needs_response=true && severity>=3 → 创建事件
    │   └── 否则 → 跳过
    │
    ├─④ 创建 map_entity (danger_zone)
    │   └── WebSocket推送 /topic/map.entity.create
    │
    ├─⑤ 查询范围内队伍，创建 warning_records
    │
    ├─⑥ WebSocket推送灾害通知
    │   └── /topic/scenario.disaster.triggered
    │
    └─⑦ 返回响应
```

### 预警响应流程

```
前端收到预警推送
    │
    ├─ 用户点击"确认收到"
    │   └── POST /warnings/{id}/acknowledge
    │
    ├─ 用户选择响应方式
    │   ├── "继续前进" → POST /warnings/{id}/respond {action: "continue"}
    │   ├── "申请绕行" → GET /warnings/{id}/detour-options
    │   │                  └── POST /warnings/{id}/confirm-detour
    │   └── "原地待命" → POST /warnings/{id}/respond {action: "standby"}
    │
    └─ 预警状态更新为 resolved
```

## 数据模型

### disaster_situations 表

```sql
CREATE TABLE operational_v2.disaster_situations (
    id UUID PRIMARY KEY,
    scenario_id UUID,                    -- 关联想定
    disaster_type VARCHAR(50) NOT NULL,  -- fire/flood/chemical/landslide/earthquake
    disaster_name VARCHAR(200),
    boundary GEOMETRY(POLYGON, 4326),    -- 灾害范围多边形
    center_point GEOMETRY(POINT, 4326),  -- 中心点
    buffer_distance_m INTEGER DEFAULT 3000,
    severity_level INTEGER DEFAULT 3,    -- 1-5级
    needs_response BOOLEAN DEFAULT true, -- 是否需要救援响应
    linked_event_id UUID,                -- 关联事件
    map_entity_id UUID,                  -- 关联地图实体
    status VARCHAR(20) DEFAULT 'active',
    source VARCHAR(100),                 -- 数据来源
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### warning_records 表

```sql
CREATE TABLE operational_v2.warning_records (
    id UUID PRIMARY KEY,
    disaster_id UUID REFERENCES disaster_situations(id),
    scenario_id UUID,
    
    -- 受影响对象
    affected_type VARCHAR(20),  -- vehicle/team
    affected_id UUID,
    affected_name VARCHAR(200),
    
    -- 预警信息
    warning_level VARCHAR(10),  -- red/orange/yellow/blue
    distance_m NUMERIC(10,2),
    estimated_contact_minutes INTEGER,
    
    -- 状态
    status VARCHAR(20) DEFAULT 'pending',  -- pending/acknowledged/responded/resolved
    response_action VARCHAR(20),           -- continue/detour/standby
    
    -- 时间戳
    created_at TIMESTAMP,
    acknowledged_at TIMESTAMP,
    responded_at TIMESTAMP,
    resolved_at TIMESTAMP
);
```

## 预警级别

| 级别 | 颜色 | 距离 | 含义 |
|------|------|------|------|
| red | 红色 | <1km | 紧急危险，需立即响应 |
| orange | 橙色 | 1-3km | 高度危险，建议绕行 |
| yellow | 黄色 | 3-5km | 中度风险，注意警惕 |
| blue | 蓝色 | >5km | 一般提示，知晓即可 |

## API接口

### 灾害更新

```
POST /api/v2/ai/early-warning/disasters/update
```

请求体：
```json
{
  "scenario_id": "uuid",           // 可选，不指定则自动查找
  "disaster_type": "fire",         // fire/flood/chemical/landslide/earthquake
  "disaster_name": "茂县森林火灾",
  "boundary": {
    "type": "Polygon",
    "coordinates": [[[lon, lat], ...]]
  },
  "buffer_distance_m": 5000,
  "severity_level": 4,
  "source": "weather_service",
  "needs_response": true           // true=触发型, false=预警型
}
```

响应：
```json
{
  "disaster_id": "uuid",
  "scenario_id": "uuid",           // 关联的想定
  "linked_event_id": "uuid",       // 关联的事件（如有）
  "map_entity_id": "uuid",         // 关联的地图实体（如有）
  "warnings_generated": 17,
  "affected_teams": 17,
  "message": "已发送17条预警通知",
  "scenario_warning": null         // 想定关联警告（如有）
}
```

### 预警查询

```
GET /api/v2/ai/early-warning/warnings?scenario_id=xxx&status=pending
```

### 预警确认

```
POST /api/v2/ai/early-warning/warnings/{id}/acknowledge
```

### 预警响应

```
POST /api/v2/ai/early-warning/warnings/{id}/respond
{
  "action": "continue",  // continue/detour/standby
  "reason": "已确认安全"
}
```

## WebSocket通知

### 灾害触发通知

Topic: `/topic/scenario.disaster.triggered`

```json
{
  "disaster_id": "uuid",
  "disaster_type": "fire",
  "disaster_name": "茂县森林火灾",
  "scenario_id": "uuid",
  "severity_level": 4,
  "center": {"lon": 103.85, "lat": 31.68},
  "warnings_count": 17,
  "needs_response": true
}
```

### 地图实体创建通知

Topic: `/topic/map.entity.create`

```json
{
  "entity_id": "uuid",
  "type": "danger_zone",
  "layer_code": "layer.danger",
  "geometry": {...}
}
```

## 设计原则

### Human in the Loop

- 预警系统**不自动执行**任何操作
- 所有响应决策由人工确认
- 系统仅提供信息和选项

### 分级响应

- 低级别预警：仅通知，不强制响应
- 高级别预警：持续提醒直到确认
- 紧急预警：多渠道通知

### 数据一致性

- 灾害记录与想定关联确保统一指挥
- 事件记录与灾害关联确保溯源
- 预警记录完整追踪响应过程
