# 仿真推演系统

> 版本: 1.1  
> 更新时间: 2025-11-27

---

## 一、模块概述

仿真推演系统提供演练和培训场景的模拟能力，支持仿真场景管理、时间控制、事件注入、演练评估等功能。

**核心架构：**
- **真实数据仿真**：仿真期间直接操作真实业务表（events, tasks, entities等）
- **事务快照还原**：仿真启动时创建 PostgreSQL SAVEPOINT，结束后 ROLLBACK 还原
- **事件注入**：直接调用真实的 EventService 创建事件

**核心功能：**
- 仿真场景创建与管理
- 仿真生命周期控制（启动/暂停/恢复/停止）
- 时间倍率调整（0.5x - 10x）
- 事件注入（预设/即时）
- 演练评估报告生成

---

## 二、架构设计

### 2.1 真实数据 + 快照还原

```
仿真启动 → 创建数据库 SAVEPOINT
    ↓
仿真过程中：直接操作真实表（events_v2, tasks_v2, entities_v2...）
    ↓
仿真结束 → ROLLBACK TO SAVEPOINT（还原所有数据）
```

**优点：**
- 仿真使用真实业务逻辑，测试更真实
- 不需要维护额外的仿真数据表
- 数据一致性由数据库事务保证

### 2.2 数据库表（最小化）

| 表 | 用途 |
|---|---|
| `simulation_scenarios_v2` | 仿真元数据（名称、状态、时间倍率、参与者等）|
| `drill_assessments_v2` | 评估报告（需要永久保存）|

**注意**：没有专门的注入事件表，事件注入直接写入真实的 `events_v2` 表。

---

## 三、模块结构

```
src/domains/simulation/
├── __init__.py       # 模块入口
├── schemas.py        # Pydantic数据模型
├── models.py         # ORM模型（SimulationScenario, DrillAssessment）
├── clock.py          # 仿真时钟
├── service.py        # SimulationService服务
└── router.py         # FastAPI路由
```

---

## 四、API接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v2/simulations` | 创建仿真场景 |
| GET | `/api/v2/simulations` | 场景列表 |
| GET | `/api/v2/simulations/{id}` | 场景详情 |
| POST | `/api/v2/simulations/{id}/start` | 启动仿真（创建SAVEPOINT）|
| POST | `/api/v2/simulations/{id}/pause` | 暂停仿真 |
| POST | `/api/v2/simulations/{id}/resume` | 恢复仿真 |
| POST | `/api/v2/simulations/{id}/stop` | 停止仿真（ROLLBACK还原）|
| PATCH | `/api/v2/simulations/{id}/time-scale` | 调整时间倍率 |
| POST | `/api/v2/simulations/{id}/inject` | 注入事件（调用真实EventService）|
| GET | `/api/v2/simulations/{id}/inject-queue` | 注入队列 |
| POST | `/api/v2/simulations/{id}/assessment` | 生成评估 |
| GET | `/api/v2/simulations/{id}/assessment` | 获取评估 |

---

## 五、使用示例

### 5.1 创建仿真场景

```python
POST /api/v2/simulations
{
    "name": "茂县地震救援演练",
    "scenario_id": "scenario-uuid",
    "source_type": "new",
    "time_scale": 2.0,
    "participants": [
        {"user_id": "user-001", "role": "指挥员"},
        {"user_id": "user-002", "role": "调度员"}
    ],
    "inject_events": [
        {
            "relative_time_min": 30,
            "event_template": {
                "title": "次生滑坡",
                "event_type": "landslide",
                "priority": "high"
            }
        }
    ]
}
```

### 5.2 启动仿真

```python
POST /api/v2/simulations/{id}/start

# 内部操作：
# 1. 创建 SAVEPOINT sim_xxx_timestamp
# 2. 启动仿真时钟
# 3. 启动事件注入调度器

Response:
{
    "id": "simulation-uuid",
    "status": "running",
    "current_simulation_time": "2025-11-27T14:30:00Z",
    "time_scale": 2.0
}
```

### 5.3 注入事件

```python
POST /api/v2/simulations/{id}/inject
{
    "event": {
        "title": "紧急：余震发生",
        "event_type": "landslide",
        "location": {"longitude": 103.85, "latitude": 31.68},
        "priority": "critical",
        "estimated_victims": 5
    }
}

# 内部操作：
# 1. 调用 EventService.create() 创建真实事件
# 2. 事件写入 events_v2 表
# 3. 广播 WebSocket 通知

Response:
{
    "event_id": "event-uuid",
    "message": "事件注入成功"
}
```

### 5.4 停止仿真（还原数据）

```python
POST /api/v2/simulations/{id}/stop?rollback=true

# 内部操作：
# 1. ROLLBACK TO SAVEPOINT sim_xxx_timestamp
# 2. RELEASE SAVEPOINT
# 3. 仿真期间创建的事件、任务等全部被还原

Response:
{
    "id": "simulation-uuid",
    "status": "stopped",
    "completed_at": "2025-11-27T15:30:00Z"
}
```

**参数说明：**
- `rollback=true`（默认）：回滚仿真期间的所有数据变更
- `rollback=false`：保留仿真期间的数据（用于将仿真数据转为正式数据）

---

## 六、仿真时钟

`SimulationClock` 管理仿真时间与真实时间的映射：

```python
clock = SimulationClock(
    simulation_start=datetime(2025, 11, 27, 8, 0),
    time_scale=2.0
)
clock.start()

# 真实过了5分钟，仿真时间过了10分钟
current_sim_time = clock.current_simulation_time

# 暂停/恢复
clock.pause()
clock.resume()

# 调整倍率（自动保持时间连续）
clock.set_time_scale(4.0)
```

**时间倍率说明：**
- 1.0x = 实时
- 2.0x = 2倍速（真实1分钟 = 仿真2分钟）
- 0.5x = 慢放（真实1分钟 = 仿真30秒）

---

## 七、事件注入机制

### 7.1 预设注入

创建仿真时设置 `inject_events`，系统会在指定仿真时间自动注入。

预设注入存储在内存中（非数据库），仿真结束后自动清除。

### 7.2 即时注入

运行中通过 `/inject` API 立即注入事件，直接调用 `EventService.create()`。

### 7.3 注入调度

后台任务每5秒检查一次，将到期的预设注入事件自动注入。

---

## 八、评估报告

### 8.1 评估维度

| 维度 | 说明 |
|------|------|
| response_time | 响应时间得分 |
| decision_quality | 决策质量得分 |
| coordination | 协调配合得分 |
| resource_utilization | 资源利用得分 |

### 8.2 评估内容

```json
{
    "overall_score": 85.5,
    "grades": {
        "response_time": {"score": 90, "detail": "首批救援力量15分钟内到达"},
        "decision_quality": {"score": 82, "detail": "方案选择合理"},
        "coordination": {"score": 88, "detail": "多队伍协同良好"},
        "resource_utilization": {"score": 78, "detail": "部分资源未充分利用"}
    },
    "timeline_analysis": [...],
    "recommendations": ["建议增加后勤保障资源", "可优化搜救队伍调度顺序"]
}
```

---

## 九、WebSocket事件

| Topic | 说明 |
|-------|------|
| `/topic/simulation.started` | 仿真启动 |
| `/topic/simulation.paused` | 仿真暂停 |
| `/topic/simulation.stopped` | 仿真停止 |
| `/topic/simulation.event_injected` | 事件注入 |

---

## 十、错误码

| 错误码 | HTTP状态 | 说明 |
|--------|---------|------|
| SI4001 | 404 | 仿真场景不存在 |
| SI4002 | 409 | 仿真状态不允许此操作 |
| SI4003 | 400 | 无效的时间倍率 |

---

## 十一、注意事项

### 11.1 SAVEPOINT 限制

- SAVEPOINT 在长事务中有效，不要在仿真期间关闭数据库连接
- 建议仿真时长不超过24小时
- 大量数据变更可能影响回滚性能

### 11.2 并发仿真

- 每个仿真使用独立的 SAVEPOINT
- 多个仿真可以并行运行
- 注意资源占用和数据库连接池管理
