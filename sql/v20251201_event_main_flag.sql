-- ============================================================================
-- V20251201 为事件表添加主事件标识字段
-- 
-- 业务场景: 每个想定有一个主事件，想定激活时自动创建
-- 装备分配等业务通过主事件关联
-- ============================================================================

SET search_path TO operational_v2, public;

-- ============================================================================
-- 添加 is_main_event 字段
-- ============================================================================
ALTER TABLE operational_v2.events_v2 
ADD COLUMN IF NOT EXISTS is_main_event BOOLEAN DEFAULT FALSE;

-- ============================================================================
-- 创建唯一索引：每个想定只能有一个主事件
-- ============================================================================
CREATE UNIQUE INDEX IF NOT EXISTS idx_events_v2_main_per_scenario 
ON operational_v2.events_v2(scenario_id) WHERE is_main_event = TRUE;

-- ============================================================================
-- 添加字段注释
-- ============================================================================
COMMENT ON COLUMN operational_v2.events_v2.is_main_event 
IS '是否为想定主事件（每个想定只有一个，想定激活时自动创建）';

-- ============================================================================
-- 添加 departed 状态到装备准备调度枚举
-- ============================================================================
DO $$ BEGIN
    ALTER TYPE operational_v2.preparation_dispatch_status ADD VALUE IF NOT EXISTS 'departed';
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;

-- ============================================================================
-- 完成
-- ============================================================================
SELECT 'V20251201 Event main flag migration completed!' AS result;
