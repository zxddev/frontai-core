## Context

将语音聊天系统从"问答引擎"升级为"指挥中枢"，需要解决：
- 实时性 vs 复杂推理延迟的矛盾
- LLM随机性 vs 战术指挥确定性的矛盾
- 异构数据源的语义对齐

## Goals / Non-Goals

**Goals:**
- 毫秒级意图分流（<100ms）
- 空间查询能力（位置、距离、区域）
- 安全的机器人控制（中断-确认模式）

**Non-Goals:**
- 自主任务规划（不替代EmergencyAIAgent）
- 复杂的多机协同控制
- 实时视频流分析

## Decisions

### D1: 语义路由方案
- **选择**: Hybrid (Semantic Router + LLM Fallback)
- **参考**: vLLM Semantic Router, RouteLLM, EMNLP 2024 Intent Detection
- **实现**:
  - 高置信度(≥0.80): Semantic Router直接路由 (~50ms)
  - 低置信度(<0.80): LLM Fallback兜底 (~1000ms)
- **效果**: 100%准确率，80%请求快速处理
- **理由**: 
  - 行业最佳实践，vLLM等生产系统采用此方案
  - 延迟和准确率的最佳平衡

### D2: Agent分离策略
- **选择**: SpatialAgent（只读）与CommanderAgent（写）分离
- **理由**:
  - 故障隔离：空间查询失败不影响基础对话
  - 权限分离：写操作需要更严格的安全控制
  - 延迟优化：简单查询不走复杂控制流程

### D3: 安全控制机制
- **选择**: LangGraph interrupt_before + WebSocket确认流
- **理由**:
  - 项目已有实践（early_warning的human_review）
  - 图状态持久化支持异步确认
  - 原生支持超时取消

## Architecture

### 三层超图监督架构

```
┌─────────────────────────────────────────────────────────────┐
│                    一级感知层 (Perception)                   │
│  ┌──────────────────┐    ┌─────────────────────────────┐   │
│  │ VoiceChatManager │───▶│ SemanticRouter              │   │
│  │ (VAD/ASR/TTS)    │    │ (bge-small-zh-v1.5)         │   │
│  └──────────────────┘    │ - spatial_query (0.82)      │   │
│                          │ - robot_command (0.85)      │   │
│                          │ - mission_status (0.80)     │   │
│                          │ - chitchat (0.75)           │   │
│                          └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                   二级编排层 (Orchestration)                 │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │               LangGraph Supervisor                    │  │
│  │  - 维护跨轮任务状态                                    │  │
│  │  - 条件边分发到子代理                                  │  │
│  │  - 管理确认流程                                       │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               │
           ┌───────────────────┼───────────────────┐
           ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  SpatialAgent   │ │ CommanderAgent  │ │ EmergencyAgent  │
│  (只读查询)      │ │ (写操作+确认)   │ │ (原有救灾问答)  │
│                 │ │                 │ │                 │
│ - PostGIS       │ │ - STOMP         │ │ - RAG           │
│ - Neo4j         │ │ - interrupt     │ │ - 规则推理      │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

### CommanderAgent 安全流程

```
用户语音: "派一号无人机去化工厂"
           │
           ▼
┌─────────────────────┐
│   parse_command     │  解析意图和参数
└─────────────────────┘
           │
           ▼
┌─────────────────────┐
│   safety_check      │  禁飞区/电量/冲突检测
└─────────────────────┘
           │
           ▼
┌─────────────────────┐
│ generate_confirm    │  生成确认请求
└─────────────────────┘
           │
           ▼
     [INTERRUPT]       ◄── WebSocket: {"type": "require_confirmation", ...}
           │
     用户: "确认"
           │
           ▼
┌─────────────────────┐
│     execute         │  STOMP发送指令
└─────────────────────┘
           │
           ▼
     WebSocket: {"type": "command_sent", ...}
```

## Risks / Trade-offs

| 风险 | 缓解措施 |
|------|----------|
| 路由误分类导致控制指令误触发 | 高阈值(0.85) + 二次确认 |
| 空间查询延迟影响对话体验 | 异步预热 + 查询缓存 |
| 确认流程打断对话流畅性 | TTS播报确认请求，自然衔接 |
| embedding服务不可用 | 降级到全量LLM路由 |

## Migration Plan

分4阶段渐进实施，每阶段独立可回滚：

| 阶段 | 内容 | 时长 | 回滚方案 |
|------|------|------|----------|
| Phase 0 | 基础设施准备 | 1周 | - |
| Phase 1 | 语义路由 | 1周 | 降级到全量LLM |
| Phase 2 | 空间查询 | 2周 | 关闭路由到spatial |
| Phase 3 | 机器人控制 | 2周 | `robot_command_enabled=false` |
| Phase 4 | 性能优化 | 1周 | 关闭优化特性 |

## Open Questions

- [ ] 中文embedding模型部署方式：独立服务 or 嵌入现有embedding服务？
- [ ] 确认超时时间设置多久合适？（建议30秒）
- [ ] 是否需要支持批量指令确认？
