# Design: 第三方数据接入模块

## Context

应急救灾系统需要接收多种外部数据源：
1. 110/119/120报警系统的灾情上报
2. IoT传感器（地震仪、水位计、烟雾报警器）的告警数据
3. 无人设备（无人机、机器狗）的实时遥测
4. 气象部门的天气数据和预警

这些数据具有高频、异构、需去重的特点。

## Goals / Non-Goals

### Goals
- 提供统一的第三方数据接入接口
- 支持API密钥认证（非JWT，适用于系统间对接）
- 实现灾情去重逻辑避免重复创建事件
- 遥测数据高效入库并触发WebSocket推送
- 强类型定义，所有接口使用Pydantic v2

### Non-Goals
- 暂不实现签名验证（可选功能，后期添加）
- 暂不实现IP白名单（运维层面配置）
- 暂不实现请求频率限制（中间件层面处理）
- 暂不开发回调通知接口（优先级低）

## Decisions

### 1. API认证方案：静态API密钥

**决策**: 使用 `X-Api-Key` Header认证，非JWT

**理由**:
- 第三方系统对接通常是机器对机器（M2M）
- 静态密钥简单可靠，适合传感器/设备推送
- 密钥存储在 `api_keys_v2` 表，支持多租户

**替代方案**: OAuth2 Client Credentials
- 过于复杂，传感器设备难以实现

### 2. 灾情去重策略

**决策**: 两级去重
1. 来源去重：`source_system + source_event_id` 唯一
2. 时空去重：100米内 + 1小时内 + 相同灾情类型

**理由**:
- 来源去重处理同一系统重复提交
- 时空去重处理多系统上报同一灾情

### 3. 遥测数据处理

**决策**: 批量接收 + 异步写入

**流程**:
```
接收遥测 → 校验格式 → 批量更新entities位置 → 写入tracks表 → WebSocket推送
```

**理由**:
- 无人机遥测频率高（1-5Hz），需批量处理
- 位置更新是热点操作，需优化

### 4. 模块结构

```
src/domains/integrations/
├── __init__.py
├── router.py           # 5个接入接口
├── service.py          # 业务逻辑
├── schemas.py          # Pydantic模型
├── dependencies.py     # API密钥认证依赖
└── deduplication.py    # 去重策略
```

## Risks / Trade-offs

| 风险 | 缓解措施 |
|-----|---------|
| 遥测数据量大导致数据库压力 | 批量写入 + 后续可加Redis缓存 |
| API密钥泄露 | 支持密钥轮换 + 操作日志审计 |
| 去重误判（不同灾情被合并） | 时空阈值可配置 + 人工复核机制 |

## Migration Plan

1. 执行SQL创建 `api_keys_v2` 表
2. 部署新模块，不影响现有接口
3. 为测试环境生成API密钥
4. 验证各接口功能
5. 正式环境为接入方分配密钥

## Open Questions

1. 是否需要支持批量灾情上报？（当前设计为单条）
2. 天气数据写入表已定义但无对应ORM模型，是否在本次实现？
