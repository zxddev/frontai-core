## ADDED Requirements

### Requirement: 灾害态势数据接入
系统 SHALL 提供接口接收第三方灾情数据更新，包括灾害范围（多边形）、灾害类型、严重程度等信息。

#### Scenario: 接收火灾范围更新
- **WHEN** 第三方接口推送火灾范围变化数据
- **THEN** 系统存储新的灾害范围
- **AND** 触发影响分析流程

#### Scenario: 接收洪水范围更新
- **WHEN** 第三方接口推送洪水淹没范围数据
- **THEN** 系统存储新的灾害范围
- **AND** 触发影响分析流程

---

### Requirement: 车辆位置影响检测
系统 SHALL 检测对内车辆和救援队伍车辆是否在灾害预警范围（默认3km）内。

#### Scenario: 对内车辆进入预警范围
- **WHEN** 对内车辆当前位置距灾害边界小于3km
- **THEN** 系统识别该车辆为受影响对象
- **AND** 计算预计接触危险区域的时间

#### Scenario: 救援队伍车辆进入预警范围
- **WHEN** 救援队伍车辆当前位置距灾害边界小于3km
- **THEN** 系统识别该车辆为受影响对象
- **AND** 计算预计接触危险区域的时间

---

### Requirement: 路径穿越检测
系统 SHALL 检测车辆规划路径是否穿过灾害范围或预警缓冲区。

#### Scenario: 路径穿过灾害范围
- **WHEN** 车辆规划路径与灾害范围多边形相交
- **THEN** 系统标记该路径受影响
- **AND** 计算路径穿越点距当前位置的距离和预计到达时间

#### Scenario: 路径穿过预警缓冲区
- **WHEN** 车辆规划路径与灾害3km缓冲区相交但不穿过核心区
- **THEN** 系统标记该路径为低风险受影响
- **AND** 生成风险提示

---

### Requirement: 预警消息生成与推送
系统 SHALL 生成包含危险信息和操作选项的预警消息，通过WebSocket推送到前端。

#### Scenario: 推送预警给指挥员（对内车辆）
- **WHEN** 对内车辆受灾害影响
- **THEN** 系统通过alerts频道推送预警消息给指挥员
- **AND** 消息包含：车辆信息、危险距离、预计接触时间、操作按钮（申请绕行/继续前进/原地待命）

#### Scenario: 推送预警给救援队伍负责人
- **WHEN** 救援队伍车辆受灾害影响
- **THEN** 系统通过alerts频道推送预警消息给该队伍负责人
- **AND** 消息包含：队伍信息、车辆信息、危险距离、预计接触时间、操作按钮

---

### Requirement: 预警响应处理
系统 SHALL 接收并处理用户对预警的响应，支持申请绕行、继续前进、原地待命三种响应。

#### Scenario: 用户选择继续前进
- **WHEN** 用户点击"继续前进"并确认风险
- **THEN** 系统记录用户响应为"continue"
- **AND** 更新预警状态为"已响应"

#### Scenario: 用户选择原地待命
- **WHEN** 用户点击"原地待命"
- **THEN** 系统记录用户响应为"standby"
- **AND** 更新预警状态为"已响应"

#### Scenario: 用户申请绕行
- **WHEN** 用户点击"申请绕行"
- **THEN** 系统调用路径规划智能体，传入灾害范围作为避开区域
- **AND** 返回多条备选绕行路线供用户选择

---

### Requirement: 绕行路线选择与确认
系统 SHALL 支持用户从备选绕行路线中选择并确认执行。

#### Scenario: 用户选择绕行路线
- **WHEN** 系统返回多条备选绕行路线
- **THEN** 用户可查看每条路线的距离、时间、风险等信息
- **AND** 用户可在地图上预览路线

#### Scenario: 用户确认绕行
- **WHEN** 用户选择一条绕行路线并点击"确认执行"
- **THEN** 系统更新该车辆/任务的规划路径
- **AND** 更新预警状态为"已解决"
- **AND** 记录绕行决策日志

---

### Requirement: 预警状态跟踪
系统 SHALL 跟踪预警从发出到解决的完整生命周期。

#### Scenario: 预警生命周期
- **WHEN** 预警发出
- **THEN** 状态为"pending"
- **WHEN** 用户确认收到
- **THEN** 状态变为"acknowledged"
- **WHEN** 用户提交响应（任意一种）
- **THEN** 状态变为"resolved"

#### Scenario: 灾害解除
- **WHEN** 灾害范围收缩或消除，车辆不再受影响
- **THEN** 相关未处理的预警自动标记为"cancelled"
